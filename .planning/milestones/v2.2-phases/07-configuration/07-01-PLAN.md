---
phase: 07-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/gsd-tools.cjs
  - get-shit-done/templates/config.json
  - commands/gsd/settings.md
autonomous: true

must_haves:
  truths:
    - "coplanner agents <checkpoint> returns checkpoint-specific agents when configured"
    - "coplanner agents <checkpoint> falls back to global agents list when no checkpoint override exists"
    - "coplanner agents <checkpoint> returns empty array with warning when enabled but no agents configured"
    - "coplanner agents <checkpoint> returns empty array when co_planners disabled (kill switch)"
    - "coplanner agents (no argument) returns global agents list, skipping checkpoint-specific resolution"
    - "Invalid agent names are filtered out with warnings, not errors"
    - "Unknown checkpoint names produce a warning and return empty agents"
    - "Config template includes agents array and checkpoints object in co_planners section"
    - "Settings command presents co-planner toggle, global agent selection, and per-checkpoint overrides"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.cjs"
      provides: "getAgentsForCheckpoint function, filterValidAgents helper, VALID_CHECKPOINTS constant, cmdCoplannerAgents command, updated CLI router"
      contains: "getAgentsForCheckpoint"
    - path: "get-shit-done/templates/config.json"
      provides: "Extended co_planners schema with agents and checkpoints"
      contains: "checkpoints"
    - path: "commands/gsd/settings.md"
      provides: "Co-planner settings questions with conditional flow"
      contains: "Co-Planner"
  key_links:
    - from: "getAgentsForCheckpoint()"
      to: "SUPPORTED_CLIS"
      via: "filterValidAgents validates agent names"
      pattern: "SUPPORTED_CLIS\\.includes"
    - from: "getAgentsForCheckpoint()"
      to: "checkKillSwitch()"
      via: "kill switch check before resolving agents"
      pattern: "checkKillSwitch"
    - from: "cmdCoplannerAgents()"
      to: "getAgentsForCheckpoint()"
      via: "command delegates to resolution function"
      pattern: "getAgentsForCheckpoint\\(cwd"
    - from: "CLI router 'agents' case"
      to: "cmdCoplannerAgents()"
      via: "coplanner subcommand routing"
      pattern: "case 'agents'"
---

<objective>
Add per-checkpoint agent configuration to co-planners: a resolution function with fallback chain (checkpoint-specific -> global -> empty), a `coplanner agents` CLI subcommand, config template schema extension, and settings command co-planner questions.

Purpose: Enable users to control which external agents (codex, gemini, opencode) participate at which workflow checkpoints (requirements, roadmap, plan, verification) via config.json. Phase 8 workflows will consume this configuration to invoke the right agents at the right checkpoints.

Output: Working `coplanner agents <checkpoint>` command, updated config template, extended settings command.
</objective>

<execution_context>
@/Users/zpyoung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zpyoung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-foundation/06-01-SUMMARY.md
@.planning/phases/06-foundation/06-02-SUMMARY.md
@.planning/phases/07-configuration/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getAgentsForCheckpoint function and coplanner agents subcommand to gsd-tools.cjs</name>
  <files>get-shit-done/bin/gsd-tools.cjs</files>
  <action>
Add these items to gsd-tools.cjs:

**1. VALID_CHECKPOINTS constant** (place immediately after SUPPORTED_CLIS on line 254):
```javascript
const VALID_CHECKPOINTS = ['requirements', 'roadmap', 'plan', 'verification'];
```

**2. getAgentsForCheckpoint(cwd, checkpointName) function** (place immediately after checkKillSwitch, around line 287):
- **Null/undefined handling:** If `checkpointName` is null or undefined, skip checkpoint validation and checkpoint-specific lookup -- go straight to global agents (step 2 of fallback chain). This is the "query global agents" path when no checkpoint argument is provided.
- **Invalid checkpoint handling:** If `checkpointName` is a non-null string NOT in VALID_CHECKPOINTS, return `{ agents: [], warnings: ['Unknown checkpoint "X". Valid: ...'] }`. This is a distinct code path from null -- it means the caller asked for a specific checkpoint that does not exist.
- Call checkKillSwitch(cwd). If not enabled, return `{ agents: [], warnings: [] }`.
- Read `.planning/config.json`, parse `co_planners` section.
- Fallback chain:
  1. **Only if checkpointName is non-null:** If `co_planners.checkpoints[checkpointName].agents` is a non-empty array, use it.
  2. Else if `co_planners.agents` is a non-empty array, use it.
  3. Else push warning "co_planners enabled but no agents configured", return empty.
- All agent names validated through filterValidAgents.
- On any error (file missing, JSON parse), return `{ agents: [], warnings: [] }`.

**3. filterValidAgents(agents, warnings) helper** (place immediately before getAgentsForCheckpoint):
- Iterate agents array. For each: if typeof string AND in SUPPORTED_CLIS, keep. Else push warning "Unknown agent 'X' skipped. Valid: codex, gemini, opencode".
- Return valid array.

**4. cmdCoplannerAgents(cwd, checkpointName, raw) function** (place immediately after the closing `}` of `cmdCoplannerEnabled` and BEFORE the `// --- CLI Router ---` comment that precedes `async function main()`; search for the exact anchor `function cmdCoplannerEnabled(cwd, raw) {` and insert the new function after its closing brace):
- Call getAgentsForCheckpoint(cwd, checkpointName).
- If raw: print agents comma-separated or "none (reason)" with newline.
- If not raw: output JSON result.
- Uses `output(result, raw, rawString)` -- same 3-arg pattern as `cmdCoplannerEnabled` and `cmdCoplannerInvoke`.

**5. CLI router extension** (in the coplanner switch block, after `case 'enabled':` and before `default:`):
- Add `case 'agents':` between `enabled` and `default`.
- Parse `args[2]` as checkpoint name. If `args[2]` is undefined (user ran `coplanner agents` with no argument), pass `null` to `cmdCoplannerAgents` -- this triggers the global-agents-only path (skips checkpoint lookup). If `args[2]` is a string, pass it as-is -- `getAgentsForCheckpoint` handles validation (valid checkpoint = resolve; invalid = warning + empty).
- Call `cmdCoplannerAgents(cwd, checkpoint, raw)`.
- Update default error message to include 'agents' in the list: `'Use: detect, invoke, enabled, agents'`.

Follow existing code style exactly (no arrow functions, string concatenation with +, same indentation).
  </action>
  <verify>
Run these commands from the project root:
```bash
# Test valid checkpoint (should return empty agents -- co_planners disabled in default config)
node get-shit-done/bin/gsd-tools.cjs coplanner agents plan

# Test with --raw flag (should print "none")
node get-shit-done/bin/gsd-tools.cjs coplanner agents plan --raw

# Test unknown checkpoint (should return empty agents + warning containing "Unknown checkpoint")
node get-shit-done/bin/gsd-tools.cjs coplanner agents unknown

# Test no checkpoint argument (null path -- should return empty agents, no warning about unknown checkpoint)
node get-shit-done/bin/gsd-tools.cjs coplanner agents
```
All commands must exit 0 (no process crash). Verify:
- `coplanner agents plan` output has `"agents": []` (disabled)
- `coplanner agents unknown` output has `"warnings"` containing "Unknown checkpoint"
- `coplanner agents` (no arg) output has `"agents": []` and does NOT have "Unknown checkpoint" in warnings (null = global query, not an invalid checkpoint)
  </verify>
  <done>
`coplanner agents` subcommand works. Returns JSON with `agents` array and `warnings` array. Implements full fallback chain: checkpoint-specific -> global -> empty. Kill switch respected. Invalid names filtered with warnings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend config template with agents and checkpoints schema</name>
  <files>get-shit-done/templates/config.json</files>
  <action>
Update the `co_planners` section in `get-shit-done/templates/config.json` from:
```json
"co_planners": {
  "enabled": false,
  "timeout_ms": 120000
}
```
To:
```json
"co_planners": {
  "enabled": false,
  "timeout_ms": 120000,
  "agents": [],
  "checkpoints": {}
}
```

Key design decisions (per CONTEXT.md locked decisions):
- `agents: []` (empty array) -- double opt-in: users must both enable AND add agents.
- `checkpoints: {}` (empty object) -- no per-checkpoint overrides by default. Users add as needed.
- Do NOT populate checkpoints with all four entries. Empty object means "use global agents everywhere."
- Existing fields (`enabled`, `timeout_ms`) unchanged.
  </action>
  <verify>
```bash
# Verify valid JSON
node -e "const c = JSON.parse(require('fs').readFileSync('get-shit-done/templates/config.json', 'utf-8')); console.log(JSON.stringify(c.co_planners, null, 2))"
```
Should output the co_planners section with all four fields: enabled, timeout_ms, agents, checkpoints.
  </verify>
  <done>
Config template has `agents` (empty array) and `checkpoints` (empty object) in co_planners section. New projects get the full schema. Backward compatible -- existing configs without these fields continue working via getAgentsForCheckpoint fallback chain.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add co-planner settings to the settings command</name>
  <files>commands/gsd/settings.md</files>
  <action>
Extend `commands/gsd/settings.md` to add co-planner configuration questions after the existing adversary settings section.

**1. Update "Read Current Config" section (step 2)** -- add these parsed values:
- `co_planners.enabled` -- currently enabled or not
- `co_planners.agents` -- currently configured global agents
- `co_planners.checkpoints` -- any per-checkpoint overrides

**2. Add co-planner questions to the AskUserQuestion block (step 3)** -- after the adversary max_rounds question, add:

```
// ── Co-Planner Settings ──
// ONLY show these if co_planners is supported (always show toggle)

{
  question: "Enable external co-planners? (external CLIs review artifacts at checkpoints)",
  header: "Co-Planners",
  multiSelect: false,
  options: [
    { label: "No (Default)", description: "Workflow runs with Claude only" },
    { label: "Yes", description: "External CLIs (codex, gemini, opencode) review artifacts" }
  ]
},
// ONLY show if co-planners = "Yes":
// First detect which CLIs are installed:
// Run: node ~/.claude/get-shit-done/bin/gsd-tools.cjs coplanner detect --raw
// Use results to annotate options with (installed) or (not installed)
{
  question: "Which external agents to use as default?",
  header: "Global Co-Planner Agents",
  multiSelect: true,
  options: [
    { label: "codex", description: "OpenAI Codex CLI" },
    { label: "gemini", description: "Google Gemini CLI" },
    { label: "opencode", description: "OpenCode CLI" }
  ]
},
// ONLY show if co-planners = "Yes":
{
  question: "Use different agents at specific checkpoints?",
  header: "Per-Checkpoint Overrides",
  multiSelect: false,
  options: [
    { label: "No", description: "Same agents at all checkpoints" },
    { label: "Yes", description: "Configure each checkpoint separately" }
  ]
},
// ONLY show if overrides = "Yes" — one question per checkpoint:
{
  question: "Agents for 'requirements' checkpoint?",
  header: "Requirements Checkpoint",
  multiSelect: true,
  options: [
    { label: "codex", description: "OpenAI Codex CLI" },
    { label: "gemini", description: "Google Gemini CLI" },
    { label: "opencode", description: "OpenCode CLI" }
  ]
},
{
  question: "Agents for 'roadmap' checkpoint?",
  header: "Roadmap Checkpoint",
  multiSelect: true,
  // same options
},
{
  question: "Agents for 'plan' checkpoint?",
  header: "Plan Checkpoint",
  multiSelect: true,
  // same options
},
{
  question: "Agents for 'verification' checkpoint?",
  header: "Verification Checkpoint",
  multiSelect: true,
  // same options
}
```

**3. Update "Update Config" section (step 4)** -- add co-planner merge rules:
```json
{
  ...existing_config,
  "co_planners": {
    "enabled": true/false,
    "timeout_ms": 120000,
    "agents": ["codex", "gemini"],
    "checkpoints": {
      "requirements": { "agents": ["codex"] },
      "plan": { "agents": ["codex", "gemini"] }
    }
  }
}
```

Co-planner merge rules:
- Read existing `co_planners` section first (preserve `timeout_ms`)
- When toggling `enabled: false`, preserve existing agents and checkpoints values
- When setting global agents, write the selected array
- When setting per-checkpoint overrides, only write checkpoints that differ from global. If same as global, omit (cleaner config).
- If no overrides selected, write `"checkpoints": {}`

**4. Update "Confirm Changes" display (step 5)** -- add co-planner rows:
```
| Co-Planners          | {On/Off} |
| Co-Planner Agents    | {codex, gemini / none} |
| Checkpoint Overrides | {Yes: list / No} |
```

**5. Update success_criteria** -- update count to include co-planner settings:
- `User presented with up to 15 settings (profile + 3 workflow + branching + 3 adversary + up to 7 co-planner)`
  </action>
  <verify>
Read the updated settings.md and verify structurally:
1. Co-planner toggle question exists after adversary section
2. Conditional flow documented (ONLY show if co-planners = "Yes")
3. Config merge rules include co_planners section
4. Confirm display includes co-planner rows

Additionally, run behavioral grep checks to confirm the content is actionable:
```bash
# Verify the toggle question text is present
grep -q 'Enable external co-planners' commands/gsd/settings.md && echo "PASS: toggle" || echo "FAIL: toggle"

# Verify multi-select agent question is present
grep -q 'Which external agents' commands/gsd/settings.md && echo "PASS: agent select" || echo "FAIL: agent select"

# Verify per-checkpoint override question is present
grep -q 'different agents at specific checkpoints' commands/gsd/settings.md && echo "PASS: override toggle" || echo "FAIL: override toggle"

# Verify merge rules reference co_planners
grep -q 'co_planners' commands/gsd/settings.md && echo "PASS: merge rules" || echo "FAIL: merge rules"

# Verify confirm display includes Co-Planner rows
grep -q 'Co-Planner' commands/gsd/settings.md && echo "PASS: display rows" || echo "FAIL: display rows"
```
All 5 checks must PASS.
  </verify>
  <done>
Settings command has co-planner questions: enable toggle, global agent selection (multi-select), per-checkpoint override toggle, and per-checkpoint agent selection (4 multi-select questions). Conditional flow follows adversary pattern. Config merge preserves existing timeout_ms. Display confirms all co-planner settings.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

**Config backup/restore protocol for tests 2-5:**
Before ANY config mutation, back up the live config:
```bash
cp .planning/config.json .planning/config.json.bak
```
After tests 2-5 complete (whether pass or fail), restore immediately:
```bash
mv .planning/config.json.bak .planning/config.json
```
If any test crashes, the `.bak` file is the rollback. Check for and restore it before proceeding.

1. **Function test:** `node get-shit-done/bin/gsd-tools.cjs coplanner agents plan` returns valid JSON
2. **Fallback test:** Set config `co_planners: { enabled: true, agents: ["codex"], checkpoints: {} }` and verify `coplanner agents plan` returns `["codex"]` (global fallback)
3. **Override test:** Set `co_planners.checkpoints.plan.agents: ["gemini"]` and verify `coplanner agents plan` returns `["gemini"]` (checkpoint-specific)
4. **Validation test:** Set an invalid agent name and verify it produces a warning, not an error
5. **Kill switch test:** Set `enabled: false` and verify empty agents returned regardless of configuration
6. **Null checkpoint test:** `coplanner agents` (no argument) with `enabled: true, agents: ["codex"]` returns `["codex"]` (global path, no checkpoint lookup)
7. **Invalid checkpoint test:** `coplanner agents bogus` returns empty agents with warning containing "Unknown checkpoint"
8. **Template check:** Verify config template has all four co_planners fields
9. **Settings check:** Verify settings.md has co-planner questions with proper conditional flow. Additionally, run `grep -c "Co-Planner\|co_planners\|coplanner" commands/gsd/settings.md` to confirm at least 10 matches (toggle, agents, overrides, merge rules, display rows).
</verification>

<success_criteria>
- `coplanner agents <checkpoint>` returns resolved agent list as JSON with warnings
- Fallback chain works: checkpoint-specific -> global -> empty
- Kill switch prevents agent resolution when disabled
- Invalid agent names filtered with warnings (warn-and-continue)
- Config template has complete co_planners schema
- Settings command covers all co-planner configuration options
- Zero new npm dependencies
- Backward compatible with existing configs (missing agents/checkpoints fields handled gracefully)
</success_criteria>

<output>
After completion, create `.planning/phases/07-configuration/07-01-SUMMARY.md`
</output>
