---
milestone: v2.2
audited: 2026-02-17T21:30:00Z
status: tech_debt
scores:
  requirements: 11/11
  phases: 6/6
  integration: 12/12
  flows: 7/7
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 07-configuration
    items:
      - "Truth #3 (enabled but no agents configured) verified by static code inspection only — no dynamic test exercises this path"
  - phase: 09-multi-agent-orchestration
    items:
      - "Human verification: parallel execution timing not tested at runtime (static analysis confirms async exec)"
      - "Human verification: partial failure path not tested with real missing CLI binary at runtime"
  - phase: docs
    items:
      - "docs/reference/commands.md does not document co-planner settings in /gsd:settings entry (lists 5 of 15 actual settings)"
      - "Config template includes agents[] and checkpoints{} but cmdConfigEnsureSection writes only enabled + timeout_ms (handled defensively)"
      - "No unit tests for co-planner infrastructure functions (checkKillSwitch, getAgentsForCheckpoint, filterValidAgents)"
---

# v2.2 Collaborative Design — Milestone Audit

**Goal:** Integrate external AI agents (Codex CLI, Gemini CLI, OpenCode CLI) as co-planners throughout GSD workflows, complementing the existing adversary system.

**Audited:** 2026-02-17T21:30:00Z
**Status:** tech_debt (all requirements met, no critical blockers, accumulated debt needs review)

**Previous audit:** 2026-02-17T19:00:00Z — identified 8 tech debt items. Phases 10 and 11 were created as gap closure phases and resolved 5 of them.

## Requirements Coverage

All 11 v2.2 requirements satisfied.

| Requirement | Description | Phase | Status |
|-------------|-------------|-------|--------|
| INFRA-01 | Detect which external AI CLIs are installed | 6 | SATISFIED |
| INFRA-02 | Enable/disable co-planning globally via config.json toggle | 6 | SATISFIED |
| CORE-01 | Draft-review-synthesize pattern with external agents | 8 | SATISFIED |
| CORE-02 | Structured feedback parsed from external agent responses | 8 | SATISFIED |
| CORE-03 | Graceful degradation when CLIs fail/timeout/unavailable | 6, 11 | SATISFIED |
| CORE-04 | External agent input is advisory — Claude synthesizes | 8 | SATISFIED |
| CFG-01 | Per-checkpoint agent configuration | 7, 8 | SATISFIED |
| UX-01 | Clear formatted feedback display | 8 | SATISFIED |
| UX-02 | Agent attribution (provenance) | 8 | SATISFIED |
| MULTI-01 | Parallel review by multiple agents | 9 | SATISFIED |
| MULTI-02 | Merged synthesis with source attribution | 9 | SATISFIED |

**Score: 11/11 requirements satisfied**

## Phase Verification Summary

| Phase | Name | Status | Score | Notes |
|-------|------|--------|-------|-------|
| 6 | Foundation | PASSED | 8/8 | All error paths tested including TIMEOUT, PERMISSION, EXIT_ERROR |
| 7 | Configuration | GAPS_FOUND | 8/9 | SC3 (workflow invocation) by-design deferral to Phase 8 |
| 8 | Workflow Integration | PASSED | 13/13 | Closed Phase 7's SC3 gap + 4 gap closure items from adversary |
| 9 | Multi-Agent Orchestration | PASSED | 5/5 | classifyError bug noted; fixed in Phase 11 |
| 10 | Settings Fix & Integration Polish | PASSED | 3/3 | Gap closure: settings Bash tool, docstring, config init |
| 11 | Async Error Classification Fix | PASSED | 8/8 | 27 unit tests; 109/109 total tests pass |

**Score: 6/6 phases verified**

## Cross-Phase Integration

Integration checker verified 12/12 exports wired, 0 orphaned, 0 missing.

| # | Connection | Status | Details |
|---|-----------|--------|---------|
| 1 | Phase 6 adapters → Phase 7 SUPPORTED_CLIS | WIRED | filterValidAgents validates against adapter CLI_NAME constants |
| 2 | Phase 6 checkKillSwitch → Phase 7 getAgentsForCheckpoint | WIRED | Kill switch checked before agent resolution |
| 3 | Phase 7 getAgentsForCheckpoint → Phase 8 workflows | WIRED | All 4 checkpoint strings match VALID_CHECKPOINTS |
| 4 | Phase 6 adapters → Phase 9 invokeAsync | WIRED | All 3 adapters export invokeAsync with exec |
| 5 | Phase 9 invoke-all → adapters invokeAsync | WIRED | Promise.allSettled calls adapter.invokeAsync correctly |
| 6 | Phase 7 config → Phase 9 invoke-all | WIRED | invoke-all reuses getAgentsForCheckpoint for resolution |
| 7 | Phase 8 sequential → Phase 9 parallel | WIRED | All 4 checkpoints use invoke-all, zero sequential invoke calls remain |
| 8 | Settings UI → coplanner detect | WIRED | Phase 10 added Bash to settings.md allowed-tools |
| 9 | Phase 11 classifyError fix → Phase 9 invokeAsync error path | WIRED | typeof err.code === 'number' guard in all 3 adapters |
| 10 | Phase 10 cmdConfigEnsureSection → co_planners defaults | WIRED | co_planners: {enabled: false, timeout_ms: 120000} in hardcoded defaults |
| 11 | Phase 10 docstring → all 5 coplanner subcommands | WIRED | detect, invoke, invoke-all, enabled, agents all documented |
| 12 | Phase 11 test suite → all 3 adapter classifyError exports | WIRED | 27 tests via require() imports |

**Score: 12/12 integrations verified**

## E2E Flow Verification

| # | Flow | Status |
|---|------|--------|
| 1 | Settings → detection → config write | COMPLETE |
| 2 | New project → co-planner review at requirements checkpoint | COMPLETE |
| 3 | New project → co-planner review at roadmap checkpoint | COMPLETE |
| 4 | Plan phase → co-planner review at plan checkpoint | COMPLETE |
| 5 | Execute phase → co-planner review at verification checkpoint | COMPLETE |
| 6 | Missing CLI → classifyError → structured error → synthesis continues | COMPLETE |
| 7 | Kill switch off → all invocations skip → workflow proceeds | COMPLETE |

**Score: 7/7 flows complete**

## Gap Closure from Previous Audit

Previous audit (2026-02-17T19:00:00Z) identified 8 tech debt items. Phases 10 and 11 closed 5:

| Issue | Resolved By | Status |
|-------|------------|--------|
| settings.md lacks Bash in allowed-tools | Phase 10 | CLOSED |
| classifyError async-path exit-127/126 misclassification | Phase 11 | CLOSED |
| Stale docstring missing agents and invoke-all | Phase 10 | CLOSED |
| cmdConfigEnsureSection doesn't initialize co_planners | Phase 10 | CLOSED |
| Integration #8: Settings UI → coplanner detect NOT WIRED | Phase 10 | CLOSED |
| Truth #3 no dynamic test | — | OPEN (low risk) |
| Human verification: parallel timing and partial failure | — | OPEN (low risk) |
| No unit tests for co-planner functions | Phase 11 (partial) | PARTIAL — classifyError tested, infrastructure functions remain untested |

## Remaining Tech Debt

No critical blockers. 6 non-blocking items across 3 areas.

### Phase 7: Configuration
- **Truth #3 untested dynamically** — The "enabled but no agents configured" warning path is code-verified but no functional test exercises it. Low risk: simple conditional with string push.

### Phase 9: Multi-Agent Orchestration
- **Parallel execution timing** — Static analysis confirms async `exec`, not `execSync`-in-Promise. True concurrency only observable at runtime. Low risk: Node.js event loop guarantees.
- **Partial failure at runtime** — Each segment individually verified (classifyError → structured error → synthesis proceeds), but full path not run end-to-end with real missing CLI. Low risk.

### Documentation & Testing
- **Stale docs/reference/commands.md** — `/gsd:settings` entry lists 5 of 15 actual settings. No milestone phase was tasked with updating user-facing docs.
- **Config template vs. defaults mismatch** — Template includes `agents[]` and `checkpoints{}`, init code writes only `enabled` + `timeout_ms`. `getAgentsForCheckpoint()` handles missing keys defensively. Non-breaking.
- **No unit tests for co-planner infrastructure** — `checkKillSwitch`, `getAgentsForCheckpoint`, `filterValidAgents` have no unit tests. `classifyError` fully tested (27 tests). Moderate value to add.

### Total: 6 items across 3 areas

## Test Suite

```
109 tests, 22 suites, 0 failures
```

---

*Audited: 2026-02-17T21:30:00Z*
*Previous audit: 2026-02-17T19:00:00Z (5 of 8 items resolved by Phases 10-11)*
*Auditor: Claude (gsd milestone audit orchestrator + gsd-integration-checker)*
