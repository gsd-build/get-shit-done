---
phase: 04-execution-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/commands/execute.js
  - src/declare-tools.js
  - dist/declare-tools.cjs
  - .claude/commands/declare/execute.md
autonomous: true
requirements:
  - EXEC-01
  - EXEC-02
  - EXEC-03
  - EXEC-04

must_haves:
  truths:
    - "User can run /declare:execute M-XX and the system computes waves, generates exec plans, spawns agents, verifies per wave, and updates milestone status"
    - "Independent actions within a wave execute in parallel via Task tool agent spawning"
    - "After each wave the system verifies upward causation with automated checks and AI review"
    - "When all milestone actions complete and verify, the milestone status auto-updates to DONE in MILESTONES.md"
  artifacts:
    - path: "src/commands/execute.js"
      provides: "Orchestration data provider: milestone info, wave structure, action details, trace context"
      exports: ["runExecute"]
    - path: "src/declare-tools.js"
      provides: "Updated CLI entry point with all new subcommands wired"
      min_lines: 250
    - path: "dist/declare-tools.cjs"
      provides: "Rebuilt bundle including all Phase 4 modules"
    - path: ".claude/commands/declare/execute.md"
      provides: "Slash command orchestrating the full execution pipeline"
      min_lines: 80
  key_links:
    - from: ".claude/commands/declare/execute.md"
      to: "dist/declare-tools.cjs"
      via: "node dist/declare-tools.cjs compute-waves, generate-exec-plan, verify-wave, execute"
      pattern: "node dist/declare-tools\\.cjs"
    - from: "src/declare-tools.js"
      to: "src/commands/compute-waves.js"
      via: "require and switch case dispatch"
      pattern: "case 'compute-waves'"
    - from: "src/declare-tools.js"
      to: "src/commands/verify-wave.js"
      via: "require and switch case dispatch"
      pattern: "case 'verify-wave'"
---

<objective>
Wire all Phase 4 subcommands into declare-tools.js, rebuild the bundle, and create the /declare:execute slash command that orchestrates the full execution pipeline.

Purpose: This plan connects the engine modules from 04-01 into a user-facing command that takes a milestone ID and executes all its actions with wave scheduling, parallel agents, and upward verification — the complete execution loop.
Output: execute.js command, updated declare-tools.js with 4 new subcommands, rebuilt bundle, /declare:execute slash command
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-execution-pipeline/04-RESEARCH.md
@.planning/phases/04-execution-pipeline/04-01-SUMMARY.md
@src/declare-tools.js
@src/commands/compute-waves.js
@src/commands/generate-exec-plan.js
@src/commands/verify-wave.js
@src/artifacts/exec-plan.js
@src/artifacts/milestones.js
@.claude/commands/declare/trace.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create execute command and wire all subcommands into declare-tools.js</name>
  <files>src/commands/execute.js, src/declare-tools.js</files>
  <action>
Create `src/commands/execute.js`:
- Export `runExecute(cwd, args)` following established command module pattern
- Accept `--milestone M-XX` flag (required)
- This is the data provider for the slash command — returns everything the orchestrator needs in one call
- Load DAG via `buildDagFromDisk(cwd)`
- Validate milestone exists and is type 'milestone'
- Get all actions for milestone (both DONE and non-DONE) for complete picture
- Compute waves by calling `runComputeWaves` logic inline (or import from compute-waves)
- Build trace context: upstream declarations from `dag.getUpstream(milestoneId)`
- Return JSON: `{ milestoneId, milestoneTitle, status, declarations: [{id, title}], allActions: [{id, title, status, produces}], pendingActions: [{id, title, status, produces}], waves: [{wave, actions}], totalActions, pendingCount, doneCount, allDone, milestoneFolderPath }`
- Include `milestoneFolderPath` using `findMilestoneFolder` so the slash command knows where EXEC-PLAN files are written

Update `src/declare-tools.js`:
- Add requires at top for new modules:
  - `const { runComputeWaves } = require('./commands/compute-waves');`
  - `const { runGenerateExecPlan } = require('./commands/generate-exec-plan');`
  - `const { runVerifyWave } = require('./commands/verify-wave');`
  - `const { runExecute } = require('./commands/execute');`
- Add four new cases to the switch statement:
  - `case 'compute-waves':` — calls `runComputeWaves(cwd, args.slice(1))`, prints JSON, exits on error
  - `case 'generate-exec-plan':` — calls `runGenerateExecPlan(cwd, args.slice(1))`, prints JSON, exits on error
  - `case 'verify-wave':` — calls `runVerifyWave(cwd, args.slice(1))`, prints JSON, exits on error
  - `case 'execute':` — calls `runExecute(cwd, args.slice(1))`, prints JSON, exits on error
- Update the error messages listing available commands to include: compute-waves, generate-exec-plan, verify-wave, execute
- Follow exact pattern of existing cases (parseCwdFlag, result, JSON.stringify, process.exit on error)

Rebuild bundle: `npx esbuild src/declare-tools.js --bundle --platform=node --target=node18 --outfile=dist/declare-tools.cjs --format=cjs`
  </action>
  <verify>
Run `node dist/declare-tools.cjs compute-waves --help` or `node dist/declare-tools.cjs compute-waves` — should return JSON with error about missing --milestone flag (not "Unknown command").
Run `node dist/declare-tools.cjs execute` — should return JSON with error about missing --milestone flag.
Run `node dist/declare-tools.cjs verify-wave` — should return JSON with error about missing flags.
Run `node dist/declare-tools.cjs generate-exec-plan` — should return JSON with error about missing flags.
  </verify>
  <done>
All four new subcommands are dispatched correctly from declare-tools.js, execute.js returns comprehensive milestone execution data, and the rebuilt bundle responds to all new commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /declare:execute slash command with full orchestration flow</name>
  <files>.claude/commands/declare/execute.md</files>
  <action>
Create `.claude/commands/declare/execute.md` — the meta-prompt that orchestrates the full execution pipeline. Follow the established slash command pattern from trace.md and visualize.md.

Frontmatter:
```yaml
---
description: Execute actions for a milestone with wave-based scheduling and upward verification
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
  - Task
argument-hint: "[M-XX] [--confirm]"
---
```

The slash command body should instruct Claude through these steps:

**Step 1: Determine milestone scope.**
- If `$ARGUMENTS` contains a milestone ID (M-XX pattern), use it directly
- If `$ARGUMENTS` is empty (interactive mode): run `node dist/declare-tools.cjs execute` to get a milestone picker. Display milestones with status and action counts. Ask user to choose.
- Check for `--confirm` flag in arguments (if present, pause between waves for user review)

**Step 2: Load execution data.**
- Run: `node dist/declare-tools.cjs execute --milestone M-XX`
- Parse JSON. If `allDone` is true, report "All actions for M-XX are already complete" and exit.
- Display a banner:
```
## Executing: M-XX — [title]
Declarations: D-01 (title), D-02 (title)
Actions: N pending of M total | Waves: W
```

**Step 3: For each wave, execute actions.**
For each wave in the `waves` array:

  3a. **Generate exec plans** (on-demand, per wave — per research recommendation):
  For each action in the wave:
  - Run: `node dist/declare-tools.cjs generate-exec-plan --action A-XX --milestone M-XX --wave N`
  - Note the outputPath from the result

  3b. **Display wave banner:**
  ```
  --- Wave N ---
  Actions: A-01 (title), A-02 (title)
  Spawning N agent(s)...
  ```

  3c. **Spawn executor agents in parallel** using the Task tool:
  For each action in the wave, spawn a Task with:
  - Reference to the generated EXEC-PLAN file path
  - Instructions: "Execute the plan at [path]. Follow all tasks. Make atomic commits per task. Report results when complete."
  - Use GSD executor patterns: the agent reads the EXEC-PLAN file and executes its tasks autonomously

  3d. **After all agents in the wave complete, verify:**
  - Run: `node dist/declare-tools.cjs verify-wave --milestone M-XX --actions "A-01,A-02"`
  - Parse verification JSON
  - Display automated check results
  - Perform AI review: Given the trace context (declaration titles, milestone title, action titles), assess whether the completed work meaningfully advances the milestone. Produce a 1-2 sentence assessment.
  - If verification fails:
    - Retry up to 2 times: re-spawn the failed action's agent with the failure context appended
    - After 2 retries, surface to user: "Action A-XX failed verification after 2 retries. Details: [failure info]. What would you like to do?"
  - If `--confirm` flag was set, pause: "Wave N complete. Proceed to Wave N+1? (yes/no)"

  3e. **Update action statuses** in PLAN.md:
  After successful verification, use `Read` and `Write` tools to update each completed action's `**Status:** PENDING` to `**Status:** DONE` in the milestone's PLAN.md file.

**Step 4: After all waves complete, check milestone completion.**
- If `milestoneCompletable` is true from the final verify-wave result:
  - Update MILESTONES.md: change the milestone's Status from PENDING/ACTIVE to DONE
  - Use Read to load MILESTONES.md, find the row for M-XX, update status, Write back
  - Display: "Milestone M-XX marked as DONE"
- Display completion banner:
```
## Execution Complete: M-XX — [title]
Actions completed: N
Waves executed: W
Milestone status: DONE
```

**Error handling:**
- If any CJS command returns an error JSON, display it clearly and suggest fixes
- If milestone folder not found, suggest running /declare:actions first
- If no non-DONE actions, report milestone already complete

**Key patterns (from locked decisions):**
- Execution scope is per-milestone (never cross-milestone)
- Wave scheduling is automatic from the action graph
- Auto-advance between waves by default; --confirm pauses
- GSD-style banners with progress
- Atomic commits per task (handled by executor agents)
- Two-layer verification: automated checks (CJS) then AI review (slash command)
- Max 2 retries on verification failure
- Milestone auto-DONE when all actions complete and verify
  </action>
  <verify>
The file `.claude/commands/declare/execute.md` exists and contains:
1. Valid frontmatter with description, allowed-tools including Task, and argument-hint
2. Steps covering milestone selection, wave computation, plan generation, agent spawning, verification, and status updates
3. References to all four CJS subcommands (compute-waves, generate-exec-plan, verify-wave, execute)
4. --confirm flag handling for wave-by-wave user review
5. Retry logic (max 2) for verification failures
6. Milestone DONE auto-update logic
  </verify>
  <done>
/declare:execute slash command exists as a complete orchestration meta-prompt that walks Claude through the full execution pipeline: milestone scoping, wave computation, on-demand plan generation, parallel agent spawning, per-wave verification with retries, and milestone status auto-update.
  </done>
</task>

<task type="auto">
  <name>Task 3: Install slash command and verify end-to-end wiring</name>
  <files>.claude/commands/declare/execute.md</files>
  <action>
Copy the execute.md slash command to the user-level installation directory, matching the pattern from Phase 1 (01-03):
```bash
cp .claude/commands/declare/execute.md ~/.claude/commands/declare/execute.md
```

Verify the full wiring chain:
1. `node dist/declare-tools.cjs compute-waves` responds (with error about missing milestone flag — that's correct)
2. `node dist/declare-tools.cjs generate-exec-plan` responds (with error about missing flags)
3. `node dist/declare-tools.cjs verify-wave` responds (with error about missing flags)
4. `node dist/declare-tools.cjs execute` responds (with error about missing milestone flag)
5. The execute.md file exists in both project-level and user-level locations
6. The bundle `dist/declare-tools.cjs` is up to date (modification time after source files)

If any command returns "Unknown command" instead of a proper error, the wiring in declare-tools.js is broken — fix the switch case.
  </action>
  <verify>
Run all four new subcommands without args and confirm they return JSON error objects (not "Unknown command").
Confirm `~/.claude/commands/declare/execute.md` exists.
Confirm `dist/declare-tools.cjs` is newer than `src/declare-tools.js`.
  </verify>
  <done>
The full Phase 4 pipeline is wired end-to-end: 4 CJS subcommands respond correctly, the slash command is installed at both project and user level, and the bundle is rebuilt.
  </done>
</task>

</tasks>

<verification>
1. All four new subcommands (compute-waves, generate-exec-plan, verify-wave, execute) are dispatched from declare-tools.js
2. dist/declare-tools.cjs is rebuilt and responds to all new commands
3. /declare:execute slash command exists with complete orchestration flow
4. Slash command is installed to both .claude/commands/declare/ and ~/.claude/commands/declare/
5. The execute flow covers: milestone selection, wave computation, on-demand plan generation, parallel agent spawning, per-wave verification, retry logic, and milestone status auto-update
</verification>

<success_criteria>
The complete execution pipeline is operational: a user can run /declare:execute M-XX and the system will compute waves from the milestone's action graph, generate GSD-style execution plans on-demand, spawn parallel executor agents per wave, verify upward causation after each wave (automated + AI review), retry on failure (max 2), and auto-update the milestone to DONE when all actions complete. All four CJS subcommands are bundled and the slash command is installed.
</success_criteria>

<output>
After completion, create `.planning/phases/04-execution-pipeline/04-02-SUMMARY.md`
</output>
