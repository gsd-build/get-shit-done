---
phase: 05-integrity-system
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - src/declare-tools.js
  - src/commands/status.js
  - src/commands/execute.js
  - src/commands/verify-wave.js
  - src/commands/compute-waves.js
  - dist/declare-tools.cjs
autonomous: true
requirements:
  - INTG-01
  - INTG-03
must_haves:
  truths:
    - "verify-milestone is callable via `node dist/declare-tools.cjs verify-milestone --milestone M-XX`"
    - "All existing commands that check status === 'DONE' use isCompleted() instead, preserving behavior for new integrity statuses"
    - "/declare:status output includes an integrity section showing KEPT/BROKEN/HONORED/RENEGOTIATED milestone counts"
    - "Integrity information is presented as factual state, never as scores or judgment (INTG-03)"
  artifacts:
    - path: "src/declare-tools.js"
      provides: "verify-milestone subcommand registration"
      contains: "verify-milestone"
    - path: "src/commands/status.js"
      provides: "Integrity aggregation in status output"
      contains: "integrity"
    - path: "dist/declare-tools.cjs"
      provides: "Rebuilt bundle with all Phase 5 CJS changes"
  key_links:
    - from: "src/declare-tools.js"
      to: "src/commands/verify-milestone.js"
      via: "require and case dispatch"
      pattern: "runVerifyMilestone"
    - from: "src/commands/status.js"
      to: "src/graph/engine.js"
      via: "isCompleted for status checks"
      pattern: "isCompleted"
    - from: "src/commands/execute.js"
      to: "src/graph/engine.js"
      via: "isCompleted for pending action filtering"
      pattern: "isCompleted"
---

<objective>
Wire verify-milestone into the CLI, update all status-checking code to use isCompleted(), add integrity aggregation to the status command, and rebuild the bundle.

Purpose: Connects Phase 5's CJS modules to the rest of the system. Updates backward-compatibility sites so KEPT/HONORED/RENEGOTIATED milestones are treated as completed throughout the codebase. Adds integrity visibility to /declare:status per INTG-01 and INTG-03.

Output: Updated CLI dispatch, backward-compatible status checks, integrity-aware status command, rebuilt bundle.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integrity-system/05-RESEARCH.md
@.planning/phases/05-integrity-system/05-01-SUMMARY.md
@src/declare-tools.js
@src/commands/status.js
@src/commands/execute.js
@src/commands/verify-wave.js
@src/commands/compute-waves.js
@src/graph/engine.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire verify-milestone into declare-tools.js and update isCompleted() sites</name>
  <files>src/declare-tools.js, src/commands/verify-wave.js, src/commands/execute.js, src/commands/compute-waves.js</files>
  <action>
1. **declare-tools.js:** Add `verify-milestone` subcommand following the exact pattern of existing commands:
   - Add `const { runVerifyMilestone } = require('./commands/verify-milestone');` at the top.
   - Add a `case 'verify-milestone':` block in the switch statement that calls `runVerifyMilestone(cwd, args.slice(1))`.
   - Update the help text in the no-command error message to include `verify-milestone`.

2. **Update isCompleted() usage sites** -- import `isCompleted` from engine.js and replace hardcoded DONE checks:

   - `src/commands/compute-waves.js`: Find any `status !== 'DONE'` or `status === 'DONE'` checks in wave computation. Replace with `!isCompleted(status)` and `isCompleted(status)` respectively. Import `{ isCompleted }` from `'../graph/engine'`.

   - `src/commands/execute.js`: Line with `a.status !== 'DONE'` in pendingActions filter. Replace with `!isCompleted(a.status)`. Import `{ isCompleted }` from `'../graph/engine'`.

   - `src/commands/verify-wave.js`: Line with `a.status === 'DONE'` in milestoneCompletable check. Replace with `isCompleted(a.status)`. Also change the check `completedActionIds.includes(a.id)` to use isCompleted for the first condition. Import `{ isCompleted }` from `'../graph/engine'`.

   - `src/commands/status.js`: Lines checking `a.status === 'DONE'` and `m.status === 'DONE'` in detectStaleness. Replace with `isCompleted(a.status)` and `isCompleted(m.status)`. Import `{ isCompleted }` from `'../graph/engine'`.

   Note: Do NOT enforce state transitions in engine.js. The state machine is convention, not constraint.

3. **Export looksLikeFilePath from verify-wave.js** if verify-milestone.js needs to import it (check if 05-01 copied it inline -- if so, skip this step).
  </action>
  <verify>Run `node -e "require('./src/declare-tools')"` to verify no import errors. Run existing tests to confirm backward compatibility. Run `node dist/declare-tools.cjs verify-milestone --milestone M-01` (may return error for non-existent milestone, but should not crash).</verify>
  <done>verify-milestone callable from CLI. All DONE-checking sites use isCompleted(). No behavioral changes for existing PENDING/ACTIVE/DONE status flows.</done>
</task>

<task type="auto">
  <name>Task 2: Add integrity aggregation to status command and rebuild bundle</name>
  <files>src/commands/status.js, dist/declare-tools.cjs</files>
  <action>
1. **Enhance status.js** to include integrity aggregation:

   Add an `integrity` section to the return object. After computing coverage and staleness, scan all milestones for integrity statuses:

   ```javascript
   const integrity = {
     total: milestones.length,
     verified: 0,   // KEPT + HONORED + RENEGOTIATED
     kept: 0,
     honored: 0,
     renegotiated: 0,
     broken: 0,
     pending: 0,    // PENDING + ACTIVE + DONE (not yet verified)
   };
   for (const m of milestones) {
     switch (m.status) {
       case 'KEPT': integrity.kept++; integrity.verified++; break;
       case 'HONORED': integrity.honored++; integrity.verified++; break;
       case 'RENEGOTIATED': integrity.renegotiated++; integrity.verified++; break;
       case 'BROKEN': integrity.broken++; break;
       default: integrity.pending++; break;
     }
   }
   ```

   Add `integrity` to the return object.

   Update the health computation: if any milestone is BROKEN, health should be 'warnings' (not errors -- BROKEN is a state, not an error per INTG-03).

   **Language per INTG-03:** The integrity section is factual state reporting. No scores, no percentages, no pass/fail framing at the project level. The slash command renders this as:
   - "X milestones verified (Y kept, Z honored)" -- not "X% integrity score"
   - If broken: "N milestones in remediation" -- not "N milestones failed"

2. **Rebuild the bundle:**

   ```bash
   node esbuild.config.js
   ```

   Or use whatever build command the project uses (check package.json scripts or esbuild.config.js).

3. **Verify the bundle works:**

   ```bash
   node dist/declare-tools.cjs verify-milestone --milestone M-01
   node dist/declare-tools.cjs status
   ```

   Both should return valid JSON (status returns integrity section, verify-milestone returns error for non-existent milestone which is expected).
  </action>
  <verify>Run `node dist/declare-tools.cjs status` and verify JSON output contains an `integrity` field. Run `node dist/declare-tools.cjs verify-milestone --milestone M-01` and verify it returns structured JSON (error about missing milestone is fine if project has no M-01). Rebuild bundle and verify no bundling errors.</verify>
  <done>Status command returns integrity aggregation. Bundle rebuilt with all Phase 5 CJS changes. verify-milestone callable from dist/declare-tools.cjs. Language in status output is restoration-focused per INTG-03.</done>
</task>

</tasks>

<verification>
- `node dist/declare-tools.cjs status` returns JSON with `integrity` field containing kept/honored/renegotiated/broken counts
- `node dist/declare-tools.cjs verify-milestone --milestone M-XX` returns structured JSON
- All existing commands still work (`status`, `execute`, `verify-wave`, `compute-waves`)
- No behavioral regressions for PENDING/ACTIVE/DONE status flows
</verification>

<success_criteria>
- verify-milestone is a first-class CLI subcommand
- All status-checking code uses isCompleted() for backward compatibility
- Status command provides integrity aggregation without scores or judgment
- Bundle rebuilt and all subcommands operational
</success_criteria>

<output>
After completion, create `.planning/phases/05-integrity-system/05-02-SUMMARY.md`
</output>
