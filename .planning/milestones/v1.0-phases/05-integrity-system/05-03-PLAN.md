---
phase: 05-integrity-system
plan: 03
type: execute
wave: 3
depends_on:
  - "05-02"
files_modified:
  - .claude/commands/declare/execute.md
autonomous: true
requirements:
  - INTG-01
  - INTG-02
  - INTG-03
must_haves:
  truths:
    - "After all waves complete for a milestone, /declare:execute runs verify-milestone and writes VERIFICATION.md to the milestone folder"
    - "When verification fails, the system auto-derives remediation actions, appends them to PLAN.md, executes them, and re-verifies (max 2 attempts)"
    - "After 2 failed remediation attempts, the system produces a diagnosis report with specific suggestions and asks the user what to do"
    - "Successful first-pass verification marks milestone KEPT; successful remediation marks HONORED; user adjustment marks RENEGOTIATED"
    - "All user-facing messaging is restoration-focused: 'criterion not yet met' not 'failed', 'remediation needed' not 'broken'"
  artifacts:
    - path: ".claude/commands/declare/execute.md"
      provides: "Enhanced /declare:execute with milestone truth verification, auto-remediation loop, escalation, and VERIFICATION.md writing"
      contains: "verify-milestone"
  key_links:
    - from: ".claude/commands/declare/execute.md"
      to: "dist/declare-tools.cjs verify-milestone"
      via: "Bash tool call after all waves complete"
      pattern: "verify-milestone"
    - from: ".claude/commands/declare/execute.md"
      to: "dist/declare-tools.cjs generate-exec-plan"
      via: "Bash tool call for remediation action exec plan generation"
      pattern: "generate-exec-plan"
---

<objective>
Enhance the /declare:execute slash command with milestone truth verification, auto-remediation loop, escalation to user, and VERIFICATION.md writing -- transforming execution from "tasks done" to "promise kept."

Purpose: This is where INTG-01, INTG-02, and INTG-03 come together. After all actions complete and the milestone is marked DONE, the system verifies whether the milestone is actually TRUE. If not, it auto-remediates. If remediation fails twice, it escalates with restoration-focused suggestions. VERIFICATION.md records the full history.

Output: Updated /declare:execute slash command with integrity system integrated inline.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integrity-system/05-RESEARCH.md
@.planning/phases/05-integrity-system/05-01-SUMMARY.md
@.planning/phases/05-integrity-system/05-02-SUMMARY.md
@.claude/commands/declare/execute.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add milestone truth verification and VERIFICATION.md writing to /declare:execute</name>
  <files>.claude/commands/declare/execute.md</files>
  <action>
Extend the existing /declare:execute slash command by adding Steps 5-7 after the existing Step 4. Preserve all existing Steps 1-4 exactly as they are. The new steps are appended after "Step 4: After all waves complete, check milestone completion."

**Modify Step 4:** Change the milestone status update from DONE to just recording DONE as an intermediate state. The milestone status will be further updated by the verification step. Keep the existing logic but add a note: "Milestone marked DONE (pending verification)."

**Add Step 5: Milestone truth verification.**

After marking milestone DONE in Step 4:

5a. Run programmatic verification:
```bash
node dist/declare-tools.cjs verify-milestone --milestone M-XX
```

5b. Parse the JSON result. Display the programmatic check results:
```
### Milestone Verification: M-XX

| Criterion | Type | Result | Evidence |
| --------- | ---- | ------ | -------- |
| SC-01     | artifact | PASS | File found at path (NNN bytes) |
| SC-02     | test | PASS | npm test exited with code 0 |
| SC-03     | ai   | (pending) | |
```

5c. Perform AI assessment (the final criterion with type 'ai'):
   - Read the milestone title, trace context (declarations and whyChain from the verify-milestone result), and review the work completed in all waves.
   - Assess: "Given that all actions for this milestone have completed, does the milestone truth statement hold? Is '[milestone title]' actually true?"
   - If all programmatic checks passed AND the AI assessment is positive, the milestone truth holds.
   - If programmatic checks failed, skip AI assessment (programmatic failures are definitive -- go straight to remediation).
   - Fill in the AI criterion evidence with a 1-2 sentence assessment.
   - Use restoration-focused language: "criterion met" / "criterion not yet met" (never "passed" / "failed" in user-facing output).

5d. Determine verification outcome:
   - ALL criteria pass (including AI): proceed to mark KEPT.
   - ANY criterion not met: proceed to remediation loop (Step 6).

5e. If all pass -- mark milestone KEPT:
   1. Read `.planning/MILESTONES.md`, change M-XX status from DONE to KEPT.
   2. Write VERIFICATION.md to the milestone folder with one successful attempt.
   3. Display (3-5 lines): "Milestone M-XX verified as KEPT -- [title] holds true. [brief summary of what was verified]"
   4. Skip to completion banner (Step 8).

**Add Step 6: Remediation loop (max 2 attempts).**

If verification in Step 5 found criteria not yet met:

6a. Update MILESTONES.md status to BROKEN for M-XX.

6b. Write VERIFICATION.md to milestone folder recording the failed attempt (attempt 1) with all criteria results, using `writeVerificationFile` format.

6c. For each remediation attempt (max 2):

   i. Analyze the failing criteria. For each criterion not yet met, derive 1-3 targeted remediation actions using AI reasoning:
   ```
   Given these verification results for milestone M-XX ("[milestone title]"):

   Criteria not yet met:
   - SC-XX: [description] -- Evidence: [evidence]

   Derive remediation actions. Rules:
   - Each action targets exactly one failing criterion
   - Do not modify code that already meets its criteria
   - Maximum 3 actions per remediation attempt
   - Each action needs: title, produces field, description
   ```

   ii. For each remediation action, append it to the milestone's PLAN.md:
   - Read the existing PLAN.md from the milestone folder.
   - Add a new action section at the bottom with the next available A-XX ID.
   - Mark it with `**Derived:** remediation (attempt N)` instead of a date.
   - Write the updated PLAN.md.

   iii. Generate exec plans for remediation actions:
   ```bash
   node dist/declare-tools.cjs generate-exec-plan --action A-XX --milestone M-XX --wave remediation
   ```

   iv. Display remediation banner:
   ```
   --- Remediation Attempt N ---
   **Criteria not yet met:** SC-XX, SC-YY
   **Actions:** A-XX ([title]), A-YY ([title])
   Spawning [count] agent(s)...
   ```

   v. Spawn executor agents for remediation actions using the Task tool (same pattern as Step 3c).

   vi. After remediation agents complete, re-run verification:
   ```bash
   node dist/declare-tools.cjs verify-milestone --milestone M-XX
   ```
   Re-do AI assessment for AI criterion.

   vii. If ALL criteria now pass:
   - Update MILESTONES.md status from BROKEN to HONORED.
   - Update VERIFICATION.md: append the successful attempt, update header state to HONORED.
   - Display (3-5 lines): "Milestone M-XX verified as HONORED -- [title] now holds true. Remediation: [what was fixed]."
   - Skip to completion banner (Step 8).

   viii. If criteria still not met after attempt 2: proceed to escalation (Step 7).

**Add Step 7: Escalation.**

After 2 failed remediation attempts:

7a. Update VERIFICATION.md with the final failed attempt.

7b. Display diagnosis report:
```
## Verification: M-XX requires attention

**Milestone:** [title]
**Remediation attempts:** 2 (criteria still not met)

### What was tried

**Attempt 1:** [actions taken] -- [which criteria still not met]
**Attempt 2:** [actions taken] -- [which criteria still not met]

### Criteria still not met

| Criterion | Evidence |
| --------- | -------- |
| SC-XX     | [latest evidence] |

### Suggestions

- [Specific suggestion per failing criterion, e.g., "Consider narrowing SC-02 to check only the main export" or "The test in SC-03 may need a mock for external service X"]

### Options

1. **Adjust** the milestone statement or success criteria, then I will retry verification
2. **Accept** the current state and continue to the next milestone
```

7c. Wait for user response. If user adjusts:
   - Apply the adjustments.
   - Re-run verification.
   - If passes: mark RENEGOTIATED in MILESTONES.md, update VERIFICATION.md.
   - Display: "Milestone M-XX renegotiated and verified -- adjusted criteria now hold."

If user accepts: leave as BROKEN, note in VERIFICATION.md, continue.

**Add Step 8: Completion banner (replace existing completion display in Step 4).**

```
## Execution Complete: M-XX -- [milestoneTitle]

**Actions completed:** [count]
**Waves executed:** [count]
**Verification:** [KEPT | HONORED | RENEGOTIATED | BROKEN (user accepted)]
**Milestone status:** [final status]
```

**Language guidelines (INTG-03) -- apply throughout all new steps:**
- "criterion not yet met" not "criterion failed"
- "remediation needed" not "milestone broken" (BROKEN is internal state name, not user messaging)
- "what needs to happen" not "what went wrong"
- "requires attention" not "verification failed"
- Escalation includes specific suggestions, never judgment
- No integrity scores or percentages at project level
  </action>
  <verify>Read the updated execute.md and verify: (1) Steps 1-4 preserved, (2) Step 5 runs verify-milestone and writes VERIFICATION.md, (3) Step 6 has remediation loop with max 2 attempts, (4) Step 7 has escalation with diagnosis report and user options, (5) Language is restoration-focused throughout, (6) KEPT/HONORED/RENEGOTIATED states are set correctly.</verify>
  <done>/declare:execute runs milestone truth verification after all waves complete. Auto-remediation derives and executes targeted actions on failure. Escalation produces diagnosis with suggestions after 2 attempts. VERIFICATION.md written to milestone folder with full history. All messaging is restoration-focused per INTG-03.</done>
</task>

</tasks>

<verification>
- /declare:execute includes verify-milestone step after all waves complete
- VERIFICATION.md is written to milestone folder with structured checklist format
- Remediation loop max 2 attempts, derives targeted actions, re-verifies
- Escalation includes diagnosis report with what was tried and specific suggestions
- User can adjust milestone criteria during escalation (RENEGOTIATED path)
- Language throughout is restoration-focused: no scores, no judgment, no "failed"
- State transitions: DONE->KEPT (happy), DONE->BROKEN->HONORED (remediated), DONE->BROKEN->RENEGOTIATED (adjusted)
</verification>

<success_criteria>
- The gap between "tasks done" and "promise kept" is closed -- /declare:execute verifies truth, not just task completion
- Auto-remediation works inline during execution without user intervention
- Escalation provides actionable suggestions, not just failure reports
- Full audit trail in per-milestone VERIFICATION.md
- No punitive language anywhere in user-facing output
</success_criteria>

<output>
After completion, create `.planning/phases/05-integrity-system/05-03-SUMMARY.md`
</output>
