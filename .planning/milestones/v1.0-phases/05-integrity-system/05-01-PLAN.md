---
phase: 05-integrity-system
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/graph/engine.js
  - src/artifacts/verification.js
  - src/commands/verify-milestone.js
autonomous: true
requirements:
  - INTG-01
must_haves:
  truths:
    - "Engine accepts KEPT, BROKEN, HONORED, RENEGOTIATED as valid statuses alongside PENDING, ACTIVE, DONE"
    - "isCompleted() returns true for DONE, KEPT, HONORED, RENEGOTIATED and false for PENDING, ACTIVE, BROKEN"
    - "VERIFICATION.md can be parsed from disk and written with structured checklist and attempt history"
    - "verify-milestone returns structured criteria (artifact checks, test checks, AI placeholder) for a given milestone"
  artifacts:
    - path: "src/graph/engine.js"
      provides: "Extended VALID_STATUSES, isCompleted helper, COMPLETED_STATUSES set"
      contains: "isCompleted"
    - path: "src/artifacts/verification.js"
      provides: "parseVerificationFile and writeVerificationFile for VERIFICATION.md"
      exports: ["parseVerificationFile", "writeVerificationFile"]
    - path: "src/commands/verify-milestone.js"
      provides: "Milestone-level truth verification with programmatic checks"
      exports: ["runVerifyMilestone"]
  key_links:
    - from: "src/commands/verify-milestone.js"
      to: "src/graph/engine.js"
      via: "buildDagFromDisk -> dag.getNode for milestone lookup"
      pattern: "buildDagFromDisk|getNode"
    - from: "src/commands/verify-milestone.js"
      to: "src/artifacts/milestone-folders.js"
      via: "findMilestoneFolder for PLAN.md location"
      pattern: "findMilestoneFolder"
---

<objective>
Build the Phase 5 CJS foundation: extend the graph engine with integrity statuses and the isCompleted() helper, create the VERIFICATION.md artifact module, and create the verify-milestone command for milestone-level truth verification.

Purpose: INTG-01 requires commitments tracked with a state machine. This plan establishes the state vocabulary in the engine, the artifact format for recording verification history, and the programmatic verification command that checks whether a milestone's truth actually holds.

Output: Three updated/new CJS modules with full TDD coverage.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integrity-system/05-RESEARCH.md
@src/graph/engine.js
@src/artifacts/plan.js
@src/artifacts/milestone-folders.js
@src/commands/verify-wave.js
@src/commands/build-dag.js
@src/commands/trace.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend engine.js with integrity statuses and isCompleted helper</name>
  <files>src/graph/engine.js</files>
  <action>
TDD: RED then GREEN then REFACTOR.

Add integrity statuses to engine.js:

1. Extend VALID_STATUSES from `['PENDING', 'ACTIVE', 'DONE']` to include `'KEPT', 'BROKEN', 'HONORED', 'RENEGOTIATED'`.

2. Add a COMPLETED_STATUSES set: `new Set(['DONE', 'KEPT', 'HONORED', 'RENEGOTIATED'])`. Note: BROKEN is NOT completed -- it means verification failed, remediation in progress.

3. Add and export an `isCompleted(status)` function that returns `COMPLETED_STATUSES.has(status)`.

4. Export COMPLETED_STATUSES for use by other modules.

5. Document the state machine transitions in a JSDoc comment above the sets:
   - PENDING -> ACTIVE -> DONE -> KEPT (happy path: verified true)
   - PENDING -> ACTIVE -> DONE -> BROKEN -> HONORED (remediation succeeds)
   - PENDING -> ACTIVE -> DONE -> BROKEN -> RENEGOTIATED (user adjusts)
   Note: State machine is convention, not enforced by engine. Orchestration logic follows transitions.

Write tests first in a test file alongside the source. Test that:
- addNode accepts all 7 statuses without throwing
- addNode rejects invalid statuses (e.g., 'INVALID')
- isCompleted returns true for DONE, KEPT, HONORED, RENEGOTIATED
- isCompleted returns false for PENDING, ACTIVE, BROKEN
  </action>
  <verify>Run `node --test src/graph/engine.test.js` (or equivalent test runner) and confirm all new tests pass. Verify existing tests in the project still pass.</verify>
  <done>Engine accepts all 7 statuses, isCompleted correctly categorizes each, existing addNode/validate behavior unchanged, all tests green.</done>
</task>

<task type="auto">
  <name>Task 2: Create verification.js artifact module and verify-milestone command</name>
  <files>src/artifacts/verification.js, src/commands/verify-milestone.js</files>
  <action>
TDD: RED then GREEN then REFACTOR.

**Part A: verification.js artifact module**

Create `src/artifacts/verification.js` following the pattern from `src/artifacts/plan.js`:

1. `parseVerificationFile(content)` -- Parse a VERIFICATION.md string into:
   ```
   { milestoneId, state, lastVerified, attempts, criteria: [{id, passed, description, result, evidence}], history: [{number, timestamp, passed, checks, remediationTriggered, remediationActions, stateTransition}] }
   ```
   Use regex matching on the structured format. Header fields extracted by `**Field:** value` pattern. Criteria from checkbox pattern `- [x/space] **SC-XX:** description -- PASS/FAIL`. History sections from `### Attempt N` headers.

2. `writeVerificationFile(milestoneId, milestoneTitle, state, criteria, history)` -- Generate the VERIFICATION.md string with:
   - Header: title, milestone ID, current state, last verified timestamp, attempt count
   - Success Criteria section: checkboxes with pass/fail and evidence
   - Verification History section: per-attempt logs with checks, remediation info, state transitions

3. `appendAttempt(existingContent, milestoneId, milestoneTitle, state, criteria, attempt)` -- Read existing content, update header metadata, append new attempt to history. This prevents overwriting previous attempts.

Write tests for:
- parseVerificationFile with empty content returns defaults
- parseVerificationFile with full content extracts all fields
- writeVerificationFile produces parseable output (round-trip test)
- appendAttempt preserves existing history and adds new attempt

**Part B: verify-milestone command**

Create `src/commands/verify-milestone.js` following the pattern from `src/commands/verify-wave.js`:

1. Parse `--milestone M-XX` flag.
2. Build DAG from disk via `buildDagFromDisk(cwd)`.
3. Validate milestone exists and is type 'milestone'.
4. Find milestone folder via `findMilestoneFolder`.
5. Load PLAN.md via `parsePlanFile` and extract actions with `produces` fields.
6. Build criteria array:
   - **Artifact checks:** For each action with a `produces` field that `looksLikeFilePath()`, check file existence with `existsSync`. Record SC-XX ID, type 'artifact', pass/fail, evidence string with file size.
   - **Test checks:** If `package.json` exists and has a `test` script, run `npm test` via `execFileSync` with 60s timeout. Record pass/fail with exit code and stderr snippet.
   - **AI placeholder:** Always add a final criterion with type 'ai', passed=null, evidence=null. This is filled by the slash command's AI assessment.
7. Build trace context via `traceUpward(dag, milestoneId)` to extract parent declarations.
8. Return structured result: `{ milestoneId, milestoneTitle, milestoneFolder, criteria, programmaticPassed, aiAssessmentNeeded, traceContext }`.

Import `looksLikeFilePath` from verify-wave.js (export it if not already exported), or copy the function inline if simpler.

Write tests for:
- Missing --milestone flag returns error
- Unknown milestone returns error
- Returns criteria array with artifact checks for actions with file-path produces
- AI assessment criterion always present as last item
- programmaticPassed is true when all non-AI criteria pass
  </action>
  <verify>Run tests for both modules. Verify `node --test src/artifacts/verification.test.js` and `node --test src/commands/verify-milestone.test.js` pass. Check that `require('./verify-milestone')` works without errors.</verify>
  <done>verification.js parses and writes VERIFICATION.md with round-trip fidelity. verify-milestone returns structured programmatic check results with artifact checks, test checks, and AI placeholder. All tests green.</done>
</task>

</tasks>

<verification>
- `node --test src/graph/engine.test.js` -- all status and isCompleted tests pass
- `node --test src/artifacts/verification.test.js` -- parse/write round-trip tests pass
- `node --test src/commands/verify-milestone.test.js` -- command logic tests pass
- `require('src/graph/engine').isCompleted('KEPT')` returns true
- `require('src/graph/engine').isCompleted('BROKEN')` returns false
- `require('src/artifacts/verification').parseVerificationFile` is a function
- `require('src/commands/verify-milestone').runVerifyMilestone` is a function
</verification>

<success_criteria>
- Engine accepts all 7 statuses (PENDING, ACTIVE, DONE, KEPT, BROKEN, HONORED, RENEGOTIATED)
- isCompleted() correctly classifies each status
- VERIFICATION.md can be written and parsed with full fidelity
- verify-milestone produces structured criteria with artifact, test, and AI check types
- All existing tests continue to pass (backward compatibility preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/05-integrity-system/05-01-SUMMARY.md`
</output>
