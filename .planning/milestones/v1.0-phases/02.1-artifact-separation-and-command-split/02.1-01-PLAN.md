---
phase: 02.1-artifact-separation-and-command-split
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/artifacts/milestones.js
  - src/artifacts/plan.js
  - src/artifacts/milestone-folders.js
  - src/commands/load-graph.js
  - src/artifacts/artifacts.test.js
autonomous: true

must_haves:
  truths:
    - "parseMilestonesFile returns milestones only (no actions property)"
    - "writeMilestonesFile produces a table with Plan column instead of Caused By, no Actions section"
    - "parsePlanFile extracts milestone ID and actions from section-per-action PLAN.md format"
    - "writePlanFile produces canonical PLAN.md with header metadata and action sections"
    - "Milestone folder utilities can create, find, and archive folders using M-XX-slug naming"
    - "load-graph scans .planning/milestones/*/PLAN.md for actions instead of MILESTONES.md"
    - "All tests pass with new artifact structure"
  artifacts:
    - path: "src/artifacts/plan.js"
      provides: "PLAN.md parser and writer for milestone folders"
      exports: ["parsePlanFile", "writePlanFile"]
    - path: "src/artifacts/milestone-folders.js"
      provides: "Milestone folder creation, lookup, archival utilities"
      exports: ["slugify", "milestoneFolderName", "getMilestoneFolderPath", "ensureMilestoneFolder", "findMilestoneFolder", "archiveMilestoneFolder"]
    - path: "src/artifacts/milestones.js"
      provides: "Milestones-only parser/writer (no actions)"
      exports: ["parseMilestonesFile", "writeMilestonesFile", "parseMarkdownTable"]
    - path: "src/commands/load-graph.js"
      provides: "Graph loader reading from FUTURE.md + MILESTONES.md + milestone folders"
  key_links:
    - from: "src/commands/load-graph.js"
      to: "src/artifacts/plan.js"
      via: "require('../artifacts/plan')"
      pattern: "parsePlanFile"
    - from: "src/commands/load-graph.js"
      to: "src/artifacts/milestone-folders.js"
      via: "folder scanning"
      pattern: "readdirSync.*milestones"
---

<objective>
Restructure the artifact layer so MILESTONES.md contains only milestone metadata (no actions), actions live in per-milestone PLAN.md files inside `.planning/milestones/{M-XX-slug}/`, and load-graph reads from all three sources.

Purpose: This is the foundational data layer change that all subsequent plans depend on. Without this, the command and workflow splits cannot work because they need the new artifact format.
Output: Updated milestones.js, new plan.js, new milestone-folders.js, updated load-graph.js, all with passing tests.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-artifact-separation-and-command-split/02.1-RESEARCH.md
@src/artifacts/milestones.js
@src/artifacts/future.js
@src/commands/load-graph.js
@src/artifacts/artifacts.test.js
@src/graph/engine.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plan.js and milestone-folders.js modules with tests</name>
  <files>
    src/artifacts/plan.js
    src/artifacts/milestone-folders.js
    src/artifacts/artifacts.test.js
  </files>
  <action>
Create two new CJS modules following established patterns ('use strict', @ts-check, JSDoc):

**src/artifacts/plan.js** -- PLAN.md parser and writer for milestone folders:

`parsePlanFile(content)`:
- Extract milestone ID from `# Plan: M-XX` header line
- Extract metadata fields from `**Field:** Value` lines (Realizes, Status, Derived)
- Extract actions from `### A-XX: Title` sections. Each action has Status, Produces fields parsed from `**Field:** Value` lines within the section. Any remaining non-field lines are the description.
- Return `{ milestone, realizes, status, derived, actions: [{ id, title, status, produces, description }] }`
- Handle empty/missing content gracefully (return `{ milestone: null, realizes: [], status: 'PENDING', derived: '', actions: [] }`)

`writePlanFile(milestoneId, milestoneTitle, realizes, actions)`:
- Produce canonical PLAN.md format:
```markdown
# Plan: M-XX -- Milestone Title

**Milestone:** M-XX
**Realizes:** D-01, D-02
**Status:** PENDING
**Derived:** 2026-02-16

## Actions

### A-01: Action Title
**Status:** PENDING
**Produces:** What this action creates
Optional description paragraph.
```
- Use current date for Derived field
- Each action gets its own `###` section

**src/artifacts/milestone-folders.js** -- Folder management utilities:

`slugify(title)` -- lowercase, replace non-alphanumeric runs with hyphens, strip leading/trailing hyphens
`milestoneFolderName(id, title)` -- returns `{id}-{slug}` e.g. `M-01-user-auth`
`getMilestoneFolderPath(planningDir, id, title)` -- returns full path: `{planningDir}/milestones/{id}-{slug}`
`ensureMilestoneFolder(planningDir, id, title)` -- creates folder if not exists, returns path
`findMilestoneFolder(planningDir, id)` -- finds folder starting with `{id}` prefix (handles slug changes), returns path or null
`archiveMilestoneFolder(planningDir, id)` -- moves folder to `.planning/milestones/_archived/`, returns boolean

All use `node:fs` and `node:path`. Use `mkdirSync({ recursive: true })` for creation. Use `renameSync` for archival.

**Tests in artifacts.test.js** -- Add new describe blocks:

For plan.js:
- parsePlanFile: canonical format, hand-edited/permissive, empty content, actions with descriptions
- writePlanFile: produces canonical format, round-trip (write -> parse preserves data)

For milestone-folders.js:
- slugify: basic, special chars, leading/trailing hyphens stripped
- milestoneFolderName: correct format
- findMilestoneFolder: finds by prefix, returns null when not found
- ensureMilestoneFolder: creates nested dirs
- archiveMilestoneFolder: moves to _archived/

Use `node:fs.mkdtempSync` for temp directories in folder tests. Clean up after.
  </action>
  <verify>
Run `node --test src/artifacts/artifacts.test.js` -- all existing and new tests pass.
  </verify>
  <done>
plan.js parses and writes PLAN.md in section-per-action format. milestone-folders.js handles folder CRUD. All tests pass including existing FUTURE.md tests (no regressions).
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite milestones.js and load-graph.js for new structure</name>
  <files>
    src/artifacts/milestones.js
    src/commands/load-graph.js
    src/artifacts/artifacts.test.js
  </files>
  <action>
**Modify src/artifacts/milestones.js:**

`parseMilestonesFile(content)`:
- Remove `actionsMatch` regex and actions parsing entirely
- Return `{ milestones }` only (no `actions` property)
- Milestone row shape changes: replace `causedBy` with `hasPlan` (boolean)
- Parse new columns: ID, Title, Status, Realizes, Plan (YES/NO)
- `hasPlan` parsed from Plan column: `(row['Plan'] || '').trim().toUpperCase() === 'YES'`

`writeMilestonesFile(milestones, projectName)`:
- **Remove the `actions` parameter** (breaking change -- callers updated in Plan 02)
- Remove the `## Actions` section entirely
- New header line: `# Milestones: ${projectName}` (not "Milestones & Actions")
- Milestone table columns: ID, Title, Status, Realizes, Plan
- Plan column: milestone.hasPlan ? 'YES' : 'NO'

Keep `parseMarkdownTable` and `splitMultiValue` unchanged (exported, used elsewhere).

**BACKWARD COMPATIBILITY BRIDGE:** To avoid breaking callers in this plan (they're updated in Plan 02), add a temporary compatibility: `writeMilestonesFile` accepts 2 or 3 args. If 3 args passed and second is an array, treat as old signature `(milestones, actions, projectName)` and ignore actions. This lets init.js and add-milestone.js continue working until Plan 02 updates them.

```javascript
function writeMilestonesFile(milestones, projectNameOrActions, maybeProjectName) {
  // Backward compat: old signature was (milestones, actions, projectName)
  const projectName = maybeProjectName || (typeof projectNameOrActions === 'string' ? projectNameOrActions : 'Project');
  // ... write milestones-only format
}
```

**Modify src/commands/load-graph.js:**

- Import `parsePlanFile` from `../artifacts/plan`
- Import `readdirSync`, `existsSync`, `readFileSync` from `node:fs`
- After loading milestones from MILESTONES.md, scan `.planning/milestones/` for folders
- For each non-underscore directory, read `PLAN.md` if it exists
- Parse each PLAN.md with `parsePlanFile`, collect actions with their `causes` derived from the plan's milestone ID
- Build DAG using actions from folder scans instead of MILESTONES.md
- Edge building for milestones: use `realizes` (unchanged). Remove `causedBy` edge building (actions now link upward via their plan's milestone reference)
- Keep action edge building from `a.causes` (same pattern, different data source)

**Update tests in artifacts.test.js:**

- Update `parseMilestonesFile` tests: expect `{ milestones }` only, no `.actions` property. Update canonical format test to use new Plan column instead of Caused By.
- Update `writeMilestonesFile` tests: remove actions from calls, check for `# Milestones:` header (not `# Milestones & Actions:`), verify no `## Actions` section.
- Update round-trip test: milestones only, no actions. Test `hasPlan` field.
- Update multi-value field test: remove actions table from content.
- Update full integration round-trip: actions come from PLAN.md files (create temp milestone folders with PLAN.md files, parse them, verify DAG reconstruction). Use `mkdtempSync` for the integration test.
- Backward compat test: verify `writeMilestonesFile(ms, [], 'Test')` still works (old 3-arg signature).
  </action>
  <verify>
Run `node --test src/artifacts/artifacts.test.js` -- all tests pass including updated milestones tests and new integration test.
Run `node --test src/commands/commands.test.js` -- existing command tests still pass (backward compat bridge handles old callers).
  </verify>
  <done>
MILESTONES.md format has no actions section. load-graph reads actions from milestone folder PLAN.md files. All tests pass. Backward compatibility bridge prevents breakage of callers not yet updated.
  </done>
</task>

</tasks>

<verification>
1. `node --test src/artifacts/artifacts.test.js` -- all tests pass
2. `node --test src/commands/commands.test.js` -- existing tests still pass (backward compat)
3. `node -e "const {parsePlanFile,writePlanFile}=require('./src/artifacts/plan'); const w=writePlanFile('M-01','Test',['D-01'],[{id:'A-01',title:'Do thing',status:'PENDING',produces:'artifact'}]); const p=parsePlanFile(w); console.log(JSON.stringify(p))"` -- round-trip works
4. Verify `parseMilestonesFile` returns object without `actions` property
5. Verify `writeMilestonesFile` output contains no `## Actions` section
</verification>

<success_criteria>
- plan.js exports parsePlanFile and writePlanFile with round-trip fidelity
- milestone-folders.js exports all 6 folder utilities
- milestones.js parser returns { milestones } with hasPlan field, writer produces milestones-only format
- load-graph scans milestone folders for actions
- All existing and new tests pass
- No regressions in commands.test.js
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-artifact-separation-and-command-split/02.1-01-SUMMARY.md`
</output>
