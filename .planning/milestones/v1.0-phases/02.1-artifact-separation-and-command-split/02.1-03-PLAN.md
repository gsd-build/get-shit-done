---
phase: 02.1-artifact-separation-and-command-split
plan: 03
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - commands/declare/milestones.md
  - commands/declare/actions.md
  - commands/declare/status.md
  - workflows/milestones.md
  - workflows/actions.md
autonomous: true

must_haves:
  truths:
    - "/declare:milestones derives milestones per declaration with checkbox confirmation UI"
    - "/declare:milestones does NOT derive actions (only milestones)"
    - "/declare:actions derives action plans per milestone and writes PLAN.md to milestone folders"
    - "/declare:actions with no args targets all milestones missing a plan"
    - "/declare:actions M-XX targets a specific milestone"
    - "/declare:status renders coverage and staleness indicators from status command output"
    - "When milestones already exist for a declaration, /declare:milestones flags inconsistencies for user decision"
  artifacts:
    - path: "commands/declare/milestones.md"
      provides: "Milestone-only derivation slash command with checkbox confirmation"
    - path: "commands/declare/actions.md"
      provides: "Action plan derivation slash command per milestone"
    - path: "workflows/milestones.md"
      provides: "Milestone derivation conversation workflow (no actions)"
    - path: "workflows/actions.md"
      provides: "Action plan derivation conversation workflow"
    - path: "commands/declare/status.md"
      provides: "Status command with coverage and staleness rendering"
  key_links:
    - from: "commands/declare/milestones.md"
      to: "workflows/milestones.md"
      via: "@-reference"
      pattern: "@.*workflows/milestones.md"
    - from: "commands/declare/actions.md"
      to: "workflows/actions.md"
      via: "@-reference"
      pattern: "@.*workflows/actions.md"
    - from: "commands/declare/actions.md"
      to: "dist/declare-tools.cjs create-plan"
      via: "bash tool call"
      pattern: "create-plan"
---

<objective>
Rewrite slash commands and workflows so /declare:milestones only derives milestones (with checkbox confirmation), new /declare:actions derives action plans per milestone, and /declare:status shows coverage and staleness.

Purpose: The user-facing commands must match the new artifact structure. Users interact through slash commands, which orchestrate tool calls to the updated CLI subcommands. This plan completes the user-visible portion of the restructuring.
Output: Updated milestones command/workflow, new actions command/workflow, updated status command.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.1-artifact-separation-and-command-split/02.1-RESEARCH.md
@.planning/phases/02.1-artifact-separation-and-command-split/02.1-01-SUMMARY.md
@commands/declare/milestones.md
@commands/declare/future.md
@workflows/milestones.md
@workflows/future.md
@commands/declare/status.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite /declare:milestones command and workflow for milestones-only with checkbox UI</name>
  <files>
    commands/declare/milestones.md
    workflows/milestones.md
  </files>
  <action>
**Rewrite commands/declare/milestones.md:**

Frontmatter:
```yaml
---
description: Derive milestones backward from declared futures
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
  - AskUserQuestion
argument-hint: "[D-XX]"
---
```

Note: Add `AskUserQuestion` to allowed-tools (needed for checkbox confirmation per locked decision).

Command flow:

**Step 1: Load current graph state.**
```bash
node /Users/guilherme/Projects/get-shit-done/dist/declare-tools.cjs load-graph
```
Parse JSON. If error, tell user to run `/declare:init`. If no declarations, tell user to run `/declare:future`.

**Step 2: Determine scope.**
- If `$ARGUMENTS` contains a declaration ID (e.g., D-01), derive only for that declaration
- Otherwise, derive for all declarations that have no milestones yet (check `realizes` edges in graph)

**Step 3: Follow the milestone derivation workflow.**
Reference: `@/Users/guilherme/Projects/get-shit-done/workflows/milestones.md`

**Step 4: Per-declaration milestone confirmation with checkboxes.**

After the workflow proposes milestones for a declaration, present them using AskUserQuestion with multi-select checkboxes:

```
Use AskUserQuestion to present proposed milestones as a checklist. The user checks which milestones to accept. Format:

Which of these milestones should we create for D-XX?
- [ ] Milestone A -- because [reason]
- [ ] Milestone B -- because [reason]
- [ ] Milestone C -- because [reason]
```

**Step 5: Persist each accepted milestone.**
For each checked milestone:
```bash
node /Users/guilherme/Projects/get-shit-done/dist/declare-tools.cjs add-milestone --title "Milestone Title" --realizes "D-XX"
```

**Step 6: Inconsistency flagging.**
If milestones already exist for a declaration being processed (re-derivation case):
- Show existing milestones
- Ask if they still align with the declaration
- Offer to keep, re-derive, or adjust
- Do NOT auto-reconcile (locked decision)

**Step 7: Show summary and suggest next step.**
After all declarations processed:
1. Reload graph for final counts
2. Show summary: declarations processed, milestones derived
3. Suggest: "Run `/declare:actions` to derive action plans for each milestone."

Key differences from current version:
- NO action derivation (removed entirely -- that's /declare:actions now)
- Checkbox confirmation via AskUserQuestion instead of freeform confirmation
- Per-declaration loop (one declaration at a time, not all at once)
- Inconsistency flagging for re-derivation
- No merge detection step (moved to future reconciliation phase)

**Rewrite workflows/milestones.md:**

Complete rewrite -- milestones-only derivation workflow.

## Opening
Show declarations being processed. State that we're deriving milestones only (actions come later via /declare:actions).

## Per-Declaration Derivation Loop
For each declaration:

### a. State the backward question
> For "[D statement]" to be true, what must be true?

### b. Propose milestones (2-4 per declaration)
Present each with clear backward logic. These will be shown as checkboxes by the command.

### c. Inconsistency awareness
If this declaration already has milestones, flag them before proposing new ones. Show existing milestones and ask if they still apply. Per locked decision: user decides what to update, not automatic reconciliation.

### d. After confirmation, move to next declaration

## Closing
> Milestone derivation complete.
> From [N] declarations, we derived [X] milestones.
> Run `/declare:actions` to derive action plans for each milestone.

## Design Principles
- Make backward logic visible and teachable
- Milestones are confirmed via checkboxes (batch selection per declaration)
- No action derivation in this workflow
- Flag inconsistencies, don't auto-fix
- Do not use emojis
  </action>
  <verify>
Read `commands/declare/milestones.md` -- contains AskUserQuestion in allowed-tools, references workflows/milestones.md, no mention of add-action or action derivation.
Read `workflows/milestones.md` -- contains only milestone derivation, no action derivation section, mentions /declare:actions as next step.
  </verify>
  <done>
/declare:milestones derives milestones only with checkbox confirmation UI. Workflow focuses on "what must be true?" questioning without action derivation. Inconsistency flagging present for re-derivation cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /declare:actions command and workflow, update /declare:status</name>
  <files>
    commands/declare/actions.md
    workflows/actions.md
    commands/declare/status.md
  </files>
  <action>
**Create commands/declare/actions.md:**

Frontmatter:
```yaml
---
description: Derive action plans per milestone
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
  - AskUserQuestion
argument-hint: "[M-XX]"
---
```

Command flow:

**Step 1: Load current graph state.**
```bash
node /Users/guilherme/Projects/get-shit-done/dist/declare-tools.cjs load-graph
```
Parse JSON. If error or no milestones, tell user to run `/declare:milestones` first.

**Step 2: Determine scope.**
- If `$ARGUMENTS` contains a milestone ID (e.g., M-01), derive only for that milestone
- Otherwise, derive for all milestones that don't have a plan yet (check `hasPlan` field or scan for missing PLAN.md folders)

**Step 3: Follow the action derivation workflow.**
Reference: `@/Users/guilherme/Projects/get-shit-done/workflows/actions.md`

**Step 4: For each milestone, derive and present plan for approval.**

The workflow derives actions for each milestone. After derivation, present the complete plan and ask for approval before persisting:

```
Use AskUserQuestion to ask the user to approve the derived plan for each milestone.

Proposed plan for M-XX "[milestone title]":
- A-XX: [action title] -- produces [what]
- A-XX: [action title] -- produces [what]

Approve this plan? (yes/adjust/skip)
```

**Step 5: Persist each approved plan.**
For each approved plan, call create-plan:
```bash
node /Users/guilherme/Projects/get-shit-done/dist/declare-tools.cjs create-plan --milestone "M-XX" --actions '[{"title":"Action Title","produces":"what it creates"}]'
```

Parse JSON result. If the milestone folder didn't exist, create-plan creates it.

**Step 6: Show summary.**
After all milestones processed:
1. Show summary: milestones processed, plans created, total actions derived
2. Suggest: "Run `/declare:status` to see coverage and health."

**Create workflows/actions.md:**

Action plan derivation workflow.

## Opening
Show milestones being processed. State that we're deriving action plans -- the concrete steps to make each milestone true.

## Per-Milestone Derivation Loop
For each milestone M:

### a. State the backward question
> For "[M title]" to be true, what must be done?

### b. Derive actions (2-6 per milestone)
For each proposed action:
- Title: clear, action-oriented
- Produces: what artifact or state change results
- Assess atomicity: Can it be completed in one focused session? Is "done" clear? If not, it might be a sub-milestone.

### c. Present complete plan for approval
Show all proposed actions together as a coherent plan. The command will present this for user approval.

### d. Handle adjustments
If user wants changes, adjust and re-present. If user approves, signal the command to persist.

### e. Move to next milestone

## Closing
> Action derivation complete.
> Created plans for [X] milestones with [Y] total actions.
> Run `/declare:status` to see coverage and health.

## Design Principles
- Actions are derived and presented as a complete plan per milestone, not individually
- "What must be done?" is the core question
- Each action should be atomic (single focused session, verifiable artifact, clear "done")
- Err toward atomic enough -- over-decomposition creates bloat
- Do not use emojis

**Update commands/declare/status.md:**

Add rendering for the new `coverage` and `staleness` fields returned by the status command.

After the existing status rendering:

```markdown
## Coverage
Show milestone coverage: X of Y milestones have plans (Z%)

If coverage < 100%:
> [List milestones without plans]
> Run `/declare:actions` to derive plans for uncovered milestones.

## Health Indicators
If staleness indicators exist, render them:
- NO_PLAN: "[M-XX] has no action plan"
- STALE: "[M-XX] plan not updated in N days"
- COMPLETABLE: "[M-XX] all actions done -- consider marking milestone as DONE"
- INCONSISTENT: "[M-XX] marked DONE but has incomplete actions"

If no indicators: "All milestones healthy."
```

Also install the new commands to user-level path:
The command instructs Claude to install `commands/declare/actions.md` to `~/.claude/commands/declare/actions.md` alongside existing commands. This is handled by the plan executor copying the file, same as Phase 01-03 pattern.
  </action>
  <verify>
Read `commands/declare/actions.md` -- references create-plan subcommand, has AskUserQuestion in allowed-tools, references workflows/actions.md.
Read `workflows/actions.md` -- contains per-milestone derivation with "what must be done?" pattern.
Read `commands/declare/status.md` -- contains coverage rendering and staleness indicator display.
Verify all 5 files exist and have content.
  </verify>
  <done>
/declare:actions derives action plans per milestone with approval UI. Workflow focuses on "what must be done?" questioning. Status command renders coverage and staleness. New actions command ready for user-level installation.
  </done>
</task>

</tasks>

<verification>
1. All 5 files exist: commands/declare/milestones.md, commands/declare/actions.md, commands/declare/status.md, workflows/milestones.md, workflows/actions.md
2. milestones.md command references add-milestone only (no add-action calls)
3. actions.md command references create-plan (not add-action)
4. Both commands have AskUserQuestion in allowed-tools
5. status.md renders coverage and staleness sections
6. No workflow references action derivation in milestones workflow
7. Actions workflow contains per-milestone derivation loop
</verification>

<success_criteria>
- /declare:milestones is milestones-only with checkbox confirmation
- /declare:actions derives action plans per milestone with approval
- /declare:status shows coverage percentage and staleness indicators
- Inconsistency flagging present in milestones command for re-derivation
- All workflows match their command files (no orphan references)
- User-level command installation instructions present
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-artifact-separation-and-command-split/02.1-03-SUMMARY.md`
</output>
