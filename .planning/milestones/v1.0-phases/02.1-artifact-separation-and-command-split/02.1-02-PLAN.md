---
phase: 02.1-artifact-separation-and-command-split
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - src/commands/create-plan.js
  - src/commands/add-milestone.js
  - src/commands/add-action.js
  - src/commands/status.js
  - src/commands/init.js
  - src/declare-tools.js
  - src/commands/help.js
  - src/commands/commands.test.js
  - dist/declare-tools.cjs
autonomous: true

must_haves:
  truths:
    - "create-plan subcommand writes a PLAN.md file to the correct milestone folder"
    - "add-milestone also creates the milestone folder on disk"
    - "add-action is removed from dispatch (replaced by create-plan)"
    - "status command shows milestone coverage, plan status, and staleness indicators"
    - "init creates empty milestones/ directory alongside FUTURE.md and MILESTONES.md"
    - "All callers of writeMilestonesFile use new 2-arg signature"
    - "Bundle is rebuilt with all changes"
  artifacts:
    - path: "src/commands/create-plan.js"
      provides: "Writes PLAN.md to milestone folder with actions"
      exports: ["runCreatePlan"]
    - path: "src/commands/status.js"
      provides: "Status with staleness detection and coverage indicators"
      exports: ["runStatus"]
    - path: "dist/declare-tools.cjs"
      provides: "Rebuilt bundle with all command changes"
  key_links:
    - from: "src/commands/create-plan.js"
      to: "src/artifacts/plan.js"
      via: "require('../artifacts/plan')"
      pattern: "writePlanFile"
    - from: "src/commands/create-plan.js"
      to: "src/artifacts/milestone-folders.js"
      via: "require('../artifacts/milestone-folders')"
      pattern: "ensureMilestoneFolder"
    - from: "src/commands/status.js"
      to: "src/artifacts/milestone-folders.js"
      via: "require('../artifacts/milestone-folders')"
      pattern: "findMilestoneFolder"
---

<objective>
Update all CLI subcommands to work with the new artifact structure: new create-plan command, updated add-milestone (creates folders), status with staleness, clean up old add-action, update init, rebuild bundle.

Purpose: The artifact layer (Plan 01) changed the data format. This plan updates all command-level code to read/write the new format, completing the backend changes before slash commands are updated.
Output: All subcommands working with new structure, passing tests, rebuilt bundle.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02.1-artifact-separation-and-command-split/02.1-RESEARCH.md
@.planning/phases/02.1-artifact-separation-and-command-split/02.1-01-SUMMARY.md
@src/commands/add-action.js
@src/commands/add-milestone.js
@src/commands/status.js
@src/commands/init.js
@src/declare-tools.js
@src/commands/help.js
@src/commands/commands.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create create-plan.js, update add-milestone.js, update init.js, remove add-action dispatch</name>
  <files>
    src/commands/create-plan.js
    src/commands/add-milestone.js
    src/commands/add-action.js
    src/commands/init.js
    src/declare-tools.js
    src/commands/help.js
  </files>
  <action>
**Create src/commands/create-plan.js:**

New command module following established pattern (parseFlag for args, load artifacts, build DAG for nextId, write, commit).

`runCreatePlan(cwd, args)`:
- Parse flags: `--milestone M-XX` (required), `--actions` (JSON string array of `[{title, produces}]`)
- Validate milestone exists in MILESTONES.md
- Load existing graph via parseMilestonesFile + parseFutureFile to build DAG for `nextId('action')`
- Also scan existing PLAN.md files across all milestone folders to include existing actions in DAG (for accurate nextId)
- Use `ensureMilestoneFolder` to create/find the milestone folder
- Get milestone's `realizes` from milestones data
- Auto-increment action IDs using `dag.nextId('action')` for each action
- Write PLAN.md to the milestone folder using `writePlanFile`
- Update MILESTONES.md: set `hasPlan: true` on the milestone, write using new `writeMilestonesFile(milestones, projectName)` (2-arg)
- Commit both `.planning/MILESTONES.md` and `.planning/milestones/{folder}/PLAN.md`
- Return `{ milestone, folder, actions: [{id, title, produces}], committed, hash }`

**Update src/commands/add-milestone.js:**

- After creating the milestone in MILESTONES.md, also call `ensureMilestoneFolder(planningDir, id, title)` to create the empty folder
- Update `writeMilestonesFile` call: use 2-arg signature `writeMilestonesFile(milestones, projectName)` (remove `actions` arg)
- Remove loading of `actions` from `parseMilestonesFile` result (it no longer returns actions)
- When building DAG, scan milestone folders with `parsePlanFile` to load existing actions (needed for accurate stats, not for nextId since we're adding milestones not actions)
- Add the milestone folder path to the commit file list

**Update src/commands/init.js:**

- After creating `.planning/` directory, also create `.planning/milestones/` directory
- Update `writeMilestonesFile` call: use 2-arg signature `writeMilestonesFile([], projectName)`
- Add `milestones/` to the created files list (report to user)

**Update src/declare-tools.js:**

- Replace `add-action` case with `create-plan` case:
  - Import `runCreatePlan` from `./commands/create-plan`
  - Remove import of `runAddAction`
  - Add `create-plan` dispatch case calling `runCreatePlan(cwd, args.slice(1))`
- Keep `add-action` as a deprecated alias that returns `{ error: 'add-action has been replaced by create-plan. Use: node declare-tools.cjs create-plan --milestone M-XX --actions [...]' }`
- Update the default error message to list `create-plan` instead of `add-action`

**Update src/commands/help.js:**

- Replace `add-action` entry with `create-plan --milestone M-XX --actions '[...]'`
- Update description: "Write action plan (PLAN.md) to milestone folder"
- Keep all other entries unchanged
  </action>
  <verify>
Run `node src/declare-tools.js help` -- shows create-plan instead of add-action.
Run `node src/declare-tools.js add-action --title test --causes M-01` -- returns deprecation error.
Verify `src/commands/create-plan.js` exists and exports `runCreatePlan`.
  </verify>
  <done>
create-plan writes PLAN.md to milestone folders. add-milestone creates folders on disk. init creates milestones/ directory. add-action is deprecated with helpful error. Dispatch updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update status.js with staleness, update tests, rebuild bundle</name>
  <files>
    src/commands/status.js
    src/commands/commands.test.js
    dist/declare-tools.cjs
  </files>
  <action>
**Update src/commands/status.js:**

Import `findMilestoneFolder` from `../artifacts/milestone-folders` and `parsePlanFile` from `../artifacts/plan`.

After loading milestones and building the DAG, add staleness detection (Claude's Discretion -- heuristics from research):

```javascript
function detectStaleness(cwd, planningDir, milestones) {
  const indicators = [];
  for (const m of milestones) {
    const folder = findMilestoneFolder(planningDir, m.id);
    if (!folder) {
      indicators.push({ milestone: m.id, issue: 'NO_PLAN', detail: 'No plan derived yet' });
      continue;
    }
    const planPath = join(folder, 'PLAN.md');
    if (!existsSync(planPath)) {
      indicators.push({ milestone: m.id, issue: 'EMPTY_FOLDER', detail: 'Folder exists but no PLAN.md' });
      continue;
    }
    // Check age via git
    try {
      const lastMod = execFileSync('git', ['log', '-1', '--format=%ct', '--', planPath], {
        cwd, encoding: 'utf-8', stdio: ['pipe', 'pipe', 'pipe']
      }).trim();
      if (lastMod) {
        const ageDays = (Date.now() - parseInt(lastMod, 10) * 1000) / 86400000;
        if (ageDays > 30) indicators.push({ milestone: m.id, issue: 'STALE', detail: `Plan not updated in ${Math.floor(ageDays)} days` });
      }
    } catch { /* git unavailable */ }
    // Check consistency
    const plan = parsePlanFile(readFileSync(planPath, 'utf-8'));
    if (m.status === 'ACTIVE' && plan.actions.length > 0 && plan.actions.every(a => a.status === 'DONE'))
      indicators.push({ milestone: m.id, issue: 'COMPLETABLE', detail: 'All actions done, milestone still ACTIVE' });
    if (m.status === 'DONE' && plan.actions.some(a => a.status !== 'DONE'))
      indicators.push({ milestone: m.id, issue: 'INCONSISTENT', detail: 'Milestone marked DONE but has incomplete actions' });
  }
  return indicators;
}
```

Add to return object:
- `coverage`: `{ total: milestones.length, withPlan: milestones.filter(m => m.hasPlan).count, percentage }`
- `staleness`: array of staleness indicators
- Load actions from milestone folders instead of MILESTONES.md for DAG building (same pattern as updated load-graph)

**Update src/commands/commands.test.js:**

- Remove all `add-action` tests (command is deprecated)
- Add `create-plan` tests:
  - Happy path: creates PLAN.md in milestone folder, updates MILESTONES.md hasPlan
  - Error: missing --milestone flag
  - Error: milestone not found
  - Verify action IDs are auto-incremented correctly
- Update `add-milestone` tests: verify folder is created on disk
- Update any tests that call `writeMilestonesFile` with 3 args to use 2 args
- Update any tests that check for `actions` in parseMilestonesFile result

**Rebuild bundle:**

```bash
node esbuild.config.js
```

Verify bundle works: `node dist/declare-tools.cjs help`
  </action>
  <verify>
Run `node --test src/commands/commands.test.js` -- all tests pass.
Run `node --test src/artifacts/artifacts.test.js` -- all tests still pass.
Run `node dist/declare-tools.cjs status` -- shows staleness indicators (or empty if no project).
Run `node dist/declare-tools.cjs create-plan --milestone M-01 --actions '[{"title":"test","produces":"thing"}]'` -- returns structured result (or expected error if no project).
  </verify>
  <done>
Status command shows coverage and staleness. create-plan tests pass. Bundle rebuilt and functional. All command tests pass.
  </done>
</task>

</tasks>

<verification>
1. `node --test src/commands/commands.test.js` -- all tests pass
2. `node --test src/artifacts/artifacts.test.js` -- all tests pass
3. `node dist/declare-tools.cjs help` -- lists create-plan, not add-action
4. `node dist/declare-tools.cjs add-action` -- returns deprecation message
5. Status output includes `coverage` and `staleness` fields
</verification>

<success_criteria>
- create-plan writes PLAN.md to correct milestone folder with auto-incremented action IDs
- add-milestone creates milestone folder on disk
- init creates .planning/milestones/ directory
- status includes coverage percentage and staleness indicators
- add-action returns deprecation message
- All tests pass, bundle rebuilt
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-artifact-separation-and-command-split/02.1-02-SUMMARY.md`
</output>
