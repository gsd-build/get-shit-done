---
phase: 08-notifications-and-observability
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/bin/telegram-session-logger.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Health check correctly detects API keys present in .env file"
    - "Session logs are created in .planning/telegram-sessions/ relative to project root regardless of cwd changes"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "dotenv initialization before process.env access"
      contains: "require('dotenv').config"
    - path: "get-shit-done/bin/telegram-session-logger.js"
      provides: "Project root captured at module load time"
      contains: "PROJECT_ROOT"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js"
      to: ".env"
      via: "dotenv.config() with explicit path"
      pattern: "dotenv.*config.*path"
    - from: "get-shit-done/bin/telegram-session-logger.js"
      to: ".planning/telegram-sessions/"
      via: "PROJECT_ROOT constant"
      pattern: "PROJECT_ROOT.*telegram-sessions"
---

<objective>
Fix two UAT failures from Phase 08 testing: health check not loading .env file and session logger using dynamic cwd.

Purpose: Close gaps identified during user acceptance testing so Phase 08 functionality works correctly.
Output: Patched gsd-tools.js and telegram-session-logger.js with stable path resolution.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-notifications-and-observability/08-UAT.md
@get-shit-done/bin/gsd-tools.js (lines 143-154, 4012-4120)
@get-shit-done/bin/telegram-session-logger.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dotenv initialization to gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add dotenv initialization immediately after the existing require statements (after line 153, before line 155).

Insert:
```javascript
// Load environment variables from project root .env
require('dotenv').config({ path: path.join(__dirname, '../../.env') });
```

This uses `__dirname` (stable, script location) rather than `process.cwd()` (dynamic). The path resolves to project root since gsd-tools.js is in `get-shit-done/bin/`.

The dotenv package is already a dependency in package.json (line 49: "dotenv": "^17.3.1").
  </action>
  <verify>
Run: `node get-shit-done/bin/gsd-tools.js health`
Expected: Shows "PASS" for Telegram Credentials and Anthropic API Key (assuming .env has these values).
  </verify>
  <done>Health check reads environment variables from .env file correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Capture PROJECT_ROOT at module load in telegram-session-logger.js</name>
  <files>get-shit-done/bin/telegram-session-logger.js</files>
  <action>
The root cause is that whisper-node library changes the working directory during transcription, so `process.cwd()` returns wrong path when creating session logs.

Fix by capturing the project root at module initialization (top of file, right after the requires):

1. After line 11 (`const path = require('path');`), add:
```javascript

// Capture project root at module load time (before any cwd changes)
const PROJECT_ROOT = process.cwd();
```

2. Replace line 21:
```javascript
  const sessionsDir = path.join(process.cwd(), '.planning', 'telegram-sessions');
```
with:
```javascript
  const sessionsDir = path.join(PROJECT_ROOT, '.planning', 'telegram-sessions');
```

3. Replace line 142:
```javascript
  const sessionsDir = path.join(process.cwd(), '.planning', 'telegram-sessions');
```
with:
```javascript
  const sessionsDir = path.join(PROJECT_ROOT, '.planning', 'telegram-sessions');
```

This ensures session logs always go to the correct location regardless of runtime cwd changes.
  </action>
  <verify>
1. Start telegram bot: `node get-shit-done/bin/gsd-tools.js telegram start`
2. After interaction, check session log location:
   `ls -la .planning/telegram-sessions/`
Expected: Session log file created in project's .planning/telegram-sessions/ directory, NOT in any node_modules subdirectory.
  </verify>
  <done>Session logs consistently created in .planning/telegram-sessions/ relative to where bot was started.</done>
</task>

</tasks>

<verification>
Run health check and verify both fixes:
```bash
node get-shit-done/bin/gsd-tools.js health
```

Expected output shows PASS for:
- Telegram Credentials
- Anthropic API Key

Verify session logger path resolution:
```bash
node -e "
const logger = require('./get-shit-done/bin/telegram-session-logger.js');
const path = logger.startSession();
console.log('Session path:', path);
console.log('Expected prefix:', process.cwd() + '/.planning/telegram-sessions/');
console.log('Match:', path.startsWith(process.cwd() + '/.planning/telegram-sessions/'));
"
```
</verification>

<success_criteria>
- `gsd-tools.js health` correctly detects env vars from .env file
- Session logs created in correct directory regardless of cwd changes during execution
- Both UAT Test 1 and Test 2 pass on re-run
</success_criteria>

<output>
After completion, create `.planning/phases/08-notifications-and-observability/08-08-SUMMARY.md`
</output>
