---
phase: 07-autonomous-execution-optimization
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/phase-sizer.js
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/bin/roadmap-parser.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Phase size limits trigger splitting when too many requirements exceed safe handling"
    - "Phase size detection identifies oversized phases"
    - "Automatic split recommendations preserve dependency ordering"
  artifacts:
    - path: "get-shit-done/bin/phase-sizer.js"
      provides: "Phase size estimation and split recommendation logic"
      min_lines: 100
      exports: ["estimatePhaseSize", "detectOversizedPhases", "recommendSplit"]
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "CLI commands: phase size, phase check, phase split-recommend"
      contains: "cmdPhaseSize"
  key_links:
    - from: "gsd-tools.js"
      to: "phase-sizer.js"
      via: "require('./phase-sizer.js')"
      pattern: "require.*phase-sizer"
    - from: "phase-sizer.js"
      to: "roadmap-parser.js"
      via: "parseRoadmap for phase data"
      pattern: "require.*roadmap-parser"
---

<objective>
Close gap for EXEC-21 (phase size limits trigger splitting when too many requirements exceed safe handling).

Purpose: Detect oversized phases before execution begins and recommend splits to prevent context exhaustion mid-phase.
Output: Phase sizer module with CLI integration
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-autonomous-execution-optimization/07-VERIFICATION.md
@.planning/phases/07-autonomous-execution-optimization/07-RESEARCH.md
@get-shit-done/bin/roadmap-parser.js
@get-shit-done/bin/token-monitor.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create phase-sizer.js module</name>
  <files>get-shit-done/bin/phase-sizer.js</files>
  <action>
Create phase sizing module for detecting and recommending splits for oversized phases:

1. **Constants:**
   ```javascript
   const LIMITS = {
     MAX_REQUIREMENTS_PER_PHASE: 8,     // More than 8 requirements = likely too large
     MAX_SUCCESS_CRITERIA_PER_PHASE: 6, // More than 6 criteria = complex verification
     MAX_ESTIMATED_PLANS: 5,            // More than 5 plans = consider splitting
     SAFE_CONTEXT_USAGE: 0.7,           // 70% of context window is safe
     CONTEXT_WINDOW: 200000             // Default context window size
   };
   ```

2. **estimatePhaseSize(phase):**
   - Count requirements from phase.requirements array
   - Count success criteria from phase.success_criteria array
   - Estimate plans: Math.ceil(requirements.length / 2) (2 requirements per plan average)
   - Estimate tokens: (requirements * 10000) + (success_criteria * 5000) + 20000 (overhead)
   - Return: { requirements, successCriteria, estimatedPlans, estimatedTokens, riskLevel }
   - riskLevel: 'low' (<5 reqs), 'medium' (5-8 reqs), 'high' (>8 reqs)

3. **detectOversizedPhases(phases):**
   - For each phase, call estimatePhaseSize
   - Flag as oversized if any of:
     - requirements > MAX_REQUIREMENTS_PER_PHASE
     - estimatedTokens > CONTEXT_WINDOW * SAFE_CONTEXT_USAGE (140k)
     - estimatedPlans > MAX_ESTIMATED_PLANS
   - Return: array of { phase: phaseNumber, reason: string, estimate }

4. **recommendSplit(phase):**
   - Analyze requirements for natural groupings
   - Group by requirement prefix if exists (AUTO-, EXEC-, KNOW-, etc.)
   - Group by keyword similarity (authentication, database, UI, etc.)
   - Create split recommendations: [{ name: "Phase Xa", requirements: [...] }, ...]
   - Each sub-phase should have 3-5 requirements
   - Return: { canSplit: boolean, recommendations: [], reasoning: string }

5. **validateSplitPreservesDependencies(originalPhase, recommendedSplits, allPhases):**
   - Check that splits don't break dependency ordering
   - If Phase N depends on Phase M, splits of N must all come after M
   - Return: { valid: boolean, issues: [] }

6. **formatReport(analysis):**
   - Generate human-readable report of phase sizing
   - Include: risk level, recommendation, token estimate
   - Format for console output (aligned columns)

Export: estimatePhaseSize, detectOversizedPhases, recommendSplit, validateSplitPreservesDependencies, LIMITS
  </action>
  <verify>
```bash
node -e "const { estimatePhaseSize, detectOversizedPhases, LIMITS } = require('./get-shit-done/bin/phase-sizer.js'); console.log('Module loads'); console.log('Limits:', LIMITS); const est = estimatePhaseSize({ requirements: ['R1','R2','R3'], success_criteria: ['C1','C2'] }); console.log('Estimate:', est)"
```
  </verify>
  <done>phase-sizer.js module created with estimatePhaseSize, detectOversizedPhases, and recommendSplit functions. Module loads without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add phase sizing commands to gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add phase sizing CLI commands to gsd-tools.js:

1. **Import phase-sizer** at top:
   `const { estimatePhaseSize, detectOversizedPhases, recommendSplit, LIMITS } = require('./phase-sizer.js');`

2. **Add cmdPhaseSize function** (or extend existing phase command if it exists):

   **phase size [phaseNumber]:**
   - If phaseNumber provided: show size estimate for that phase
   - If not provided: show size estimates for all phases
   - Read ROADMAP.md via roadmap-parser
   - Call estimatePhaseSize for each
   - Output: table with columns: Phase | Requirements | Criteria | Plans | Tokens | Risk

   **phase check:**
   - Call detectOversizedPhases on all phases
   - Output oversized phases with reasons
   - Exit code 0 if none oversized, 1 if any oversized
   - Use in CI/pre-execution validation

   **phase split-recommend <phaseNumber>:**
   - Call recommendSplit for specified phase
   - Output split recommendations as JSON
   - Include reasoning and grouped requirements
   - Show validation results (dependency preservation)

   **phase limits:**
   - Display current LIMITS constants
   - Useful for documentation and configuration reference

3. **Wire cmdPhaseSize** in main switch statement

4. **Integration with roadmap-parser:**
   - Use existing parseRoadmap function to get phase data
   - Handle missing ROADMAP.md gracefully (error message, exit 1)
  </action>
  <verify>
```bash
node get-shit-done/bin/gsd-tools.js phase limits
node get-shit-done/bin/gsd-tools.js phase size 7
node get-shit-done/bin/gsd-tools.js phase check
```
  </verify>
  <done>gsd-tools.js handles phase size/check/split-recommend/limits commands. Commands work correctly with ROADMAP.md.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate phase sizing into execute-roadmap workflow</name>
  <files>get-shit-done/bin/roadmap-parser.js</files>
  <action>
Extend roadmap-parser.js with phase sizing integration:

1. **Add validatePhaseSizes(phases):**
   - Import detectOversizedPhases from phase-sizer.js
   - Call detectOversizedPhases on all phases
   - Return: { valid: boolean, oversizedPhases: [], warnings: [] }

2. **Extend parseRoadmapWithDAG to include size validation:**
   - After parsing phases, run validatePhaseSizes
   - Add `sizeValidation` field to return object
   - Include: { valid, oversizedPhases, recommendations }

3. **Add warnOnOversizedPhases(validationResult):**
   - Generate warning messages for oversized phases
   - Format: "WARNING: Phase 7 has 11 requirements (max recommended: 8)"
   - Return warning strings for logging

4. **Export new functions:**
   - validatePhaseSizes
   - warnOnOversizedPhases

This enables execute-roadmap.md to check phase sizes before execution and warn or halt on oversized phases.
  </action>
  <verify>
```bash
node -e "const { parseRoadmapWithDAG, validatePhaseSizes, warnOnOversizedPhases } = require('./get-shit-done/bin/roadmap-parser.js'); console.log('Functions available:', typeof validatePhaseSizes, typeof warnOnOversizedPhases)"
node get-shit-done/bin/gsd-tools.js roadmap validate
```
  </verify>
  <done>roadmap-parser.js extended with validatePhaseSizes and warnOnOversizedPhases. Integration with parseRoadmapWithDAG complete.</done>
</task>

</tasks>

<verification>
1. `node get-shit-done/bin/phase-sizer.js` - No import errors
2. `node get-shit-done/bin/gsd-tools.js phase size` - Shows all phase estimates
3. `node get-shit-done/bin/gsd-tools.js phase check` - Reports oversized phases (exit code 0 or 1)
4. `node get-shit-done/bin/gsd-tools.js phase split-recommend 7` - Shows split recommendations
5. roadmap-parser.js exports validatePhaseSizes function
6. EXEC-21 requirement covered: Phase size limits trigger splitting recommendation
</verification>

<success_criteria>
- estimatePhaseSize() returns accurate estimates for phases
- detectOversizedPhases() identifies phases exceeding limits
- recommendSplit() provides actionable split recommendations
- CLI commands work: phase size, phase check, phase split-recommend
- Integration with roadmap-parser enables pre-execution validation
</success_criteria>

<output>
After completion, create `.planning/phases/07-autonomous-execution-optimization/07-05-SUMMARY.md`
</output>
