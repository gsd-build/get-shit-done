---
phase: 07-autonomous-execution-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/failure-handler.js
  - get-shit-done/bin/gsd-tools.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Failed operations automatically retry with exponential backoff"
    - "Non-retryable errors present user with skip/escalate options"
    - "Retry count and backoff delay are configurable"
    - "Rate limit errors (429, 503) trigger longer backoff than network errors"
  artifacts:
    - path: "get-shit-done/bin/failure-handler.js"
      provides: "Retry logic with exponential backoff and user escalation"
      exports: ["FailureHandler", "executeWithRetry"]
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "CLI commands for failure handling"
      contains: "failure"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js"
      to: "failure-handler.js"
      via: "require and command handlers"
      pattern: "require.*failure-handler"
    - from: "gsd-phase-coordinator.md"
      to: "failure-handler.js"
      via: "wrap phase execution in retry logic"
      pattern: "executeWithRetry"
---

<objective>
Failure Handling with Retry/Skip/Escalate Options

Purpose: Enable graceful degradation during roadmap execution. Transient errors (network, rate limits) auto-retry with exponential backoff. Permanent errors offer user choice: skip phase and continue, or escalate and halt.

Output: failure-handler.js module with CLI integration for wrapping operations in retry logic
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-autonomous-execution-optimization/07-RESEARCH.md

# Phase 6 foundation
@get-shit-done/bin/gsd-tools.js
@get-shit-done/bin/execution-log.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create failure-handler.js module</name>
  <files>get-shit-done/bin/failure-handler.js</files>
  <action>
Create FailureHandler class with:

1. Constructor accepting options:
   - maxRetries: default 3
   - baseDelay: default 1000 (1 second)
   - maxDelay: default 30000 (30 seconds)
   - jitterFactor: default 0.2 (20% jitter)

2. RETRYABLE_PATTERNS constant array:
   - /ECONNRESET/
   - /ETIMEDOUT/
   - /rate limit/i
   - /429/
   - /503/
   - /temporary/i
   - /ENOTFOUND/

Methods:
- isRetryable(error): Check if error matches retryable patterns
- calculateBackoff(attempt): Exponential backoff with jitter
  - exponential = min(baseDelay * 2^attempt, maxDelay)
  - jitter = exponential * jitterFactor * (random - 0.5)
  - return floor(exponential + jitter)
- async executeWithRetry(operation, context): Main retry loop
  - Try operation up to maxRetries times
  - On failure: check isRetryable, calculate backoff, sleep, retry
  - Return { success, result, retries } on success
  - Return { success: false, error, retries, context, options } on exhaustion
- async sleep(ms): Promise-based delay
- formatFailureMessage(error, context, retries): Human-readable failure report

Standalone helper:
- async executeWithRetry(operation, context, options): Convenience wrapper
  - Creates FailureHandler with options
  - Calls handler.executeWithRetry
  - Returns structured result

Export: { FailureHandler, executeWithRetry }

Follow Pattern 2 from 07-RESEARCH.md for implementation details.
  </action>
  <verify>node -e "const fh = require('./get-shit-done/bin/failure-handler.js'); const h = new fh.FailureHandler(); console.log('isRetryable 429:', h.isRetryable({message: '429 rate limit'})); console.log('backoff 0:', h.calculateBackoff(0)); console.log('backoff 2:', h.calculateBackoff(2))"</verify>
  <done>FailureHandler class exports isRetryable/calculateBackoff/executeWithRetry methods with exponential backoff and jitter</done>
</task>

<task type="auto">
  <name>Task 2: Add failure commands to gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add failure-handler require at top of gsd-tools.js:
const { FailureHandler, executeWithRetry } = require('./failure-handler.js');

Add failure command handler in switch statement:

case 'failure':
  Handle subcommands:

  1. 'test-retry' - Test retry logic with simulated failure
     - Read failCount from argv[4] (how many times to fail before success)
     - Create operation that fails failCount times then succeeds
     - Run executeWithRetry and output results
     - Useful for verifying retry behavior

  2. 'classify' - Classify an error message as retryable or not
     - Read error message from argv[4]
     - Create FailureHandler
     - Call isRetryable({ message: errorMsg })
     - Output: { retryable: boolean, pattern_matched: string | null }

  3. 'backoff' - Calculate backoff delay for attempt number
     - Read attempt from argv[4] (0-indexed)
     - Read optional baseDelay from argv[5]
     - Create FailureHandler with baseDelay
     - Output: { attempt, delay_ms, delay_readable }

  4. 'log-failure' - Log a failure event to EXECUTION_LOG.md
     - Read phase from argv[4]
     - Read error message from argv[5]
     - Read action taken from argv[6] (retry|skip|escalate)
     - Append NDJSON event to EXECUTION_LOG.md
     - Output: "Failure logged"
  </action>
  <verify>node get-shit-done/bin/gsd-tools.js failure classify "Error: 429 Too Many Requests" && node get-shit-done/bin/gsd-tools.js failure backoff 0 && node get-shit-done/bin/gsd-tools.js failure backoff 3</verify>
  <done>gsd-tools.js handles failure test-retry/classify/backoff/log-failure commands with proper output</done>
</task>

<task type="auto">
  <name>Task 3: Integrate with gsd-phase-coordinator agent</name>
  <files>get-shit-done/agents/gsd-phase-coordinator.md</files>
  <action>
Update gsd-phase-coordinator.md to use failure handling:

1. In the execution step, wrap phase cycle in failure handling:
   Add instruction to use failure-handler when spawning plan executors:

   ```
   For each plan execution:
   1. Attempt execution with retry logic
   2. On transient failure (network, rate limit): auto-retry up to 3 times
   3. On permanent failure: log failure, present options to coordinator
   4. Options: retry (manual), skip (mark incomplete), escalate (halt roadmap)
   ```

2. Add failure handling decision tree:
   ```
   If plan execution fails:
     Check: Is error retryable? (ECONNRESET, 429, 503, etc.)
       Yes -> Auto-retry with exponential backoff
       No -> Present choice to user/coordinator:
         - RETRY: Try again (user believes transient)
         - SKIP: Mark plan incomplete, continue to next
         - ESCALATE: Stop roadmap execution, require human intervention
   ```

3. Add failure logging integration:
   After any failure (whether retried, skipped, or escalated):
   ```bash
   node gsd-tools.js failure log-failure ${PHASE} "${ERROR}" ${ACTION}
   ```

4. Update return state to include failure information:
   ```yaml
   return_state:
     status: "completed" | "failed" | "skipped"
     failures:
       - phase: N
         error: "message"
         action: "retry" | "skip" | "escalate"
         retries: N
   ```

Note: Integrate smoothly with existing coordinator flow. Do not remove existing checkpoint/verification logic.
  </action>
  <verify>grep -c "retry\|skip\|escalate" /Users/ollorin/.claude/get-shit-done/agents/gsd-phase-coordinator.md | [ $(cat) -ge 3 ] && echo "Failure handling found in coordinator"</verify>
  <done>gsd-phase-coordinator.md includes failure handling with retry/skip/escalate decision tree and failure logging</done>
</task>

</tasks>

<verification>
1. Module load test:
   node -e "require('./get-shit-done/bin/failure-handler.js')" && echo "failure-handler.js loads"

2. Retry classification test:
   node get-shit-done/bin/gsd-tools.js failure classify "ECONNRESET"  # Should be retryable
   node get-shit-done/bin/gsd-tools.js failure classify "SyntaxError"  # Should not be retryable

3. Backoff calculation test:
   node get-shit-done/bin/gsd-tools.js failure backoff 0  # ~1000ms
   node get-shit-done/bin/gsd-tools.js failure backoff 1  # ~2000ms
   node get-shit-done/bin/gsd-tools.js failure backoff 2  # ~4000ms
   node get-shit-done/bin/gsd-tools.js failure backoff 5  # Should cap at ~30000ms

4. Coordinator integration check:
   grep "retry\|skip\|escalate" ~/.claude/get-shit-done/agents/gsd-phase-coordinator.md
</verification>

<success_criteria>
- FailureHandler class created with isRetryable/calculateBackoff/executeWithRetry methods
- gsd-tools.js handles failure test-retry/classify/backoff/log-failure commands
- gsd-phase-coordinator.md includes retry/skip/escalate decision tree
- Exponential backoff with jitter prevents thundering herd
- Failure events logged to EXECUTION_LOG.md with NDJSON format
</success_criteria>

<output>
After completion, create `.planning/phases/07-autonomous-execution-optimization/07-02-SUMMARY.md`
</output>
