---
phase: 11-session-end-knowledge-extraction
plan: 04
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - get-shit-done/bin/gsd-tools.js
autonomous: true

must_haves:
  truths:
    - "User can manually trigger session analysis on any session file via CLI command"
    - "User can view analysis status showing how many sessions analyzed, insights extracted, and estimated Haiku costs"
    - "Cost tracking reports cumulative Haiku API usage for session analysis"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "CLI commands: analyze-session, analysis-status"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js"
      to: "get-shit-done/bin/session-knowledge-writer.js"
      via: "require import for analyzeAndStoreSession"
      pattern: "require.*session-knowledge-writer"
    - from: "get-shit-done/bin/gsd-tools.js"
      to: ".planning/analysis-tracking.json"
      via: "reads tracking file for status report"
      pattern: "analysis-tracking\\.json"
---

<objective>
Add CLI commands to gsd-tools for manual session analysis and status reporting, providing user visibility into extraction results and costs.

Purpose: Users need ability to manually analyze specific sessions (archived or current), view what the system has learned, and monitor Haiku API costs for budget control.

Output: Two new gsd-tools commands integrated into the existing CLI.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-session-end-knowledge-extraction-implement-haiku-based-analysis-of-completed-sessions-to-extract-reasoning-patterns-and-decisions-beyond-keyword-matching/11-RESEARCH.md
@.planning/phases/11-session-end-knowledge-extraction-implement-haiku-based-analysis-of-completed-sessions-to-extract-reasoning-patterns-and-decisions-beyond-keyword-matching/11-01-SUMMARY.md
@.planning/phases/11-session-end-knowledge-extraction-implement-haiku-based-analysis-of-completed-sessions-to-extract-reasoning-patterns-and-decisions-beyond-keyword-matching/11-02-SUMMARY.md
@get-shit-done/bin/gsd-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analyze-session command to gsd-tools</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add two new commands to the gsd-tools.js CLI command dispatcher (follow existing pattern for adding commands - find the switch/case or if/else command routing section).

**Command 1: `analyze-session <path> [--force]`**
- Usage: `node gsd-tools.js analyze-session .planning/telegram-sessions/abc123.jsonl`
- Also accepts: `node gsd-tools.js analyze-session --all` to analyze all unanalyzed sessions in `.planning/telegram-sessions/`
- Steps:
  1. Lazy-load session-knowledge-writer: `const writer = require('./session-knowledge-writer.js');`
  2. If `--all` flag: discover all `.jsonl` files in `.planning/telegram-sessions/`, run `analyzeAndStoreSession` on each, report aggregate results
  3. If path provided: validate file exists, run `analyzeAndStoreSession(path, { force: hasForceFlag })`
  4. If `--force` flag: skip the `isAlreadyAnalyzed` check (re-analyze even if previously done)
  5. Output JSON result to stdout: `{ analyzed, sessionId, insightCount, storeResults }`
  6. On error, output `{ error: message }` and exit 1

**Command 2: `analysis-status`**
- Usage: `node gsd-tools.js analysis-status`
- Steps:
  1. Read `.planning/analysis-tracking.json` (if exists)
  2. Count total sessions analyzed, total insights extracted
  3. Calculate estimated Haiku costs:
     - Read tracking entries, sum insight counts
     - Estimate: avg 500 input tokens per session, 1000 output tokens per session (conservative)
     - Cost: input_tokens * $1/1M + output_tokens * $5/1M per session analyzed
     - Note: these are rough estimates since we track counts, not exact tokens
  4. Count pending sessions (`.planning/telegram-sessions/*.jsonl` files not in tracking)
  5. Output formatted report:
     ```
     Session Analysis Status
     ─────────────────────────
     Sessions analyzed:  {N}
     Total insights:     {N}
     Pending sessions:   {N}
     Est. Haiku cost:    ${X.XX}

     Recent analyses:
       {session_id} - {date} - {N} insights
       ...
     ```
  6. With `--json` flag, output raw JSON instead

**Integration pattern:** Follow the existing command registration pattern in gsd-tools.js. Look for where other commands are registered (likely a large switch/case or if/else chain) and add these two commands. Use the same error handling and output patterns as existing commands.

Keep the lazy-loading approach — do NOT add top-level require statements for the new modules. Only load them when the specific command is invoked.
  </action>
  <verify>
Run `node /Users/ollorin/get-shit-done/get-shit-done/bin/gsd-tools.js analysis-status 2>/dev/null` — should output the status report (may show 0 sessions analyzed if none yet).
Run `node /Users/ollorin/get-shit-done/get-shit-done/bin/gsd-tools.js analyze-session --help 2>/dev/null || node /Users/ollorin/get-shit-done/get-shit-done/bin/gsd-tools.js analyze-session 2>/dev/null` — should not crash (may show usage or error for missing path).
  </verify>
  <done>Two CLI commands operational: `analyze-session` for manual/batch analysis with force option, `analysis-status` for reporting analyzed session count, insight count, estimated costs, and pending sessions.</done>
</task>

</tasks>

<verification>
1. `analysis-status` command runs without errors and shows formatted output
2. `analyze-session` command accepts file path argument and processes it
3. `analyze-session --all` discovers sessions in the telegram-sessions directory
4. `--json` flag on analysis-status outputs machine-readable JSON
5. Lazy loading prevents import errors when modules not yet built
</verification>

<success_criteria>
Users have CLI access to manually trigger session analysis and monitor the system's analysis activity and costs. Commands follow existing gsd-tools patterns and integrate cleanly with the command dispatcher.
</success_criteria>

<output>
After completion, create `.planning/phases/11-session-end-knowledge-extraction-implement-haiku-based-analysis-of-completed-sessions-to-extract-reasoning-patterns-and-decisions-beyond-keyword-matching/11-04-SUMMARY.md`
</output>
