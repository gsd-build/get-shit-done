---
phase: 01-auto-mode-foundation
plan: 08
type: execute
wave: 2
depends_on: ["01-07"]
files_modified:
  - ~/.claude/get-shit-done/bin/gsd-tools.js
  - /Users/ollorin/get-shit-done/get-shit-done/bin/gsd-tools.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Model selection adjusts based on remaining quota — high quota pressure downgrades expensive models"
    - "At >80% quota consumption, opus selections downgrade to sonnet"
    - "At >95% quota consumption, sonnet selections additionally downgrade to haiku"
    - "routing match-with-quota CLI command returns quota-adjusted model with reason explaining adjustment"
    - "Quota-unaware paths remain unchanged — selectModelFromRules() still works without quota parameter"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/gsd-tools.js"
      provides: "selectModelFromRulesWithQuota() function + routing match-with-quota subcommand"
      contains: "selectModelFromRulesWithQuota"
    - path: "/Users/ollorin/get-shit-done/get-shit-done/bin/gsd-tools.js"
      provides: "Mirror of above — project copy kept in sync"
      contains: "selectModelFromRulesWithQuota"
  key_links:
    - from: "selectModelFromRulesWithQuota()"
      to: "selectModelFromRules()"
      via: "calls base function then applies quota adjustment"
      pattern: "selectModelFromRules.*then|baseSelection.*quotaPercent"
    - from: "selectModelFromRulesWithQuota()"
      to: "loadQuotaState()"
      via: "reads quota state to compute usage percentage"
      pattern: "loadQuotaState|quotaState"
    - from: "cmdRoutingMatchWithQuota()"
      to: "selectModelFromRulesWithQuota()"
      via: "routing match-with-quota CLI subcommand"
      pattern: "match-with-quota"
---

<objective>
Wire quota state into model selection so that approaching quota limits conserve token budget by preferring cheaper models.

Purpose: AUTO-09 requires routing to adjust based on remaining quota. The quota tracking system (loadQuotaState, checkQuotaWarning) and routing system (selectModelFromRules, computeComplexityScore) exist independently. This plan connects them via `selectModelFromRulesWithQuota()` — a thin wrapper that applies quota pressure on top of the complexity-scored selection from plan 07.

Output: `selectModelFromRulesWithQuota()` function and `routing match-with-quota` CLI command in both gsd-tools.js files.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/ollorin/get-shit-done/.planning/STATE.md
@/Users/ollorin/get-shit-done/.planning/phases/01-auto-mode-foundation/01-CONTEXT.md
@/Users/ollorin/get-shit-done/.planning/phases/01-auto-mode-foundation/01-07-SUMMARY.md
@/Users/ollorin/get-shit-done/.planning/phases/01-auto-mode-foundation/01-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selectModelFromRulesWithQuota() to both gsd-tools.js files</name>
  <files>
    ~/.claude/get-shit-done/bin/gsd-tools.js
    /Users/ollorin/get-shit-done/get-shit-done/bin/gsd-tools.js
  </files>
  <action>
In both gsd-tools.js files, locate the routing section. After the `selectModelFromRules()` function (around line 7622 after plan 07's additions), insert a new `selectModelFromRulesWithQuota()` function.

**The function:**
```javascript
function selectModelFromRulesWithQuota(taskDesc, rules, quotaState) {
  // Get base selection using complexity scoring (from plan 07)
  const baseSelection = selectModelFromRules(taskDesc, rules);

  if (!quotaState || !quotaState.session) {
    return baseSelection;  // No quota state — pass through unchanged
  }

  const sessionLimit = quotaState.session.tokens_limit || 0;
  if (sessionLimit === 0) {
    return baseSelection;  // Unknown limit — pass through
  }

  const sessionUsed = quotaState.session.tokens_used || 0;
  const quotaPercent = (sessionUsed / sessionLimit) * 100;

  // Apply downgrade ladder based on quota pressure
  // Per user decision: quota logic in sub-coordinator, but the routing function
  // must support quota-aware selection so coordinators can call it
  if (quotaPercent > 95) {
    // Critical: downgrade any model to haiku to conserve what remains
    if (baseSelection.model === 'opus' || baseSelection.model === 'sonnet') {
      return {
        ...baseSelection,
        model: 'haiku',
        reason: `quota-adjusted (${quotaPercent.toFixed(1)}% used, >95% threshold): conserving to haiku — original: ${baseSelection.model}`,
        quota_adjusted: true,
        quota_percent: quotaPercent
      };
    }
  } else if (quotaPercent > 80) {
    // High pressure: downgrade opus to sonnet only
    if (baseSelection.model === 'opus') {
      return {
        ...baseSelection,
        model: 'sonnet',
        reason: `quota-adjusted (${quotaPercent.toFixed(1)}% used, >80% threshold): downgraded opus→sonnet — original reason: ${baseSelection.reason}`,
        quota_adjusted: true,
        quota_percent: quotaPercent
      };
    }
  }

  // No adjustment needed
  return {
    ...baseSelection,
    quota_adjusted: false,
    quota_percent: quotaPercent
  };
}
```

**Then add `cmdRoutingMatchWithQuota()` function** (after `cmdRoutingMatch()`):
```javascript
function cmdRoutingMatchWithQuota(cwd, taskDesc, raw) {
  if (!taskDesc) { error('task description required'); return; }

  const HOME = require('os').homedir();
  const globalRules = loadRoutingRules(path.join(HOME, '.claude', 'routing-rules.md'));
  const projectRules = loadRoutingRules(path.join(cwd, '.planning', 'routing', 'project-rules.md'));
  const merged = mergeRoutingRules(globalRules, projectRules);

  const quotaState = loadQuotaState(cwd);
  const result = selectModelFromRulesWithQuota(taskDesc, merged, quotaState);

  output(result, raw);
}
```

**Then update the routing case handler** in the `main()` switch statement (around line 9765):
Add `match-with-quota` subcommand handling inside the `case 'routing':` block:
```javascript
} else if (subcommand === 'match-with-quota') {
  cmdRoutingMatchWithQuota(cwd, args.slice(2).join(' '), raw);
```
Update the error message to include the new subcommand:
```
'Unknown routing subcommand. Available: match, match-with-quota, context, full, index-build, index-refresh'
```

Apply identical changes to BOTH files:
- `~/.claude/get-shit-done/bin/gsd-tools.js`
- `/Users/ollorin/get-shit-done/get-shit-done/bin/gsd-tools.js`
  </action>
  <verify>
```bash
# Test with no quota pressure (should return same as regular match)
node ~/.claude/get-shit-done/bin/gsd-tools.js routing match-with-quota "design distributed caching architecture" --json
# Expected: model = opus (high complexity), quota_adjusted: false

# Test quota-aware behavior by directly checking the function exists
grep "selectModelFromRulesWithQuota" ~/.claude/get-shit-done/bin/gsd-tools.js | wc -l
# Expected: >= 3 lines (definition + call in cmd + call in switch)

# Test the command runs without error on both files
node /Users/ollorin/get-shit-done/get-shit-done/bin/gsd-tools.js routing match-with-quota "fix typo" --json
# Expected: valid JSON with model, score, quota_adjusted fields
```
  </verify>
  <done>
- `selectModelFromRulesWithQuota()` function exists in both gsd-tools.js files
- `cmdRoutingMatchWithQuota()` function exists in both files
- `routing match-with-quota` subcommand works in both files
- Function returns `quota_adjusted: true` with adjusted model when quota exceeds thresholds
- Function returns `quota_adjusted: false` with original model when quota is below thresholds
- Original `selectModelFromRules()` and `routing match` commands unchanged
  </done>
</task>

</tasks>

<verification>
```bash
# Verify both files have the new function
grep -c "selectModelFromRulesWithQuota" ~/.claude/get-shit-done/bin/gsd-tools.js
grep -c "selectModelFromRulesWithQuota" /Users/ollorin/get-shit-done/get-shit-done/bin/gsd-tools.js
# Both: >= 3

# Verify subcommand is registered
grep "match-with-quota" ~/.claude/get-shit-done/bin/gsd-tools.js
# Should show the case handler line

# Run both copies — should produce valid JSON
node ~/.claude/get-shit-done/bin/gsd-tools.js routing match-with-quota "implement authentication" --json
node /Users/ollorin/get-shit-done/get-shit-done/bin/gsd-tools.js routing match-with-quota "implement authentication" --json
```
</verification>

<success_criteria>
AUTO-09 satisfied: Quota state is read and applied to model selection — models downgrade under quota pressure (>80% → opus to sonnet; >95% → all to haiku).
`selectModelFromRulesWithQuota()` wraps `selectModelFromRules()` without breaking existing callers.
`routing match-with-quota` CLI subcommand available in both gsd-tools.js copies.
</success_criteria>

<output>
After completion, create `/Users/ollorin/get-shit-done/.planning/phases/01-auto-mode-foundation/01-08-SUMMARY.md`
</output>
