---
phase: 09-hook-based-documentation-compression
plan: 03
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/bin/token-monitor.js
  - get-shit-done/bin/compression/metrics.js
autonomous: true

must_haves:
  truths:
    - "gsd-tools provides compression CLI commands (status, enable, disable, metrics)"
    - "TokenBudgetMonitor triggers compression recommendations at 80% utilization"
    - "Compression metrics are tracked and reportable (tokens saved, files compressed)"
    - "Compression integrates with existing Phase 7 token monitoring"
  artifacts:
    - path: "get-shit-done/bin/compression/metrics.js"
      provides: "CompressionMetrics class for tracking and reporting"
      exports: ["CompressionMetrics"]
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "compression subcommands"
      contains: "case 'compression':"
  key_links:
    - from: "get-shit-done/bin/token-monitor.js"
      to: "get-shit-done/bin/compression/metrics.js"
      via: "compression recommendation"
      pattern: "shouldCompressContext|estimateCompressionBenefit"
    - from: "get-shit-done/bin/gsd-tools.js"
      to: "get-shit-done/bin/compression/metrics.js"
      via: "CLI reporting"
      pattern: "CompressionMetrics"
---

<objective>
Integrate documentation compression with gsd-tools CLI and Phase 7 TokenBudgetMonitor.

Purpose: Enable CLI control over compression (enable/disable/status) and integrate with token monitoring to trigger compression recommendations when context usage is high.

Output: gsd-tools compression commands, metrics module, and TokenBudgetMonitor integration.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-RESEARCH.md
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-01-SUMMARY.md
@get-shit-done/bin/token-monitor.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CompressionMetrics module</name>
  <files>get-shit-done/bin/compression/metrics.js</files>
  <action>
    Create `get-shit-done/bin/compression/metrics.js` for tracking compression statistics:

    **Class: CompressionMetrics**
    - Constructor: `constructor(metricsPath)` - path to JSONL metrics file
    - Method: `record(originalPath, originalTokens, compressedTokens, strategy)` - append record
    - Method: `getStats()` - aggregated statistics
    - Method: `getHistory(limit = 50)` - recent compression records
    - Method: `clear()` - reset metrics file

    **Metrics storage:**
    - Location: `.planning/.doc-compression-metrics.jsonl`
    - Each line is a JSON record:
      ```json
      {
        "timestamp": "2026-02-16T10:30:00.000Z",
        "file": "/absolute/path/to/doc.md",
        "originalTokens": 15234,
        "compressedTokens": 5420,
        "savedTokens": 9814,
        "reductionPercent": 64.4,
        "strategy": "header-extraction"
      }
      ```

    **getStats() output:**
    ```json
    {
      "totalCompressions": 45,
      "totalTokensSaved": 234567,
      "averageReduction": 62.3,
      "fileBreakdown": {
        "RESEARCH.md": { "count": 20, "avgReduction": 65.1 },
        "PLAN.md": { "count": 15, "avgReduction": 58.2 },
        "STATE.md": { "count": 10, "avgReduction": 45.0 }
      },
      "strategyBreakdown": {
        "header-extraction": { "count": 45, "avgReduction": 62.3 }
      }
    }
    ```

    **Helper function: estimateCompressionBenefit(documentPaths)**
    - Takes array of file paths
    - Estimates tokens that would be saved if all were compressed
    - Returns `{ totalSavings, paths: [{ path, estimatedSavings }] }`
    - Use 65% reduction heuristic for estimation (before actual compression)

    **Export:** `{ CompressionMetrics, estimateCompressionBenefit }`
  </action>
  <verify>
    ```bash
    cd get-shit-done && node -e "
    const { CompressionMetrics } = require('./bin/compression/metrics');
    const metrics = new CompressionMetrics('/tmp/test-metrics.jsonl');

    // Record some compressions
    metrics.record('/test/RESEARCH.md', 15000, 5000, 'header-extraction');
    metrics.record('/test/PLAN.md', 8000, 3500, 'header-extraction');
    metrics.record('/test/STATE.md', 2000, 1200, 'header-extraction');

    console.log('Stats:', JSON.stringify(metrics.getStats(), null, 2));
    console.log('');
    console.log('History:', metrics.getHistory(3));

    metrics.clear();
    "
    ```
    Should show aggregated stats and history entries.
  </verify>
  <done>CompressionMetrics tracks and reports compression statistics with file/strategy breakdowns</done>
</task>

<task type="auto">
  <name>Task 2: Extend TokenBudgetMonitor with compression integration</name>
  <files>get-shit-done/bin/token-monitor.js</files>
  <action>
    Extend the existing Phase 7 `token-monitor.js` with compression-aware methods:

    **Add to TokenBudgetMonitor class:**

    ```javascript
    /**
     * Check if compression should be triggered
     * @returns {boolean}
     */
    shouldCompressContext() {
      const utilization = this.currentUsage / this.maxTokens;
      return utilization >= ALERT_THRESHOLDS.warn; // 80% threshold
    }

    /**
     * Estimate compression benefit for document paths
     * @param {string[]} documentPaths - Paths to documentation files
     * @returns {Promise<Object>} Compression benefit estimate
     */
    async estimateCompressionBenefit(documentPaths) {
      const { estimateCompressionBenefit } = require('./compression/metrics');
      const benefit = await estimateCompressionBenefit(documentPaths);

      const newUtilization = (this.currentUsage - benefit.totalSavings) / this.maxTokens;

      return {
        ...benefit,
        currentUtilization: (this.currentUsage / this.maxTokens * 100).toFixed(1),
        projectedUtilization: (newUtilization * 100).toFixed(1),
        recommendation: benefit.totalSavings > 20000 ? 'COMPRESS' : 'SKIP'
      };
    }

    /**
     * Get compression recommendation for current state
     * @returns {Object} Recommendation with action and reasoning
     */
    getCompressionRecommendation() {
      if (!this.shouldCompressContext()) {
        return {
          action: 'NONE',
          reason: 'Token utilization below 80% threshold',
          utilization: (this.currentUsage / this.maxTokens * 100).toFixed(1) + '%'
        };
      }

      return {
        action: 'COMPRESS',
        reason: 'Token utilization at ' + (this.currentUsage / this.maxTokens * 100).toFixed(1) + '% - compression recommended',
        utilization: (this.currentUsage / this.maxTokens * 100).toFixed(1) + '%',
        estimatedSavings: '60-70% reduction on documentation files'
      };
    }
    ```

    **Update getReport() to include compression info:**
    ```javascript
    getReport() {
      return {
        // ... existing fields ...
        compression: this.getCompressionRecommendation()
      };
    }
    ```

    **No changes to exports** - existing exports remain, new methods are on class.
  </action>
  <verify>
    ```bash
    cd get-shit-done && node -e "
    const { TokenBudgetMonitor } = require('./bin/token-monitor');

    const monitor = new TokenBudgetMonitor('opus', 200000);

    // Simulate low usage
    monitor.currentUsage = 50000;
    console.log('Low usage recommendation:', monitor.getCompressionRecommendation());

    // Simulate high usage (80%+)
    monitor.currentUsage = 165000;
    console.log('High usage recommendation:', monitor.getCompressionRecommendation());

    console.log('Should compress:', monitor.shouldCompressContext());
    console.log('Full report:', JSON.stringify(monitor.getReport(), null, 2));
    "
    ```
    Should show NONE recommendation at low usage, COMPRESS at high usage.
  </verify>
  <done>TokenBudgetMonitor triggers compression recommendations at 80% utilization, provides benefit estimation</done>
</task>

<task type="auto">
  <name>Task 3: Add compression commands to gsd-tools</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
    Add `compression` subcommand to gsd-tools.js with these operations:

    **Command: `gsd-tools compression <action>`**

    **Actions:**

    **`compression status`** - Show compression configuration and statistics
    - Output JSON with: enabled, strategy, patterns, cache stats, recent metrics

    **`compression enable`** - Enable documentation compression
    - Updates hook config `compression.enabled = true`
    - Output: `{ success: true, enabled: true }`

    **`compression disable`** - Disable documentation compression
    - Updates hook config `compression.enabled = false`
    - Output: `{ success: true, enabled: false }`

    **`compression metrics`** - Show compression statistics
    - Loads CompressionMetrics
    - Output: getStats() result

    **`compression clear-cache`** - Clear compression cache
    - Deletes `.planning/.doc-compression-cache/` contents
    - Output: `{ success: true, cleared: N }` where N is number of entries cleared

    **`compression test <file_path>`** - Test compression on a file
    - Compresses file, shows before/after token counts
    - Does NOT cache (test mode)
    - Output: `{ originalTokens, compressedTokens, reductionPercent, preview }`

    **Implementation location:**
    Add after existing `switch (command)` cases around line ~600:
    ```javascript
    case 'compression':
      const compressionAction = args[0];
      switch (compressionAction) {
        case 'status':
          // ...
        case 'enable':
          // ...
        // etc.
      }
      break;
    ```

    **Add to COMMANDS help section:**
    ```
    compression status      Show compression status and configuration
    compression enable      Enable documentation compression
    compression disable     Disable documentation compression
    compression metrics     Show compression statistics
    compression clear-cache Clear compression cache
    compression test <path> Test compression on a file
    ```
  </action>
  <verify>
    ```bash
    cd get-shit-done

    # Test status
    node bin/gsd-tools.js compression status
    # Should show enabled state, patterns, etc.

    # Test enable/disable
    node bin/gsd-tools.js compression disable
    node bin/gsd-tools.js compression status | jq '.enabled'
    # Should show false

    node bin/gsd-tools.js compression enable
    node bin/gsd-tools.js compression status | jq '.enabled'
    # Should show true

    # Test compression test
    node bin/gsd-tools.js compression test ../.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-RESEARCH.md
    # Should show token counts and reduction percentage
    ```
  </verify>
  <done>gsd-tools provides compression CLI commands for status, enable/disable, metrics, cache management, and testing</done>
</task>

</tasks>

<verification>
Full integration test combining metrics, token monitoring, and CLI:

```bash
cd get-shit-done && node -e "
const { TokenBudgetMonitor } = require('./bin/token-monitor');
const { CompressionMetrics } = require('./bin/compression/metrics');
const { HeaderExtractor } = require('./bin/compression/header-extractor');
const { TokenEstimator } = require('./bin/compression/token-estimator');
const fs = require('fs');
const path = require('path');

// Simulate high usage scenario
const monitor = new TokenBudgetMonitor('opus', 200000);
monitor.currentUsage = 170000; // 85% usage

console.log('=== Token Monitor State ===');
console.log('Should compress:', monitor.shouldCompressContext());
console.log('Recommendation:', monitor.getCompressionRecommendation());

// Test actual compression
const researchPath = path.resolve('../.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-RESEARCH.md');
const content = fs.readFileSync(researchPath, 'utf-8');

const extractor = new HeaderExtractor();
const estimator = new TokenEstimator();

const compressed = extractor.compress(content, researchPath);
const metrics = estimator.compareTokens(content, compressed);

console.log('');
console.log('=== Compression Test ===');
console.log('Original tokens:', metrics.original);
console.log('Compressed tokens:', metrics.compressed);
console.log('Reduction:', metrics.reductionPercent.toFixed(1) + '%');

// Record metrics
const metricsTracker = new CompressionMetrics('/tmp/test-integration-metrics.jsonl');
metricsTracker.record(researchPath, metrics.original, metrics.compressed, 'header-extraction');
console.log('');
console.log('=== Metrics Stats ===');
console.log(JSON.stringify(metricsTracker.getStats(), null, 2));
"

# Also verify CLI works
echo ""
echo "=== CLI Test ==="
node bin/gsd-tools.js compression status
```

Expected: All components work together - monitor recommends compression, metrics track results.
</verification>

<success_criteria>
- CompressionMetrics tracks and reports compression statistics
- TokenBudgetMonitor integrates compression recommendations at 80% threshold
- gsd-tools compression commands work (status, enable, disable, metrics, clear-cache, test)
- All components integrate cleanly with existing Phase 7 infrastructure
- JSON output format consistent across all commands
</success_criteria>

<output>
After completion, create `.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-03-SUMMARY.md`
</output>
