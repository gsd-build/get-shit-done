---
phase: 09-hook-based-documentation-compression
plan: 04
type: execute
wave: 3
depends_on: ["09-01", "09-02", "09-03"]
files_modified:
  - ~/.claude/get-shit-done/bin/hooks/config.js
  - ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js
  - ~/.claude/get-shit-done/bin/gsd-tools.js
autonomous: true

must_haves:
  truths:
    - "Circuit breaker disables compression after 3 consecutive failures"
    - "Circuit breaker auto-resets after 5 minutes"
    - "gsd-tools provides compression enable/disable/status commands"
    - "Compression metrics tracked and reportable"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/hooks/config.js"
      provides: "Circuit breaker state management"
      contains: "circuit_breaker"
    - path: "~/.claude/get-shit-done/bin/gsd-tools.js"
      provides: "CLI commands for compression control"
      contains: "compress enable"
  key_links:
    - from: "doc-compression-hook.js"
      to: "config.js"
      via: "checkCircuitBreaker / recordFailure"
      pattern: "circuitBreaker"
    - from: "gsd-tools.js"
      to: "config.js"
      via: "saveHookConfig"
      pattern: "compression.*enable"
---

<objective>
Add circuit breaker safety mechanism and CLI controls for documentation compression.

Purpose: Ensure compression failures don't block all documentation access; provide user control over compression.
Output: Circuit breaker in hook, CLI commands for compression management, metrics tracking.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-RESEARCH.md

Reference prior plan SUMMARYs:
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-01-SUMMARY.md
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-03-SUMMARY.md

Note: 09-03 implements the compression cache (CompressionCache class). The clear-cache command in this plan clears that cache.

FUTURE WORK (Phase 9.1):
- TokenBudgetMonitor integration at 80% threshold to trigger aggressive compression
- This is documented as future scope, not implemented in Phase 9
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add circuit breaker to hook configuration</name>
  <files>~/.claude/get-shit-done/bin/hooks/config.js</files>
  <action>
  Extend hooks/config.js with circuit breaker state management:

  1. **Update DEFAULT_HOOK_CONFIG** to include circuit breaker settings:
  ```javascript
  compression: {
    // ... existing settings ...
    circuit_breaker: {
      enabled: true,
      failure_threshold: 3,      // Disable after 3 consecutive failures
      reset_timeout: 300,        // Re-enable after 5 minutes (300 seconds)
      state: 'closed',           // closed (normal) | open (disabled) | half-open (testing)
      failure_count: 0,
      last_failure: null,
      opened_at: null
    }
  }
  ```

  2. **checkCircuitBreaker()** function:
     - Returns true if compression should proceed
     - Returns false if circuit is open (disabled)
     - Handles half-open state (allow one test request)
     - Auto-resets if reset_timeout elapsed

  3. **recordSuccess()** function:
     - Resets failure_count to 0
     - Sets state to 'closed' if was half-open

  4. **recordFailure()** function:
     - Increments failure_count
     - Opens circuit if threshold reached
     - Sets opened_at timestamp

  5. **getCircuitBreakerStatus()** function:
     - Returns current state with remaining reset time

  State file: ~/.claude/get-shit-done/compression-state.json (separate from config)
  </action>
  <verify>
  ```bash
  node -e "
    const { checkCircuitBreaker, recordFailure, getCircuitBreakerStatus } = require('$HOME/.claude/get-shit-done/bin/hooks/config');
    console.log('Initial status:', getCircuitBreakerStatus());
    // Simulate failures
    recordFailure();
    recordFailure();
    recordFailure();
    console.log('After 3 failures:', getCircuitBreakerStatus());
    console.log('Should proceed:', checkCircuitBreaker());
  "
  ```
  </verify>
  <done>Circuit breaker opens after 3 failures, checkCircuitBreaker returns false when open</done>
</task>

<task type="auto">
  <name>Task 2: Integrate circuit breaker into hook</name>
  <files>~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js</files>
  <action>
  Update doc-compression-hook.js to use circuit breaker:

  1. Import circuit breaker functions:
  ```javascript
  const { loadHookConfig, matchesPattern, checkCircuitBreaker, recordSuccess, recordFailure } = require('./config');
  ```

  2. Add circuit breaker check early in main():
  ```javascript
  // Check circuit breaker BEFORE attempting compression
  if (!checkCircuitBreaker()) {
    // Circuit open - pass through
    process.exit(0);
  }
  ```

  3. Record success after successful compression:
  ```javascript
  const { summary } = extractor.extractSummary(content, absolutePath);
  recordSuccess();  // Reset failure count
  ```

  4. Record failure in catch block:
  ```javascript
  catch (error) {
    recordFailure();
    console.error('Compression failed:', error.message);
    process.exit(0);  // Pass through on error
  }
  ```

  5. Add metadata about circuit breaker state:
  ```javascript
  const result = {
    additionalContext: summary,
    metadata: {
      originalPath: absolutePath,
      compressionRatio: reductionPercent,
      circuitBreaker: getCircuitBreakerStatus().state
    }
  };
  ```
  </action>
  <verify>
  ```bash
  # Test normal operation
  echo '{"tool": "Read", "parameters": {"file_path": "'$HOME'/get-shit-done/.planning/ROADMAP.md"}}' | node ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js | jq '.metadata.circuitBreaker'
  ```
  </verify>
  <done>Hook checks circuit breaker before compression, records success/failure, includes state in metadata</done>
</task>

<task type="auto">
  <name>Task 3: Add compression CLI commands to gsd-tools</name>
  <files>~/.claude/get-shit-done/bin/gsd-tools.js</files>
  <action>
  Add compression management commands to gsd-tools.js:

  1. **compress status** - Show compression configuration and circuit breaker state:
  ```javascript
  function cmdCompressStatus(raw) {
    const { loadHookConfig, getCircuitBreakerStatus } = require('./hooks/config');
    const config = loadHookConfig();
    const cbStatus = getCircuitBreakerStatus();

    output({
      enabled: config.compression.enabled,
      strategy: config.compression.strategy,
      min_file_lines: config.compression.min_file_lines,
      circuit_breaker: cbStatus
    }, raw);
  }
  ```

  2. **compress enable** - Enable compression:
  ```javascript
  function cmdCompressEnable(raw) {
    const { loadHookConfig, saveHookConfig } = require('./hooks/config');
    const config = loadHookConfig();
    config.compression.enabled = true;
    saveHookConfig(config);
    output({ enabled: true, message: 'Compression enabled' }, raw);
  }
  ```

  3. **compress disable** - Disable compression:
  ```javascript
  function cmdCompressDisable(raw) {
    const { loadHookConfig, saveHookConfig } = require('./hooks/config');
    const config = loadHookConfig();
    config.compression.enabled = false;
    saveHookConfig(config);
    output({ enabled: false, message: 'Compression disabled' }, raw);
  }
  ```

  4. **compress reset** - Reset circuit breaker:
  ```javascript
  function cmdCompressReset(raw) {
    const { resetCircuitBreaker } = require('./hooks/config');
    resetCircuitBreaker();
    output({ message: 'Circuit breaker reset to closed state' }, raw);
  }
  ```

  5. **compress metrics** - Show compression statistics (if metrics file exists):
  ```javascript
  function cmdCompressMetrics(raw) {
    const metricsPath = path.join(HOME, '.claude', 'get-shit-done', 'compression-metrics.jsonl');
    if (!fs.existsSync(metricsPath)) {
      output({ count: 0, message: 'No compression metrics yet' }, raw);
      return;
    }
    // Parse JSONL and aggregate stats
    const lines = fs.readFileSync(metricsPath, 'utf-8').trim().split('\n');
    const records = lines.map(l => JSON.parse(l));
    const avgReduction = records.reduce((sum, r) => sum + parseFloat(r.reductionPercent), 0) / records.length;
    output({
      count: records.length,
      avgReduction: avgReduction.toFixed(1),
      totalTokensSaved: records.reduce((sum, r) => sum + (r.originalTokens - r.compressedTokens), 0)
    }, raw);
  }
  ```

  6. **compress clear-cache** - Clear compression cache (uses CompressionCache from 09-03):
  ```javascript
  function cmdCompressClearCache(raw) {
    const { CompressionCache } = require('./hooks/compression-cache');
    const cache = new CompressionCache();
    const statsBefore = cache.stats();
    cache.clear();
    output({
      message: 'Compression cache cleared',
      entriesCleared: statsBefore.entries,
      bytesFreed: statsBefore.totalSize
    }, raw);
  }
  ```

  Add command routing:
  ```javascript
  if (command === 'compress') {
    if (subCommand === 'summary') { cmdCompressSummary(args[2], args.includes('--raw')); }
    else if (subCommand === 'status') { cmdCompressStatus(raw); }
    else if (subCommand === 'enable') { cmdCompressEnable(raw); }
    else if (subCommand === 'disable') { cmdCompressDisable(raw); }
    else if (subCommand === 'reset') { cmdCompressReset(raw); }
    else if (subCommand === 'metrics') { cmdCompressMetrics(raw); }
    else if (subCommand === 'clear-cache') { cmdCompressClearCache(raw); }
    else { error('Unknown compress subcommand: ' + subCommand); }
  }
  ```
  </action>
  <verify>
  ```bash
  # Test all commands
  node ~/.claude/get-shit-done/bin/gsd-tools.js compress status
  node ~/.claude/get-shit-done/bin/gsd-tools.js compress enable
  node ~/.claude/get-shit-done/bin/gsd-tools.js compress disable
  node ~/.claude/get-shit-done/bin/gsd-tools.js compress reset
  node ~/.claude/get-shit-done/bin/gsd-tools.js compress metrics
  ```
  </verify>
  <done>All compress subcommands work: status, enable, disable, reset, metrics, clear-cache</done>
</task>

</tasks>

<verification>
Run the following to verify the complete implementation:

```bash
# 1. Test circuit breaker state management
node -e "
  const cfg = require('$HOME/.claude/get-shit-done/bin/hooks/config');
  console.log('Initial:', cfg.getCircuitBreakerStatus());
  cfg.recordFailure();
  cfg.recordFailure();
  cfg.recordFailure();
  console.log('After 3 failures:', cfg.getCircuitBreakerStatus());
  cfg.resetCircuitBreaker();
  console.log('After reset:', cfg.getCircuitBreakerStatus());
"

# 2. Test CLI commands
node ~/.claude/get-shit-done/bin/gsd-tools.js compress status | jq '.'
node ~/.claude/get-shit-done/bin/gsd-tools.js compress enable
node ~/.claude/get-shit-done/bin/gsd-tools.js compress status | jq '.enabled'

# 3. Test hook with circuit breaker
echo '{"tool": "Read", "parameters": {"file_path": "'$HOME'/get-shit-done/.planning/ROADMAP.md"}}' | node ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js | jq '.metadata'

# 4. Verify circuit breaker integration
node -e "
  const cfg = require('$HOME/.claude/get-shit-done/bin/hooks/config');
  // Simulate 3 failures
  cfg.recordFailure();
  cfg.recordFailure();
  cfg.recordFailure();
"
# Now hook should pass through
echo '{"tool": "Read", "parameters": {"file_path": "'$HOME'/get-shit-done/.planning/ROADMAP.md"}}' | node ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js
# Should produce no output (circuit open)

# Reset for normal operation
node ~/.claude/get-shit-done/bin/gsd-tools.js compress reset
```

Expected:
- Circuit breaker opens after 3 failures
- Hook passes through when circuit open
- CLI commands control compression state
- Status shows circuit breaker state
</verification>

<success_criteria>
1. Circuit breaker disables compression after 3 consecutive failures
2. Circuit breaker auto-resets after 5 minutes (reset_timeout)
3. Hook checks circuit breaker before attempting compression
4. Hook records success/failure to circuit breaker
5. `compress status` shows enabled state and circuit breaker state
6. `compress enable/disable` toggles compression
7. `compress reset` resets circuit breaker to closed state
8. `compress metrics` shows aggregated compression statistics
</success_criteria>

<output>
After completion, create `.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-04-SUMMARY.md`
</output>
