---
phase: 09-hook-based-documentation-compression
plan: 04
type: execute
wave: 3
depends_on: [09-02, 09-03]
files_modified:
  - get-shit-done/bin/hooks/circuit-breaker.js
  - ~/.claude/settings.json
  - get-shit-done/bin/install.js
autonomous: true

must_haves:
  truths:
    - "Circuit breaker disables compression after 3 consecutive failures"
    - "Circuit breaker auto-resets after 5 minutes"
    - "Hook is registered in Claude Code settings.json"
    - "Installer updates settings.json with compression hook"
  artifacts:
    - path: "get-shit-done/bin/hooks/circuit-breaker.js"
      provides: "CircuitBreaker class for hook failure protection"
      exports: ["CircuitBreaker"]
    - path: "~/.claude/settings.json"
      provides: "PreToolUse hook registration for Read tool"
      contains: "doc-compression-hook"
  key_links:
    - from: "get-shit-done/bin/hooks/doc-compression-hook.js"
      to: "get-shit-done/bin/hooks/circuit-breaker.js"
      via: "failure tracking"
      pattern: "circuitBreaker\\.(recordFailure|isOpen)"
    - from: "~/.claude/settings.json"
      to: "get-shit-done/bin/hooks/doc-compression-hook.js"
      via: "hook command registration"
      pattern: "doc-compression-hook"
---

<objective>
Add circuit breaker safety and register the compression hook with Claude Code.

Purpose: Protect against hook failures breaking all documentation access (Pitfall 5 from research). Register the hook in settings.json so Claude Code invokes it on Read operations.

Output: Circuit breaker module, settings.json hook registration, and installer updates.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-RESEARCH.md
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-02-SUMMARY.md
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CircuitBreaker module</name>
  <files>get-shit-done/bin/hooks/circuit-breaker.js</files>
  <action>
    Create `get-shit-done/bin/hooks/circuit-breaker.js` for hook failure protection:

    **Class: CircuitBreaker**
    - Constructor: `constructor(options = {})` with `{ failureThreshold = 3, resetTimeout = 300000 }`
    - Method: `recordSuccess()` - reset failure count
    - Method: `recordFailure(error)` - increment failure count, track error
    - Method: `isOpen()` - returns true if circuit is tripped (failures >= threshold)
    - Method: `reset()` - force reset circuit
    - Method: `getState()` - returns `{ state, failures, lastFailure, willResetAt }`

    **State machine:**
    ```
    CLOSED (normal) --3 failures--> OPEN (blocked) --5 min--> HALF-OPEN (test)
                                                                    |
                                              success: CLOSED  <----+
                                              failure: OPEN    <----+
    ```

    **Storage:**
    - State persisted to `.planning/.doc-compression-circuit.json`
    - Load on construction, save on state change
    - Include: `{ failures, lastFailure, openedAt, errors[] }`

    **Auto-reset logic:**
    - When `isOpen()` called and `openedAt + resetTimeout < now`:
      - Transition to HALF-OPEN
      - Next call determines: success -> CLOSED, failure -> OPEN again

    **Error logging:**
    - Keep last 10 errors in state
    - Each error: `{ message, timestamp, stack }`
    - Useful for debugging recurring issues

    **Export:** `{ CircuitBreaker }`
  </action>
  <verify>
    ```bash
    cd get-shit-done && node -e "
    const { CircuitBreaker } = require('./bin/hooks/circuit-breaker');
    const breaker = new CircuitBreaker({ failureThreshold: 3, resetTimeout: 1000 });

    console.log('Initial state:', breaker.getState());

    // Simulate failures
    breaker.recordFailure(new Error('Test error 1'));
    breaker.recordFailure(new Error('Test error 2'));
    console.log('After 2 failures (open?):', breaker.isOpen());

    breaker.recordFailure(new Error('Test error 3'));
    console.log('After 3 failures (open?):', breaker.isOpen());
    console.log('State:', breaker.getState());

    // Reset and test success
    breaker.reset();
    console.log('After reset (open?):', breaker.isOpen());

    breaker.recordSuccess();
    console.log('After success:', breaker.getState());
    "
    ```
    Should show circuit opens after 3 failures, closes after reset.
  </verify>
  <done>CircuitBreaker provides hook failure protection with configurable threshold and auto-reset</done>
</task>

<task type="auto">
  <name>Task 2: Integrate circuit breaker into doc-compression-hook</name>
  <files>get-shit-done/bin/hooks/doc-compression-hook.js</files>
  <action>
    Update `get-shit-done/bin/hooks/doc-compression-hook.js` to use CircuitBreaker:

    **Add circuit breaker check at start of processHook:**
    ```javascript
    const { CircuitBreaker } = require('./circuit-breaker');
    const breaker = new CircuitBreaker();

    async function processHook(hookData) {
      // Check circuit breaker FIRST
      if (breaker.isOpen()) {
        console.error('[doc-compression] Circuit breaker open - bypassing compression');
        return { decision: 'continue' };
      }

      try {
        // ... existing compression logic ...

        breaker.recordSuccess(); // Record success on completion
        return result;
      } catch (error) {
        breaker.recordFailure(error);
        console.error('[doc-compression] Error (recorded):', error.message);
        return { decision: 'continue' };
      }
    }
    ```

    **Environment variable override:**
    ```javascript
    // Allow disabling compression via env var for debugging
    if (process.env.GSD_DISABLE_COMPRESSION === '1') {
      console.error('[doc-compression] Disabled via GSD_DISABLE_COMPRESSION');
      return { decision: 'continue' };
    }
    ```

    **Add at top of main():**
    ```javascript
    // Quick exit checks before any processing
    if (process.env.GSD_DISABLE_COMPRESSION === '1') {
      console.log(JSON.stringify({ decision: 'continue' }));
      process.exit(0);
    }
    ```

    This ensures:
    - Circuit breaker checked before any heavy processing
    - Failures are tracked automatically
    - 3 consecutive failures disable compression (auto-resets in 5 min)
    - Environment variable provides manual override
  </action>
  <verify>
    ```bash
    cd get-shit-done

    # Test normal operation
    echo '{"tool":"Read","tool_input":{"file_path":"/Users/ollorin/get-shit-done/.planning/ROADMAP.md"}}' | node bin/hooks/doc-compression-hook.js
    # Should work normally

    # Test env var disable
    echo '{"tool":"Read","tool_input":{"file_path":"/Users/ollorin/get-shit-done/.planning/ROADMAP.md"}}' | GSD_DISABLE_COMPRESSION=1 node bin/hooks/doc-compression-hook.js
    # Should output just {"decision":"continue"}

    # Check circuit breaker state
    node -e "
    const { CircuitBreaker } = require('./bin/hooks/circuit-breaker');
    const breaker = new CircuitBreaker();
    console.log('Circuit state:', breaker.getState());
    "
    ```
  </verify>
  <done>Hook uses circuit breaker for failure protection, supports environment variable override</done>
</task>

<task type="auto">
  <name>Task 3: Register hook in Claude Code settings and update installer</name>
  <files>
    ~/.claude/settings.json
    get-shit-done/bin/install.js
  </files>
  <action>
    **Part A: Update ~/.claude/settings.json manually for immediate activation**

    Read existing settings.json and add PreToolUse hook for Read tool:

    Add to the `hooks.PreToolUse` array:
    ```json
    {
      "matcher": "Read",
      "hooks": [
        {
          "type": "command",
          "command": "node \"/Users/ollorin/.claude/get-shit-done/get-shit-done/bin/hooks/doc-compression-hook.js\""
        }
      ]
    }
    ```

    The settings.json already has a PreToolUse section with a Bash matcher. Add this Read matcher to the same array.

    **Part B: Update installer to add hook during installation**

    In `get-shit-done/bin/install.js`, add function to register compression hook:

    ```javascript
    function registerCompressionHook(settingsPath, gsdPath) {
      const settings = JSON.parse(fs.readFileSync(settingsPath, 'utf8'));

      // Ensure hooks structure exists
      settings.hooks = settings.hooks || {};
      settings.hooks.PreToolUse = settings.hooks.PreToolUse || [];

      // Check if hook already registered
      const hookCommand = `node "${gsdPath}/bin/hooks/doc-compression-hook.js"`;
      const existing = settings.hooks.PreToolUse.find(h =>
        h.matcher === 'Read' &&
        h.hooks?.some(hook => hook.command?.includes('doc-compression-hook'))
      );

      if (existing) {
        console.log('Compression hook already registered');
        return;
      }

      // Add new hook
      settings.hooks.PreToolUse.push({
        matcher: 'Read',
        hooks: [{
          type: 'command',
          command: hookCommand
        }]
      });

      fs.writeFileSync(settingsPath, JSON.stringify(settings, null, 2));
      console.log('Compression hook registered');
    }
    ```

    Call this function during the install process after copying GSD files.

    **Part C: Add uninstall/disable option**

    Add to gsd-tools.js compression commands:
    ```javascript
    case 'unregister':
      // Remove hook from settings.json
      // ...
    ```
  </action>
  <verify>
    ```bash
    # Verify settings.json has the hook
    cat ~/.claude/settings.json | jq '.hooks.PreToolUse[] | select(.matcher == "Read")'
    # Should show the Read matcher with doc-compression-hook command

    # Test hook is invoked by Claude Code (manual test)
    # In a new Claude Code session, read a RESEARCH.md file
    # Check stderr for "[doc-compression]" messages
    ```
  </verify>
  <done>Compression hook registered in settings.json, installer updated to add hook during installation</done>
</task>

</tasks>

<verification>
Full system verification:

```bash
# 1. Check circuit breaker
cd get-shit-done && node -e "
const { CircuitBreaker } = require('./bin/hooks/circuit-breaker');
const breaker = new CircuitBreaker();
console.log('Circuit breaker state:', breaker.getState());
"

# 2. Check settings.json hook registration
cat ~/.claude/settings.json | jq '.hooks.PreToolUse[] | select(.matcher == "Read")' | head -10

# 3. End-to-end hook test
echo '{"tool":"Read","tool_input":{"file_path":"/Users/ollorin/get-shit-done/.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-RESEARCH.md"}}' | node bin/hooks/doc-compression-hook.js | jq '.'

# 4. Test circuit breaker protection (simulate failures)
node -e "
const { CircuitBreaker } = require('./bin/hooks/circuit-breaker');
const breaker = new CircuitBreaker({ failureThreshold: 3, resetTimeout: 5000 });
breaker.reset(); // Start fresh

// Simulate 3 failures
for (let i = 0; i < 3; i++) {
  breaker.recordFailure(new Error('Simulated failure ' + (i+1)));
}

console.log('After 3 failures - open?', breaker.isOpen());

// Wait and check auto-reset
setTimeout(() => {
  console.log('After 5 seconds - still open?', breaker.isOpen());
  breaker.reset(); // Clean up
}, 5500);
"
```

Expected:
- Circuit breaker starts closed
- Settings.json has Read matcher with doc-compression-hook
- Hook compresses RESEARCH.md and returns additionalContext
- Circuit opens after 3 failures, resets after timeout
</verification>

<success_criteria>
- CircuitBreaker module provides configurable failure protection
- Circuit opens after 3 consecutive failures
- Circuit auto-resets after 5 minutes
- Environment variable GSD_DISABLE_COMPRESSION=1 bypasses compression
- Hook registered in ~/.claude/settings.json for Read tool
- Installer updated to register hook during installation
- All error paths gracefully fall back to normal Read behavior
</success_criteria>

<output>
After completion, create `.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-04-SUMMARY.md`
</output>
