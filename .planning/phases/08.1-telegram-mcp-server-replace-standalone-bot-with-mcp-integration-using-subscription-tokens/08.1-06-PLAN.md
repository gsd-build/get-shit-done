---
phase: 08.1-telegram-mcp-server
plan: 06
type: execute
wave: 4
depends_on: ["08.1-05"]
files_modified:
  - .claude/.mcp.json
  - .planning/config.json
  - get-shit-done/workflows/execute-plan.md
autonomous: true

must_haves:
  truths:
    - "Claude Code auto-loads telegram-mcp server via .claude/.mcp.json"
    - "GSD orchestrators detect Telegram MCP availability"
    - "Orchestrators use Telegram MCP for blocking questions when available"
    - "Graceful degradation to CLI prompt when MCP unavailable"
  artifacts:
    - path: ".claude/.mcp.json"
      provides: "Claude Code MCP server configuration"
      contains: "telegram-mcp"
    - path: ".planning/config.json"
      provides: "GSD configuration with telegram settings"
      contains: "telegram"
  key_links:
    - from: ".claude/.mcp.json"
      to: "mcp-servers/telegram-mcp/dist/index.js"
      via: "command and args"
      pattern: "telegram-mcp/dist/index\\.js"
---

<objective>
Configure Claude Code to auto-load MCP server and integrate with GSD orchestrators.

Purpose: Enable seamless Telegram notifications for blocking questions during autonomous execution. Orchestrators automatically detect and use Telegram MCP when available.

Output: Working end-to-end flow from orchestrator question to Telegram notification to user response.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-telegram-mcp-server-replace-standalone-bot-with-mcp-integration-using-subscription-tokens/08.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Claude Code MCP configuration</name>
  <files>.claude/.mcp.json</files>
  <action>
Create `.claude/.mcp.json` for Claude Code auto-loading:

```json
{
  "mcpServers": {
    "telegram": {
      "command": "node",
      "args": ["mcp-servers/telegram-mcp/dist/index.js"],
      "env": {
        "TELEGRAM_BOT_TOKEN": "${TELEGRAM_BOT_TOKEN}",
        "TELEGRAM_OWNER_ID": "${TELEGRAM_OWNER_ID}"
      }
    }
  }
}
```

Note: Environment variables use ${VAR} syntax - Claude Code expands these from the user's environment.

If `.claude/.mcp.json` already exists, merge the telegram entry into existing mcpServers object (don't overwrite other servers).

Also create/update `.planning/config.json` with Telegram settings:
```json
{
  "telegram": {
    "polling_interval_minutes": 30,
    "long_poll_timeout_seconds": 60,
    "session_log_retention_days": 90
  }
}
```
  </action>
  <verify>
```bash
cat .claude/.mcp.json | jq '.mcpServers.telegram.command'
```
Should output: "node"
  </verify>
  <done>
.claude/.mcp.json exists with telegram server config, .planning/config.json has telegram settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MCP availability detection to GSD tools</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add a function to detect if Telegram MCP is available:

1. Add to gsd-tools.js (near other utility functions):
```javascript
/**
 * Check if Telegram MCP server is available
 * @returns {Promise<{available: boolean, tools: string[]}>}
 */
async function checkTelegramMCP() {
  // Check if .claude/.mcp.json exists and has telegram config
  const mcpConfigPath = path.join(process.cwd(), '.claude', '.mcp.json');
  try {
    const config = JSON.parse(fs.readFileSync(mcpConfigPath, 'utf8'));
    if (config.mcpServers?.telegram) {
      return {
        available: true,
        tools: ['ask_blocking_question', 'check_question_answers', 'mark_question_answered']
      };
    }
  } catch {
    // Config doesn't exist or is invalid
  }
  return { available: false, tools: [] };
}
```

2. Add CLI command:
```javascript
case 'telegram-mcp':
  const subCmd = args[1];
  if (subCmd === 'status') {
    const status = await checkTelegramMCP();
    console.log(JSON.stringify(status, null, 2));
  } else {
    console.log('Usage: gsd-tools telegram-mcp status');
  }
  break;
```

3. Export the function for use by orchestrators.
  </action>
  <verify>
```bash
node get-shit-done/bin/gsd-tools.js telegram-mcp status | jq '.available'
```
Should output: true (after Plan 1-5 complete and .claude/.mcp.json exists)
  </verify>
  <done>
gsd-tools has telegram-mcp status command and exports checkTelegramMCP function.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document orchestrator integration pattern</name>
  <files>get-shit-done/workflows/execute-plan.md</files>
  <action>
Add documentation to execute-plan.md showing how to use Telegram MCP for blocking questions:

Find the section about checkpoints or blocking questions and add:

```markdown
## Telegram MCP Integration

When Telegram MCP is available (check via `gsd-tools telegram-mcp status`), use MCP tools for blocking questions instead of CLI prompts:

### Sending a Blocking Question

```javascript
// Check availability first
const { available } = await checkTelegramMCP();

if (available) {
  // Use MCP tool (Claude Code handles this automatically)
  const result = await mcp_telegram_ask_blocking_question({
    question: "Should I proceed with Phase 3?",
    context: "Planning decision for knowledge system"
  });

  // Poll for answer
  const { answers } = await mcp_telegram_check_question_answers({
    question_ids: [result.question_id],
    wait_seconds: 60
  });

  if (answers.length > 0) {
    const userAnswer = answers[0].answer;
    // Continue with answer
    await mcp_telegram_mark_question_answered({
      question_id: result.question_id
    });
  }
} else {
  // Fallback to CLI prompt
  const answer = await askUserInCLI("Should I proceed with Phase 3?");
}
```

### Graceful Degradation

Orchestrators should ALWAYS check availability and fall back gracefully. The system must work without Telegram MCP (current behavior).

### Configuration

Set environment variables:
- `TELEGRAM_BOT_TOKEN`: Bot token from @BotFather
- `TELEGRAM_OWNER_ID`: Your Telegram user ID (get via /start command)
```

Keep the existing workflow content, just add this section.
  </action>
  <verify>
```bash
grep -c "Telegram MCP Integration" get-shit-done/workflows/execute-plan.md
```
Should output: 1
  </verify>
  <done>
execute-plan.md documents Telegram MCP usage pattern with code examples.
  </done>
</task>

</tasks>

<verification>
- [ ] .claude/.mcp.json exists with telegram server configuration
- [ ] .planning/config.json has telegram settings
- [ ] gsd-tools telegram-mcp status returns availability info
- [ ] execute-plan.md documents MCP integration pattern
- [ ] Pattern shows graceful degradation when MCP unavailable
</verification>

<success_criteria>
Claude Code can auto-load Telegram MCP server. GSD tools can detect MCP availability. Orchestrator integration pattern is documented. Phase 08.1 is complete.
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-telegram-mcp-server-replace-standalone-bot-with-mcp-integration-using-subscription-tokens/08.1-06-SUMMARY.md`
</output>
