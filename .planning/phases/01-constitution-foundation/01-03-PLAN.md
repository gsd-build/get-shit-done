---
phase: 01-constitution-foundation
plan: 03
type: tdd
wave: 3
depends_on: ["01-02"]
checkpoint: after_each_task
files_modified:
  - src/constitution/init.js
  - src/constitution/__tests__/init.test.js
  - bin/install.js
  - commands/gsd/new-project.md
autonomous: true

must_haves:
  truths:
    - "Tests written BEFORE init implementation"
    - "Global CONSTITUTION.md installed to ~/.claude/get-shit-done/ during setup"
    - "Project CONSTITUTION.md created in .planning/ during /gsd:new-project"
    - "Init helpers tested with mock-fs"
  artifacts:
    - path: "src/constitution/__tests__/init.test.js"
      provides: "Init helper tests"
      contains: "describe('Constitution Init'"
      min_lines: 60
    - path: "src/constitution/init.js"
      provides: "Init helpers"
      exports: ["initGlobalConstitution", "initProjectConstitution"]
      min_lines: 40
    - path: "bin/install.js"
      provides: "Install script with constitution setup"
      contains: "CONSTITUTION.md"
  key_links:
    - from: "bin/install.js"
      to: "src/constitution/init.js"
      via: "require"
      pattern: "require.*init"
---

<objective>
Integrate constitution into GSD installation using TDD. Tests define init behavior before implementation.

Purpose: Wire templates and loader into GSD setup flows.
Output: Constitution auto-created during install/init.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md

**TDD-FIRST (MANDATORY):**
1. RED: Write tests for init helpers
2. GREEN: Implement init helpers
3. Integrate into install.js and new-project.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-constitution-foundation/01-01-SUMMARY.md
@.planning/phases/01-constitution-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write init helper tests (RED)</name>
  <files>src/constitution/__tests__/init.test.js</files>
  <action>
Write tests for init helpers BEFORE implementation.

```javascript
// src/constitution/__tests__/init.test.js
const mock = require('mock-fs');
const fs = require('fs');
const path = require('path');

const { initGlobalConstitution, initProjectConstitution } = require('../init');

const HOME = '/Users/testuser';
const TEMPLATE_DIR = `${HOME}/.claude/get-shit-done/templates/constitution`;
const GLOBAL_TEMPLATE = `${TEMPLATE_DIR}/global-constitution.md`;
const PROJECT_TEMPLATE = `${TEMPLATE_DIR}/project-constitution.md`;

describe('Constitution Init', () => {
  afterEach(() => mock.restore());

  describe('initGlobalConstitution', () => {
    test('copies template to target directory', () => {
      mock({
        [GLOBAL_TEMPLATE]: '---\nversion: "1.0.0"\nlastUpdated: "YYYY-MM-DD"\n---\n# NON-NEGOTIABLE'
      });

      const targetDir = '/target';
      mock({ ...mock.getMockRoot(), [targetDir]: {} });

      initGlobalConstitution(targetDir);

      const result = fs.readFileSync(path.join(targetDir, 'CONSTITUTION.md'), 'utf8');
      expect(result).toContain('version: "1.0.0"');
    });

    test('replaces lastUpdated with current date', () => {
      mock({
        [GLOBAL_TEMPLATE]: '---\nversion: "1.0.0"\nlastUpdated: "YYYY-MM-DD"\n---'
      });

      const targetDir = '/target';
      mock({ ...mock.getMockRoot(), [targetDir]: {} });

      initGlobalConstitution(targetDir);

      const result = fs.readFileSync(path.join(targetDir, 'CONSTITUTION.md'), 'utf8');
      const today = new Date().toISOString().split('T')[0];
      expect(result).toContain(`lastUpdated: "${today}"`);
    });

    test('returns target path', () => {
      mock({
        [GLOBAL_TEMPLATE]: '---\nversion: "1.0.0"\n---'
      });

      const targetDir = '/target';
      mock({ ...mock.getMockRoot(), [targetDir]: {} });

      const result = initGlobalConstitution(targetDir);
      expect(result).toBe(path.join(targetDir, 'CONSTITUTION.md'));
    });
  });

  describe('initProjectConstitution', () => {
    test('copies project template to target', () => {
      mock({
        [PROJECT_TEMPLATE]: '---\nversion: "1.0.0"\nlastUpdated: "YYYY-MM-DD"\n---\n# NON-NEGOTIABLE'
      });

      const targetDir = '/project/.planning';
      mock({ ...mock.getMockRoot(), [targetDir]: {} });

      initProjectConstitution(targetDir);

      const result = fs.readFileSync(path.join(targetDir, 'CONSTITUTION.md'), 'utf8');
      expect(result).toContain('version: "1.0.0"');
    });

    test('replaces lastUpdated placeholder', () => {
      mock({
        [PROJECT_TEMPLATE]: '---\nlastUpdated: "YYYY-MM-DD"\n---'
      });

      const targetDir = '/project/.planning';
      mock({ ...mock.getMockRoot(), [targetDir]: {} });

      initProjectConstitution(targetDir);

      const result = fs.readFileSync(path.join(targetDir, 'CONSTITUTION.md'), 'utf8');
      expect(result).not.toContain('YYYY-MM-DD');
    });
  });
});
```
  </action>
  <verify>
`npm test -- init.test.js` runs and FAILS (RED phase).
  </verify>
  <done>
Init tests written. Tests FAIL because init.js doesn't exist.
RED phase complete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement init helpers (GREEN)</name>
  <files>src/constitution/init.js</files>
  <action>
Implement init helpers that pass all tests.

```javascript
// src/constitution/init.js
const fs = require('fs');
const path = require('path');
const os = require('os');

function initGlobalConstitution(targetDir) {
  const templatePath = path.join(
    os.homedir(), '.claude', 'get-shit-done',
    'templates', 'constitution', 'global-constitution.md'
  );
  return _copyTemplate(templatePath, targetDir);
}

function initProjectConstitution(targetDir) {
  const templatePath = path.join(
    os.homedir(), '.claude', 'get-shit-done',
    'templates', 'constitution', 'project-constitution.md'
  );
  return _copyTemplate(templatePath, targetDir);
}

function _copyTemplate(templatePath, targetDir) {
  let content = fs.readFileSync(templatePath, 'utf8');

  // Replace date placeholder
  const today = new Date().toISOString().split('T')[0];
  content = content.replace(/lastUpdated: "YYYY-MM-DD"/, `lastUpdated: "${today}"`);

  const targetPath = path.join(targetDir, 'CONSTITUTION.md');
  fs.writeFileSync(targetPath, content, 'utf8');

  return targetPath;
}

module.exports = { initGlobalConstitution, initProjectConstitution };
```
  </action>
  <verify>
`npm test -- init.test.js` ALL tests PASS (GREEN phase).
  </verify>
  <done>
Init helpers implemented. Tests pass.
GREEN phase complete.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate into install.js</name>
  <files>bin/install.js</files>
  <action>
Read existing install.js, add constitution initialization.

Add after existing file copy operations:

```javascript
const { initGlobalConstitution } = require('../src/constitution/init');

// After other GSD files copied...

// Create global constitution at ROOT level
const gsdDir = path.join(os.homedir(), '.claude', 'get-shit-done');
const constitutionPath = initGlobalConstitution(gsdDir);
console.log(`  ${green}âœ“${reset} Global constitution: ${constitutionPath}`);
```

**CRITICAL:** Target = ~/.claude/get-shit-done/ (root level, not templates/).
Loader expects: ~/.claude/get-shit-done/CONSTITUTION.md
  </action>
  <verify>
`grep -q "initGlobalConstitution" bin/install.js`
`grep -q "CONSTITUTION.md" bin/install.js`
  </verify>
  <done>
Install script creates global constitution during GSD setup.
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate into new-project command</name>
  <files>commands/gsd/new-project.md</files>
  <action>
Read existing new-project.md, add constitution creation step.

After .planning/ directory created, add:

```bash
# Create project constitution
cp ~/.claude/get-shit-done/templates/constitution/project-constitution.md .planning/CONSTITUTION.md
sed -i '' "s/lastUpdated: \"YYYY-MM-DD\"/lastUpdated: \"$(date +%Y-%m-%d)\"/" .planning/CONSTITUTION.md
echo "Created .planning/CONSTITUTION.md"
```
  </action>
  <verify>
`grep -q "CONSTITUTION.md" commands/gsd/new-project.md`
Test: mkdir /tmp/test-proj && run new-project logic, verify .planning/CONSTITUTION.md exists.
  </verify>
  <done>
New-project command creates project constitution.
  </done>
</task>

</tasks>

<verification>
- `npm test -- init.test.js` passes
- `grep "CONSTITUTION" bin/install.js` shows integration
- `grep "CONSTITUTION" commands/gsd/new-project.md` shows integration
- Manual test: constitution files created at correct paths
</verification>

<success_criteria>
- [ ] Tests written FIRST for init helpers (RED)
- [ ] Tests FAIL before init.js exists
- [ ] Init helpers pass tests (GREEN)
- [ ] bin/install.js creates ~/.claude/get-shit-done/CONSTITUTION.md
- [ ] new-project.md creates .planning/CONSTITUTION.md
- [ ] Both use current date for lastUpdated
</success_criteria>

<output>
Create `.planning/phases/01-constitution-foundation/01-03-SUMMARY.md`
Update `.planning/STATE.md` with phase completion
</output>
