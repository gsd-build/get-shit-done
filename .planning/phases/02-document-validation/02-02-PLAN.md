---
phase: 02-document-validation
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - get-shit-done/workflows/map-codebase.md
  - commands/gsd/map-codebase.md
autonomous: true

must_haves:
  truths:
    - "map-codebase workflow spawns gsd-doc-validator after doc ingestion"
    - "Validation step only runs if user provided documents"
    - "Validation results affect workflow completion summary"
    - "Success criteria include validation status"
  artifacts:
    - path: "get-shit-done/workflows/map-codebase.md"
      provides: "spawn_doc_validator step"
      contains: "spawn_doc_validator"
    - path: "commands/gsd/map-codebase.md"
      provides: "validation step in process"
      contains: "validat"
  key_links:
    - from: "get-shit-done/workflows/map-codebase.md"
      to: "gsd-doc-validator"
      via: "Task tool spawn"
      pattern: "subagent_type.*gsd-doc-validator"
---

<objective>
Integrate the gsd-doc-validator agent into the map-codebase workflow so that user-provided documentation is automatically validated after ingestion.

Purpose: Connect the validation agent created in 02-01 to the existing workflow, ensuring validation runs when users provide documentation and the results are reflected in the workflow output.

Output: Updated `get-shit-done/workflows/map-codebase.md` and `commands/gsd/map-codebase.md` with validation integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-document-validation/02-CONTEXT.md
@.planning/phases/01-document-ingestion-core/01-02-SUMMARY.md
@get-shit-done/workflows/map-codebase.md
@commands/gsd/map-codebase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation step to map-codebase workflow</name>
  <files>get-shit-done/workflows/map-codebase.md</files>
  <action>
Add a new step to the map-codebase workflow that spawns the gsd-doc-validator agent after document ingestion.

**Add new step after `spawn_doc_ingestor`:**

```xml
<step name="spawn_doc_validator" priority="after-ingestor">
Only execute if HAS_USER_DOCS is true and doc ingestion completed successfully.

Spawn the gsd-doc-validator subagent to validate user documentation:

Use Task tool:
- subagent_type: gsd-doc-validator
- description: "Validate user documentation claims against codebase"
- prompt: "Validate the user-provided documentation in USER-CONTEXT.md against the actual codebase. Extract technical claims, verify each against real code, assign confidence levels, present any issues to the user for decision, and update USER-CONTEXT.md with validation status."

Wait for completion. The validator will:
1. Extract technical claims from USER-CONTEXT.md
2. Verify claims against actual codebase files
3. Present LOW confidence claims to user via AskUserQuestion
4. Collect user decisions (Include/Exclude/Mark stale)
5. Annotate USER-CONTEXT.md with validation results

Store validation result for offer_next step.
DOCS_VALIDATED = true after successful completion.
</step>
```

**Update the step ordering** to ensure correct flow:
1. prompt_for_docs
2. collect_doc_paths
3. spawn_doc_ingestor (only if HAS_USER_DOCS)
4. spawn_doc_validator (only if HAS_USER_DOCS and ingestion succeeded)
5. check_existing (codebase mapping begins)
6. ... rest of workflow

**Update `offer_next` step** to include validation status in the completion summary:
- If validation ran: Include claim counts and validation status
- If validation found issues: Note user decisions
- If no docs provided: Skip validation mention

**Update `success_criteria`** to include:
- [ ] User documentation validated (if provided)
- [ ] USER-CONTEXT.md annotated with validation status (if docs provided)
  </action>
  <verify>
    - spawn_doc_validator step exists: `grep -q "spawn_doc_validator" get-shit-done/workflows/map-codebase.md`
    - Uses Task tool: `grep -A5 "spawn_doc_validator" get-shit-done/workflows/map-codebase.md | grep -q "Task tool"`
    - References gsd-doc-validator: `grep -q "gsd-doc-validator" get-shit-done/workflows/map-codebase.md`
    - Has conditional execution: `grep -q "HAS_USER_DOCS" get-shit-done/workflows/map-codebase.md`
    - offer_next mentions validation: `grep -A20 "offer_next" get-shit-done/workflows/map-codebase.md | grep -q "validat"`
    - success_criteria updated: `grep -A10 "success_criteria" get-shit-done/workflows/map-codebase.md | grep -q "validat"`
  </verify>
  <done>map-codebase workflow includes spawn_doc_validator step that conditionally runs after ingestion, with validation results integrated into completion summary and success criteria</done>
</task>

<task type="auto">
  <name>Task 2: Update map-codebase command file</name>
  <files>commands/gsd/map-codebase.md</files>
  <action>
Update the map-codebase command file to reflect the new validation step.

**Update the `<process>` section** to include step 4 for validation:
```
1. Prompt for existing documentation
2. Collect document paths (if provided)
3. Ingest documents into USER-CONTEXT.md (if provided)
4. Validate document claims against codebase (if docs provided)
5. Check for existing codebase map
6. Spawn gsd-codebase-mapper
7. Offer next steps
```

**Update the `<success_criteria>` section** to include:
- [ ] User documentation validated against codebase (if provided)
- [ ] LOW confidence claims resolved with user (if any found)

**Update the completion summary example** (if present) to show validation status.
  </action>
  <verify>
    - Process mentions validation: `grep -q "Validate" commands/gsd/map-codebase.md`
    - Process has 7 steps: `grep -E "^[0-9]+\." commands/gsd/map-codebase.md | wc -l` returns 7
    - Success criteria includes validation: `grep -A5 "success_criteria" commands/gsd/map-codebase.md | grep -q "validat"`
  </verify>
  <done>map-codebase command file includes validation step in process and success criteria</done>
</task>

</tasks>

<verification>
- [ ] spawn_doc_validator step exists in workflow
- [ ] Step uses Task tool with gsd-doc-validator subagent_type
- [ ] Step only runs when HAS_USER_DOCS is true
- [ ] Step runs after spawn_doc_ingestor, before check_existing
- [ ] offer_next includes validation results in summary
- [ ] success_criteria includes validation items
- [ ] Command file process lists 7 steps including validation
- [ ] Command file success_criteria includes validation
</verification>

<success_criteria>
- Workflow spawns gsd-doc-validator after successful doc ingestion
- Validation is conditional (only when user provides docs)
- Completion summary reflects validation status
- Command file documents the validation step
- Integration follows same pattern as spawn_doc_ingestor (from Phase 1)
</success_criteria>

<output>
After completion, create `.planning/phases/02-document-validation/02-02-SUMMARY.md`
</output>
