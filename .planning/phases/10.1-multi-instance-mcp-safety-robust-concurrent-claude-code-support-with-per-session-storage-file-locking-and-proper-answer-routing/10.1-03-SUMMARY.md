---
phase: 10.1-multi-instance-mcp-safety
plan: 03
subsystem: mcp-integration
tags: [session-lifecycle, mcp-tools, session-scoped-operations, heartbeat]

# Dependency graph
requires:
  - phase: 10.1-02
    provides: Session-scoped question storage with per-session JSONL files
provides:
  - Session lifecycle management in MCP server (create, heartbeat, close)
  - Session-aware MCP tool handlers (ask, check, mark)
  - Isolated question operations per Claude Code instance
  - Heartbeat mechanism for session liveness tracking
affects: [10.1-04, multi-instance-safety, question-isolation, session-management]

# Tech tracking
tech-stack:
  patterns: [session-state-module, session-lifecycle, heartbeat-interval]

key-files:
  created:
    - mcp-servers/telegram-mcp/src/storage/session-state.ts
  modified:
    - mcp-servers/telegram-mcp/src/storage/index.ts
    - mcp-servers/telegram-mcp/src/tools/ask-question.ts
    - mcp-servers/telegram-mcp/src/tools/check-answers.ts
    - mcp-servers/telegram-mcp/src/tools/mark-answered.ts
    - mcp-servers/telegram-mcp/src/index.ts

key-decisions:
  - "Session state module provides shared getCurrentSessionId() for tools"
  - "MCP server creates session on startup and sets ID for tools"
  - "Heartbeat interval runs every 5 minutes during server operation"
  - "Session closed on SIGINT/SIGTERM for graceful shutdown"
  - "Removed all Legacy function wrappers from Plan 10.1-02"
  - "mark_question_answered now returns session file path instead of archive path"

patterns-established:
  - "Session lifecycle: create → heartbeat → close"
  - "Session state module: single source of truth for current session ID"
  - "Session-scoped tool operations: all tools use getCurrentSessionId()"

# Metrics
duration: 4min
completed: 2026-02-17
---

# Phase 10.1 Plan 03: Session-Aware MCP Tools and Lifecycle Summary

**MCP server and tools now operate within isolated sessions with proper lifecycle management**

## Performance

- **Duration:** 4 minutes
- **Started:** 2026-02-17T16:12:09Z
- **Completed:** 2026-02-17T16:16:37Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- Created session-state.ts module to share current session ID across MCP tools
- Updated ask-question.ts to use session-scoped appendQuestion(sessionId, ...)
- Updated check-answers.ts to poll only current session's questions via loadSessionJSONL
- Updated mark-answered.ts to verify question in current session and return session path
- Removed all process.pid-based session filtering from tool files
- Added session lifecycle to MCP server entry point (create, heartbeat, close)
- Heartbeat interval runs every 5 minutes while server operates
- Graceful shutdown closes session and clears heartbeat interval
- Opportunistic stale session cleanup on server startup

## Task Commits

Each task was committed atomically:

1. **Task 1: Update MCP tools for session-scoped operation** - `a28e28a` (feat)
2. **Task 2: Add session lifecycle to MCP server entry point** - `177d66c` (feat)

## Files Created/Modified
- `mcp-servers/telegram-mcp/src/storage/session-state.ts` - New session state module with getCurrentSessionId() and setCurrentSessionId()
- `mcp-servers/telegram-mcp/src/storage/index.ts` - Export session-state module
- `mcp-servers/telegram-mcp/src/tools/ask-question.ts` - Use getCurrentSessionId() and appendQuestion(sessionId, ...)
- `mcp-servers/telegram-mcp/src/tools/check-answers.ts` - Poll session-scoped questions via loadSessionJSONL
- `mcp-servers/telegram-mcp/src/tools/mark-answered.ts` - Verify question in current session, return session path
- `mcp-servers/telegram-mcp/src/index.ts` - Create session, start heartbeat, close on shutdown

## Decisions Made

**1. Session state module pattern**
- Rationale: Provides single source of truth for current session ID, accessible to all tools without passing parameters through MCP protocol

**2. Heartbeat interval every 5 minutes**
- Rationale: Balances session liveness tracking with minimal I/O overhead

**3. Session created on server startup**
- Rationale: Each MCP server instance operates within its own session from the start

**4. Removed Legacy function wrappers**
- Rationale: Proper session context now available, backward compatibility layer no longer needed

**5. mark_question_answered returns session file path**
- Rationale: Answered questions stay in session files (not separately archived), so session path is the correct location

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all tasks completed successfully with no blocking issues.

## User Setup Required

None - changes are fully backward compatible and transparent to users.

## Next Phase Readiness

MCP server and tools are now fully session-aware and ready for multi-instance operation:
- Plan 10.1-04 will update Telegram bot for session-aware answer routing
- Each Claude Code instance operates in complete isolation
- Questions are scoped to sessions, no cross-instance data leakage

**Blockers:** None

**Validation:**
- ✅ TypeScript compiles full telegram-mcp project without errors
- ✅ ask-question uses session-scoped appendQuestion(sessionId, ...)
- ✅ check-answers polls session-scoped questions only via loadSessionJSONL
- ✅ Server creates session and starts heartbeat on startup
- ✅ Server closes session on SIGINT/SIGTERM
- ✅ No process.pid references for session identification in tool files
- ✅ All tools use getCurrentSessionId() for session scoping

## Self-Check: PASSED

Verified claims:
- ✅ Created files: session-state.ts (new module)
- ✅ Modified files: index.ts (storage), ask-question.ts, check-answers.ts, mark-answered.ts, index.ts (MCP server)
- ✅ Commits exist: a28e28a (Task 1), 177d66c (Task 2)
- ✅ TypeScript compilation successful: `npx tsc --noEmit` passes
- ✅ ask-question uses appendQuestion(sessionId, ...): verified via grep
- ✅ check-answers uses loadSessionJSONL: verified via grep
- ✅ Server creates session: createSession() called in main()
- ✅ Server closes session: closeSession() called in SIGINT/SIGTERM handlers
- ✅ No process.pid for session ID in tools: verified via grep (no matches)

---
*Phase: 10.1-multi-instance-mcp-safety*
*Completed: 2026-02-17*
