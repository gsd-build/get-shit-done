---
phase: 06-multi-stack-analyzer
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - agents/gsd-intel-stack-analyzer.md
autonomous: true

must_haves:
  truths:
    - "Subagent receives stack ID and project root as input"
    - "Subagent loads only its stack profile from YAML (not all profiles)"
    - "Subagent analyzes files matching stack patterns and extracts exports/imports"
    - "Subagent returns JSON summary, not raw file contents"
    - "Each subagent invocation gets fresh 200k context (no accumulation)"
  artifacts:
    - path: "agents/gsd-intel-stack-analyzer.md"
      provides: "Per-stack analysis subagent definition"
      min_lines: 120
  key_links:
    - from: "agents/gsd-intel-stack-analyzer.md"
      to: "hooks/lib/get-stack-profile.js"
      via: "Loads stack profile via helper"
      pattern: "get-stack-profile"
    - from: "agents/gsd-intel-stack-analyzer.md"
      to: "hooks/lib/stack-profiles.yaml"
      via: "Uses patterns from profile"
      pattern: "export_patterns|import_patterns"
---

# Plan 06-03: Stack Analyzer Subagent

<objective>
Create `agents/gsd-intel-stack-analyzer.md` - a subagent definition for per-stack codebase analysis.

Purpose: Each detected stack gets its own subagent with fresh 200k context. This follows GSD's core principle: "Burn subagent context freely, preserve orchestrator context religiously." The orchestrator only receives compact JSON summaries (~50-100 tokens per stack), not the full analysis.

Output: `agents/gsd-intel-stack-analyzer.md` (~150 lines)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-multi-stack-analyzer/06-RESEARCH.md

Existing pattern to follow:
@agents/gsd-entity-generator.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gsd-intel-stack-analyzer.md subagent definition</name>
  <files>agents/gsd-intel-stack-analyzer.md</files>
  <action>
Create the subagent definition following the pattern established by gsd-entity-generator.md.

**Frontmatter:**
```yaml
---
name: gsd-intel-stack-analyzer
description: Analyzes a single programming language stack in the codebase. Spawned by analyze-codebase for each detected stack. Returns JSON summary with exports, imports, and conventions.
tools: Read, Bash, Glob
color: magenta
---
```

**Role section:**
- You are a GSD stack analyzer subagent
- You are spawned by /gsd:analyze-codebase with a stack ID and project root
- Your job: Analyze files for this stack, extract exports/imports using profile patterns, return compact JSON

**Input parameters (received from orchestrator):**
- Stack ID (e.g., "typescript", "python", "csharp")
- Project root path
- Stack confidence score
- Detected frameworks (array)

**Process:**
1. **Load stack profile:**
   ```bash
   node hooks/lib/get-stack-profile.js {stackId}
   ```
   Parse the JSON output to get globs, excludes, export_patterns, import_patterns, naming conventions.

2. **Find files matching stack:**
   Use Glob tool with the profile's globs, excluding the profile's excludes.
   Limit to first 100 files (prevents context explosion).

3. **Analyze files:**
   For each file (up to 100):
   - Read file content
   - Apply export_patterns to extract exports
   - Apply import_patterns to extract imports
   - Track naming patterns observed

4. **Build stack analysis:**
   Aggregate findings into:
   ```json
   {
     "stack": "typescript",
     "files_analyzed": 47,
     "exports_found": 156,
     "imports_found": 234,
     "exports_by_type": {
       "function": 89,
       "class": 23,
       "interface": 31,
       "constant": 13
     },
     "naming_observed": {
       "functions": "camelCase",
       "classes": "PascalCase"
     },
     "directories": {
       "src/components": "React components (23 files)",
       "src/hooks": "Custom hooks (8 files)"
     },
     "frameworks_confirmed": ["react", "nextjs"]
   }
   ```

5. **Return JSON summary:**
   Return ONLY the JSON summary. Do not return file contents or individual file analyses.

**Critical rules:**
- NEVER return raw file contents to orchestrator
- Limit file analysis to 100 files maximum
- Return compact JSON (<100 tokens target)
- Use stack profile patterns exactly as provided
- Track directory purposes from file distribution
  </action>
  <verify>
```bash
# Verify file exists
ls -la agents/gsd-intel-stack-analyzer.md

# Check structure
head -30 agents/gsd-intel-stack-analyzer.md
grep -c "## " agents/gsd-intel-stack-analyzer.md  # Should have multiple sections
```
  </verify>
  <done>gsd-intel-stack-analyzer.md exists with complete subagent definition</done>
</task>

<task type="auto">
  <name>Task 2: Add success criteria and output format</name>
  <files>agents/gsd-intel-stack-analyzer.md</files>
  <action>
Add the success criteria and detailed output format sections to the subagent definition.

**Output format section:**
```markdown
<output_format>
Return EXACTLY this JSON structure (no additional text):

```json
{
  "stack": "{stack_id}",
  "name": "{display_name}",
  "files_analyzed": {N},
  "total_files_found": {M},
  "exports_found": {N},
  "imports_found": {N},
  "exports_by_type": {
    "function": {N},
    "class": {N},
    "interface": {N},
    "type": {N},
    "constant": {N},
    "enum": {N}
  },
  "top_exports": [
    {"name": "functionA", "type": "function", "file": "src/lib/utils.ts"},
    {"name": "ClassB", "type": "class", "file": "src/models/user.ts"}
  ],
  "naming_observed": {
    "functions": "{case}",
    "classes": "{case}",
    "constants": "{case}"
  },
  "directories": {
    "path": "purpose (N files)"
  },
  "frameworks_confirmed": ["{framework}"],
  "duration_ms": {N}
}
```

**Token budget:** Target <100 tokens for this JSON. Orchestrator context is precious.
</output_format>
```

**Success criteria section:**
```markdown
<success_criteria>
Stack analysis complete when:
- [ ] Stack profile loaded successfully
- [ ] Files found using profile globs (up to 100)
- [ ] Export patterns applied to each file
- [ ] Import patterns applied to each file
- [ ] Naming conventions detected from actual exports
- [ ] Directory purposes inferred from file distribution
- [ ] Frameworks confirmed (if any detected)
- [ ] JSON summary returned (not file contents)
- [ ] Total response under 150 tokens
</success_criteria>
```

**Error handling:**
- If profile not found: Return `{"error": "Profile not found for stack: {id}"}`
- If no files found: Return summary with files_analyzed: 0
- If glob fails: Log error, continue with partial results
  </action>
  <verify>
```bash
# Check for success_criteria and output_format sections
grep -n "success_criteria" agents/gsd-intel-stack-analyzer.md
grep -n "output_format" agents/gsd-intel-stack-analyzer.md

# Verify file completeness
wc -l agents/gsd-intel-stack-analyzer.md  # Should be ~150 lines
```
  </verify>
  <done>gsd-intel-stack-analyzer.md has complete output format and success criteria sections</done>
</task>

</tasks>

<verification>
- [ ] `agents/gsd-intel-stack-analyzer.md` exists
- [ ] Has valid frontmatter (name, description, tools, color)
- [ ] Documents input parameters (stack ID, project root, confidence, frameworks)
- [ ] Describes process (load profile, find files, analyze, return JSON)
- [ ] Specifies exact JSON output format
- [ ] Includes file limit (100 files max)
- [ ] Has success criteria section
- [ ] Total ~120-150 lines
</verification>

<success_criteria>
- Subagent definition follows gsd-entity-generator pattern
- Clearly documents how to load stack profile via get-stack-profile.js
- Specifies JSON output format with all required fields
- Emphasizes context preservation (compact JSON, no raw file contents)
- Includes error handling guidance
</success_criteria>

<output>
After completion, create `.planning/phases/06-multi-stack-analyzer/06-03-SUMMARY.md`
</output>
