---
phase: 06-multi-stack-analyzer
plan: 06
type: execute
wave: 4
depends_on: ["06-01", "06-02", "06-03", "06-04", "06-05"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "JS/TS-only projects work identically to before (backward compatible)"
    - "Polyglot projects detect all stacks correctly"
    - "Token budget stays at ~2,850 tokens (not 7,200+)"
    - "Parallel subagent execution confirmed"
    - "Stack field appears in entities and index.json"
  artifacts: []
  key_links:
    - from: "commands/gsd/analyze-codebase.md"
      to: "hooks/lib/detect-stacks.js"
      via: "Step 0 invocation"
      pattern: "detect-stacks"
    - from: "commands/gsd/analyze-codebase.md"
      to: "agents/gsd-intel-stack-analyzer.md"
      via: "Step 0.5 subagent spawning"
      pattern: "gsd-intel-stack-analyzer"
---

# Plan 06-06: Integration Testing

<objective>
Test the complete multi-stack analyzer integration to verify backward compatibility, polyglot detection, and token budget optimization.

Purpose: Ensure the implementation works correctly across different codebase types before merging. Verify the core GSD principle: "Burn subagent context freely, preserve orchestrator context religiously."

Output:
- Test results documented
- Any issues found and fixed
- Ready for PR to upstream
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-multi-stack-analyzer/06-RESEARCH.md
@.planning/phases/06-multi-stack-analyzer/06-01-SUMMARY.md
@.planning/phases/06-multi-stack-analyzer/06-02-SUMMARY.md
@.planning/phases/06-multi-stack-analyzer/06-03-SUMMARY.md
@.planning/phases/06-multi-stack-analyzer/06-04-SUMMARY.md
@.planning/phases/06-multi-stack-analyzer/06-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test stack detection on GSD repo (JS/TS baseline)</name>
  <files></files>
  <action>
Test detect-stacks.js on the GSD repository itself to establish baseline behavior.

**Run detection:**
```bash
cd /mnt/d/Repos/get-shit-done
node hooks/lib/detect-stacks.js . json
```

**Expected results:**
- Primary stack: "javascript" or "typescript" (both acceptable)
- isPolyglot: false (unless other languages detected)
- Confidence for JS/TS: 70%+ (package.json, many .js/.ts files)
- Frameworks detected: Should NOT detect React/Vue/etc (GSD is not a web app)

**Verify output structure:**
```json
{
  "projectPath": "...",
  "detected": [
    {
      "stack": "javascript|typescript",
      "name": "JavaScript|TypeScript",
      "fileCount": N,
      "evidence": ["markers: package.json", "N source files"],
      "frameworks": [],
      "confidence": 70+
    }
  ],
  "primary": "javascript|typescript",
  "isPolyglot": false,
  "stackCount": 1,
  "duration": N
}
```

**Document any issues found.**
  </action>
  <verify>
```bash
# Run detection and capture output
node hooks/lib/detect-stacks.js . json > /tmp/gsd-test-stacks.json
cat /tmp/gsd-test-stacks.json

# Verify JSON is valid
node -e "console.log(JSON.parse(require('fs').readFileSync('/tmp/gsd-test-stacks.json', 'utf8')).primary)"
```
  </verify>
  <done>Stack detection works on GSD repo, returns valid JSON with expected structure</done>
</task>

<task type="auto">
  <name>Task 2: Test backward compatibility with JS-only project</name>
  <files></files>
  <action>
Verify that a single-stack JavaScript project works identically to before the multi-stack changes.

**Create a minimal test directory:**
```bash
mkdir -p /tmp/gsd-test-js-only
cd /tmp/gsd-test-js-only

# Create minimal JS project
echo '{"name": "test", "version": "1.0.0"}' > package.json
mkdir -p src
echo 'export function hello() { return "world"; }' > src/index.js
echo 'export const config = { debug: true };' > src/config.js
```

**Run detection:**
```bash
node /mnt/d/Repos/get-shit-done/hooks/lib/detect-stacks.js /tmp/gsd-test-js-only json
```

**Expected:**
- Primary: javascript
- isPolyglot: false
- stackCount: 1

**Run analyze-codebase simulation:**
Verify that Step 0 detection returns single stack and Step 0.5 is skipped (or runs for single stack).

**Clean up:**
```bash
rm -rf /tmp/gsd-test-js-only
```
  </action>
  <verify>
```bash
# Create and test
mkdir -p /tmp/gsd-test-js-only/src
echo '{"name": "test"}' > /tmp/gsd-test-js-only/package.json
echo 'export function hello() {}' > /tmp/gsd-test-js-only/src/index.js

node /mnt/d/Repos/get-shit-done/hooks/lib/detect-stacks.js /tmp/gsd-test-js-only json

rm -rf /tmp/gsd-test-js-only
```
  </verify>
  <done>Single-stack JS project detected correctly, no regressions</done>
</task>

<task type="auto">
  <name>Task 3: Test polyglot detection with multi-language project</name>
  <files></files>
  <action>
Create a polyglot test project with multiple languages and verify detection.

**Create polyglot test directory:**
```bash
mkdir -p /tmp/gsd-test-polyglot
cd /tmp/gsd-test-polyglot

# JavaScript
echo '{"name": "polyglot-test"}' > package.json
mkdir -p src/js
echo 'export function jsFunc() {}' > src/js/app.js

# Python
echo 'flask==2.0.0' > requirements.txt
mkdir -p src/python
echo 'def py_func(): pass' > src/python/app.py

# C# (simulate with .csproj)
echo '<Project Sdk="Microsoft.NET.Sdk"></Project>' > test.csproj
mkdir -p src/csharp
echo 'public class CsClass {}' > src/csharp/App.cs

# PowerShell
mkdir -p src/powershell
echo 'function Get-Test { }' > src/powershell/Module.ps1
```

**Run detection:**
```bash
node /mnt/d/Repos/get-shit-done/hooks/lib/detect-stacks.js /tmp/gsd-test-polyglot json
```

**Expected:**
- isPolyglot: true
- stackCount: 3+ (JavaScript, Python, C#, possibly PowerShell)
- Each detected stack has confidence score
- Primary determined by highest confidence

**Clean up:**
```bash
rm -rf /tmp/gsd-test-polyglot
```
  </action>
  <verify>
```bash
# Create polyglot project
mkdir -p /tmp/gsd-test-polyglot/src/{js,python,csharp}
echo '{"name": "test"}' > /tmp/gsd-test-polyglot/package.json
echo 'flask==2.0' > /tmp/gsd-test-polyglot/requirements.txt
echo '<Project/>' > /tmp/gsd-test-polyglot/test.csproj
echo 'export function f() {}' > /tmp/gsd-test-polyglot/src/js/app.js
echo 'def f(): pass' > /tmp/gsd-test-polyglot/src/python/app.py
echo 'public class C {}' > /tmp/gsd-test-polyglot/src/csharp/App.cs

# Test detection
node /mnt/d/Repos/get-shit-done/hooks/lib/detect-stacks.js /tmp/gsd-test-polyglot json

# Verify isPolyglot
node -e "const r=JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')); console.log('isPolyglot:', r.isPolyglot, 'stackCount:', r.stackCount)" < <(node /mnt/d/Repos/get-shit-done/hooks/lib/detect-stacks.js /tmp/gsd-test-polyglot json)

rm -rf /tmp/gsd-test-polyglot
```
  </verify>
  <done>Polyglot project detected with multiple stacks, isPolyglot=true</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify full integration</name>
  <what-built>
Complete multi-stack analyzer integration:
- Stack detection module (detect-stacks.js)
- Stack profiles configuration (stack-profiles.yaml)
- Stack analyzer subagent (gsd-intel-stack-analyzer.md)
- Updated orchestrator (analyze-codebase.md with Step 0, 0.5)
- Updated entity template and generator (stack/framework fields)
- Updated PostToolUse hook (stack field extraction)
  </what-built>
  <how-to-verify>
1. **Test stack detection on a real polyglot codebase:**
   - If you have a polyglot project locally, run: `node hooks/lib/detect-stacks.js /path/to/project json`
   - Verify it detects multiple stacks correctly

2. **Review the analyze-codebase.md changes:**
   - Open commands/gsd/analyze-codebase.md
   - Confirm Step 0 and Step 0.5 are present
   - Verify the subagent spawning logic looks correct

3. **Check entity template:**
   - Open get-shit-done/templates/entity.md
   - Confirm stack and framework fields documented

4. **Optional: Run /gsd:analyze-codebase on test project:**
   - This will exercise the full flow
   - Check that entities have stack field in frontmatter
   - Verify index.json has version 2 with stack fields

5. **Token budget sanity check:**
   - The orchestrator should only receive ~50 tokens per stack (JSON summary)
   - Full analysis happens in subagents (fresh 200k context each)
  </how-to-verify>
  <resume-signal>Type "approved" if integration looks correct, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] Stack detection works on JS-only project (backward compatible)
- [ ] Stack detection works on polyglot project (multiple stacks)
- [ ] JSON output structure is correct
- [ ] analyze-codebase.md has Step 0 and Step 0.5
- [ ] Entity template documents stack/framework fields
- [ ] Human verification approved
</verification>

<success_criteria>
- JS/TS-only projects work identically to before
- Polyglot projects detect all languages above 40% confidence threshold
- Primary stack is the highest confidence stack
- isPolyglot flag correctly set when 2+ stacks detected
- Full integration works end-to-end (detection -> subagents -> entities)
</success_criteria>

<output>
After completion, create `.planning/phases/06-multi-stack-analyzer/06-06-SUMMARY.md`
</output>
