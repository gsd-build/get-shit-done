---
phase: 06-multi-stack-analyzer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hooks/lib/detect-stacks.js
  - hooks/lib/get-stack-profile.js
autonomous: true

must_haves:
  truths:
    - "detect-stacks.js detects 35+ languages via marker files"
    - "Confidence scoring uses marker files (40%) + file count (40%) + frameworks (20%)"
    - "CLI returns JSON with detected stacks, primary stack, and isPolyglot flag"
    - "Module can be required by other JS files"
  artifacts:
    - path: "hooks/lib/detect-stacks.js"
      provides: "Stack detection module with CLI and programmatic interface"
      min_lines: 500
    - path: "hooks/lib/get-stack-profile.js"
      provides: "Helper to extract stack profile as JSON from YAML"
      min_lines: 30
  key_links:
    - from: "hooks/lib/detect-stacks.js"
      to: "hooks/lib/stack-profiles.yaml"
      via: "YAML parsing for framework patterns"
      pattern: "require.*stack-profiles"
---

# Plan 06-01: Stack Detection Module

<objective>
Create `hooks/lib/detect-stacks.js` - the foundation module for multi-language stack detection.

Purpose: Enable analyze-codebase to identify all programming languages and frameworks in a codebase before analysis begins. This preserves orchestrator context by returning compact JSON (~50 tokens) instead of inline pattern matching.

Output:
- `hooks/lib/detect-stacks.js` (~600 lines) - Stack detection with CLI and module interface
- `hooks/lib/get-stack-profile.js` (~50 lines) - Helper for JSON profile extraction
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-multi-stack-analyzer/06-RESEARCH.md

Reference implementation (read via git show):
```bash
git show feature/multi-stack-analyzer:proposals/multi-stack-analyzer/implementation/detect-stacks.js
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks/lib directory and detect-stacks.js</name>
  <files>hooks/lib/detect-stacks.js</files>
  <action>
Create the hooks/lib/ directory and implement detect-stacks.js based on the reference implementation.

**Key implementation details:**
1. Create `hooks/lib/` directory (new subdirectory for reusable modules)
2. Copy and adapt the reference implementation from `git show feature/multi-stack-analyzer:proposals/multi-stack-analyzer/implementation/detect-stacks.js`

**Required functionality:**
- STACK_MARKERS object with 35+ language definitions (JavaScript, TypeScript, Python, C#, PowerShell, Go, Rust, Java, Kotlin, Ruby, PHP, Swift, etc.)
- Each stack has: name, markers (files like package.json, go.mod), globs, extensions, frameworks (nested detection)
- `detectStacks(projectPath)` async function that:
  - Walks directory tree (respecting excludes like node_modules, .git, vendor)
  - Scores confidence: marker files (40%) + source file count (40%) + framework detection (20%)
  - Returns JSON: { projectPath, detected: [...], primary, isPolyglot, stackCount, duration }
- Framework detection within each stack (React in JS, Django in Python, ASP.NET in C#, etc.)
- CLI interface: `node detect-stacks.js [path] [format]` where format is 'json' (default) or 'text'
- Module export: `module.exports = { detectStacks, STACK_MARKERS }`

**Confidence threshold:**
- 40% minimum for a stack to be included in results
- Primary stack is the one with highest confidence
- isPolyglot is true if 2+ stacks detected above threshold

**Performance considerations:**
- Use async file operations
- Stop early if marker files found (don't scan entire tree for markers)
- Cache directory listings within single run
  </action>
  <verify>
```bash
# Create lib directory
mkdir -p hooks/lib

# Verify file exists and has correct structure
ls -la hooks/lib/detect-stacks.js
head -50 hooks/lib/detect-stacks.js

# Test CLI on GSD repo itself (should detect JavaScript/TypeScript)
node hooks/lib/detect-stacks.js . json
```
  </verify>
  <done>detect-stacks.js exists in hooks/lib/, CLI outputs valid JSON with detected stacks for GSD repo</done>
</task>

<task type="auto">
  <name>Task 2: Create get-stack-profile.js helper</name>
  <files>hooks/lib/get-stack-profile.js</files>
  <action>
Create a helper module that extracts a single stack's profile from stack-profiles.yaml and returns it as JSON.

**Why this exists:** Subagents shouldn't parse YAML directly (error-prone regex). This helper pre-parses the profile so subagents receive clean JSON.

**Implementation:**
```javascript
#!/usr/bin/env node
/**
 * get-stack-profile.js
 * Extracts a specific stack's profile from stack-profiles.yaml as JSON.
 *
 * Usage:
 *   CLI: node get-stack-profile.js typescript
 *   Module: const { getStackProfile } = require('./get-stack-profile');
 */

const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml'); // Note: Requires js-yaml package

const PROFILES_PATH = path.join(__dirname, 'stack-profiles.yaml');

function getStackProfile(stackId) {
  const content = fs.readFileSync(PROFILES_PATH, 'utf8');
  const profiles = yaml.load(content);

  if (!profiles[stackId]) {
    throw new Error(`Unknown stack: ${stackId}. Available: ${Object.keys(profiles).join(', ')}`);
  }

  return profiles[stackId];
}

// CLI interface
if (require.main === module) {
  const stackId = process.argv[2];
  if (!stackId) {
    console.error('Usage: node get-stack-profile.js <stack-id>');
    process.exit(1);
  }

  try {
    const profile = getStackProfile(stackId);
    console.log(JSON.stringify(profile, null, 2));
  } catch (err) {
    console.error(err.message);
    process.exit(1);
  }
}

module.exports = { getStackProfile };
```

**Note:** This task creates the helper. The js-yaml dependency will be documented but NOT added to package.json (GSD has no package.json; Claude uses system-installed node). The helper will gracefully fail if js-yaml is not available, with instructions to install it.
  </action>
  <verify>
```bash
# Verify file exists
ls -la hooks/lib/get-stack-profile.js

# Test CLI (will fail if stack-profiles.yaml doesn't exist yet - that's ok)
# This test will work after 06-02 completes
node hooks/lib/get-stack-profile.js typescript 2>&1 | head -5
```
  </verify>
  <done>get-stack-profile.js exists and exports getStackProfile function</done>
</task>

<task type="auto">
  <name>Task 3: Add graceful js-yaml fallback</name>
  <files>hooks/lib/get-stack-profile.js</files>
  <action>
Update get-stack-profile.js to handle missing js-yaml gracefully. If js-yaml is not installed, the module should:
1. Try to require js-yaml
2. If not found, attempt a simple YAML parse for basic cases (single stack extraction)
3. Log helpful error message if parsing fails

**Add fallback logic:**
```javascript
let yaml;
try {
  yaml = require('js-yaml');
} catch {
  // Fallback: simple YAML parser for basic stack profile extraction
  yaml = {
    load: (content) => {
      // Basic YAML parsing - handles our stack-profiles.yaml structure
      const result = {};
      let currentStack = null;
      let currentIndent = 0;

      // ... simplified parsing logic for stack-profiles.yaml format
      // This is a fallback - recommend installing js-yaml for full support

      return result;
    }
  };
  console.error('Warning: js-yaml not found. Using simplified parser. For full YAML support: npm install -g js-yaml');
}
```

This ensures the module works in environments without js-yaml installed while recommending the proper dependency.
  </action>
  <verify>
```bash
# Test that module loads without crashing even without js-yaml
node -e "require('./hooks/lib/get-stack-profile.js')"
```
  </verify>
  <done>get-stack-profile.js loads without crashing, handles missing js-yaml gracefully</done>
</task>

</tasks>

<verification>
- [ ] `hooks/lib/` directory exists
- [ ] `detect-stacks.js` detects JavaScript/TypeScript when run on GSD repo
- [ ] CLI output is valid JSON with expected structure
- [ ] `get-stack-profile.js` exists and can be required
- [ ] Module loads without js-yaml (graceful fallback)
</verification>

<success_criteria>
- detect-stacks.js correctly identifies primary stack as "javascript" or "typescript" when run on GSD repo
- JSON output includes: projectPath, detected (array), primary, isPolyglot, stackCount
- Each detected stack has: stack, name, fileCount, evidence, frameworks, confidence
- get-stack-profile.js can extract profile for a known stack ID
</success_criteria>

<output>
After completion, create `.planning/phases/06-multi-stack-analyzer/06-01-SUMMARY.md`
</output>
