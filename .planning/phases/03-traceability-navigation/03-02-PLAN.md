---
phase: 03-traceability-navigation
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/commands/visualize.js
  - src/declare-tools.js
  - .claude/commands/declare/trace.md
  - .claude/commands/declare/visualize.md
  - .claude/commands/declare/prioritize.md
autonomous: true
requirements:
  - DAG-06
  - DAG-07
  - DAG-08

must_haves:
  truths:
    - "visualize subcommand returns tree structure of the full graph or a scoped subtree"
    - "visualize shows status markers on every node ([done], [pending], [!] blocked)"
    - "/declare:trace renders why-chain with tree connectors for any node"
    - "/declare:visualize renders top-down ASCII tree of the derivation structure"
    - "/declare:prioritize renders ranked action list with scores"
    - "all three slash commands support --output flag to write to file"
  artifacts:
    - path: "src/commands/visualize.js"
      provides: "DAG visualization as top-down tree with status markers"
      exports: ["runVisualize"]
    - path: ".claude/commands/declare/trace.md"
      provides: "Slash command for why-chain tracing"
      min_lines: 30
    - path: ".claude/commands/declare/visualize.md"
      provides: "Slash command for graph visualization"
      min_lines: 30
    - path: ".claude/commands/declare/prioritize.md"
      provides: "Slash command for impact-based prioritization"
      min_lines: 30
  key_links:
    - from: "src/commands/visualize.js"
      to: "src/commands/build-dag.js"
      via: "buildDagFromDisk import"
      pattern: "require.*build-dag"
    - from: "src/declare-tools.js"
      to: "src/commands/visualize.js"
      via: "subcommand dispatch"
      pattern: "case 'visualize'"
    - from: ".claude/commands/declare/trace.md"
      to: "dist/declare-tools.cjs"
      via: "Bash tool invocation"
      pattern: "declare-tools.cjs trace"
    - from: ".claude/commands/declare/visualize.md"
      to: "dist/declare-tools.cjs"
      via: "Bash tool invocation"
      pattern: "declare-tools.cjs visualize"
---

<objective>
Implement visualize command and create all three slash commands

Purpose: Complete Phase 3 by adding the ASCII graph visualization (DAG-07) and creating the user-facing slash commands that render trace, visualize, and prioritize output. The visualize command is the most complex -- it renders the full 3-layer DAG as a top-down tree with Unicode box-drawing connectors and status markers. The slash commands follow the established meta-prompt pattern: .md instructs Claude how to invoke declare-tools.cjs and format the JSON output for the user.

Output: visualize.js command module, three slash command .md files, updated CLI dispatch, rebuilt bundle.
</objective>

<execution_context>
@/Users/guilherme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/guilherme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-traceability-navigation/03-RESEARCH.md
@.planning/phases/03-traceability-navigation/03-01-SUMMARY.md
@src/commands/build-dag.js
@src/commands/trace.js
@src/commands/prioritize.js
@src/commands/parse-args.js
@src/declare-tools.js
@src/graph/engine.js
@.claude/commands/declare/status.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement visualize command, wire into CLI, rebuild bundle</name>
  <files>src/commands/visualize.js, src/declare-tools.js</files>
  <action>
**visualize.js** - Implement `runVisualize(cwd, args)`:

1. Parse args: `scopeId` = first positional arg (optional declaration or milestone ID to zoom into subtree). `outputFile` = `parseFlag(args, 'output')`.
2. Call `buildDagFromDisk(cwd)` to load graph.
3. If `scopeId` provided, validate it exists. Implement `getSubtreeNodeIds(dag, rootId)` via BFS downward using `dag.getDownstream()`. Only render nodes in the subtree.
4. If no `scopeId`, render full graph (all declarations at top).

**Tree rendering algorithm (top-down, declarations at root):**

For each declaration (sorted by ID):
- Render: `D-01: Title [status_marker]`
- Get its downstream milestones via `dag.getDownstream(d.id)`, sorted by ID
- For each milestone, render with tree connectors (last child uses `---`, others use `---`):
  - `--- M-01: Title [status_marker]`
  - Get its downstream actions via `dag.getDownstream(m.id)`, sorted by ID
  - For each action, render with tree connectors:
    - `--- A-01: Title [status_marker]`

**Status markers (per user decision):**
- DONE -> `[done]` (use checkmark: `\u2713`)
- PENDING -> `[pending]` (use circle: `\u25CB`)
- For "blocked" detection: a milestone is blocked if it has downstream actions that are not all DONE and the milestone itself is not DONE. An action is never blocked (leaf node). Use `[!]` for blocked. However, keep it simple: only mark a non-DONE node as blocked if it has at least one non-DONE child. If a node has no children and is not DONE, it's just PENDING.
- ACTIVE -> show as `[>]` to differentiate from PENDING.

**Tree connectors:** Use Unicode characters per user decision:
- Child prefix: `\u251C\u2500\u2500 ` (middle child) and `\u2514\u2500\u2500 ` (last child)
- Continuation: `\u2502   ` (for indentation under non-last children)

**Handle many-to-many:** When a milestone appears under multiple declarations, or an action under multiple milestones, show it under each parent (duplicated in tree view per user decision and research recommendation).

**Return JSON:**
```json
{
  "scope": "full" | "D-01",
  "tree": [ { "node": {...}, "children": [...] } ],
  "formatted": "...pre-rendered text...",
  "stats": { "declarations": N, "milestones": N, "actions": N }
}
```

The `formatted` field contains the pre-rendered ASCII tree as a string (useful for --output file write and for the slash command to display directly).

If `outputFile`, write `formatted` to file via `fs.writeFileSync(path.resolve(cwd, outputFile))`.

**declare-tools.js** - Add visualize case block:

```javascript
case 'visualize': {
  const cwd = parseCwdFlag(args) || process.cwd();
  const result = runVisualize(cwd, args.slice(1));
  console.log(JSON.stringify(result));
  if (result.error) process.exit(1);
  break;
}
```

Add import for runVisualize. Update error message listing available commands. Rebuild bundle: `node esbuild.config.js`.
  </action>
  <verify>
Test full graph: `node src/declare-tools.js visualize` (should return tree or error if no project).
Test scoped: `node src/declare-tools.js visualize D-01` (should return subtree or "node not found").
Test output flag: `node src/declare-tools.js visualize --output /tmp/test-viz.txt` (should write file).
Verify bundle: `node dist/declare-tools.cjs visualize`.
  </verify>
  <done>
visualize subcommand returns structured JSON with tree data and pre-rendered formatted text. Status markers appear on all nodes. Subtree scoping works with declaration/milestone ID argument. --output flag writes formatted text to file. Bundle rebuilt with visualize command.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create trace, visualize, and prioritize slash commands</name>
  <files>.claude/commands/declare/trace.md, .claude/commands/declare/visualize.md, .claude/commands/declare/prioritize.md</files>
  <action>
Create three slash command files following the established meta-prompt pattern from status.md. Each slash command instructs Claude to run the tool, parse JSON, and render output for the user. All commands install to `~/.claude/commands/declare/` for cross-project usage.

**trace.md** - `/declare:trace [node-id]`:

Frontmatter: description, allowed-tools (Read, Bash, Grep, Glob).

Instructions:
1. If `$ARGUMENTS` contains a node ID (e.g., `A-01`, `M-02`, `D-01`):
   - Run `node dist/declare-tools.cjs trace <node-id>`
   - Parse JSON. If error, display and suggest.
   - Render the why-chain using tree connectors per user decision:
     - Start with the traced node: `{ID}: {Title} [{STATUS}]`
     - For each path, render upward chain with tree connectors
     - Show all paths (multi-path for many-to-many edges)
   - Use the `formatted` field from the JSON as the primary display
2. If no arguments (interactive picker per user decision):
   - Run `node dist/declare-tools.cjs trace` (no args)
   - Parse JSON -- it returns nodes grouped by type
   - Present a numbered list grouped by type (Actions, Milestones, Declarations)
   - Ask the user to provide a node ID
   - Then run `node dist/declare-tools.cjs trace <selected-id>` and render as above
3. If `--output <path>` is in arguments, pass it through to the tool command. Inform the user the output was written to the file.

**visualize.md** - `/declare:visualize [scope-id]`:

Frontmatter: description, allowed-tools (Read, Bash, Grep, Glob, Write).

Instructions:
1. If `$ARGUMENTS` contains a scope ID (e.g., `D-01`, `M-03`):
   - Run `node dist/declare-tools.cjs visualize <scope-id>`
2. If no arguments:
   - Run `node dist/declare-tools.cjs visualize` (full graph)
3. Parse JSON. If error, display and suggest.
4. Display the `formatted` field directly -- it contains the pre-rendered ASCII tree with Unicode connectors and status markers.
5. Below the tree, show stats: "N declarations, N milestones, N actions"
6. If `--output <path>` in arguments, pass through. Inform user.

**prioritize.md** - `/declare:prioritize [--declaration D-XX]`:

Frontmatter: description, allowed-tools (Read, Bash, Grep, Glob).

Instructions:
1. Build the command: `node dist/declare-tools.cjs prioritize`
2. If `$ARGUMENTS` contains `--declaration D-XX`, append `--declaration D-XX` to the command.
3. If `--output <path>` in arguments, append to command.
4. Run command, parse JSON.
5. Render the ranked list as a formatted table or list:
   - Show rank, ID, title, and score for each action
   - Header explaining the score: "Score = number of milestones and declarations this action contributes to (unblocking power)"
   - If filtered, note the filter scope
6. If no actions found, explain that no actions exist and suggest running /declare:actions first.

All three slash commands should use absolute path to `dist/declare-tools.cjs` (the path set in the project, e.g., `node /Users/guilherme/Projects/get-shit-done/dist/declare-tools.cjs`). Check status.md for the exact pattern used.

After creating the files, copy them to `~/.claude/commands/declare/` for cross-project installation (matching Phase 1 pattern).
  </action>
  <verify>
Verify all three files exist and have valid frontmatter:
- `head -5 .claude/commands/declare/trace.md`
- `head -5 .claude/commands/declare/visualize.md`
- `head -5 .claude/commands/declare/prioritize.md`

Verify user-level installation:
- `ls ~/.claude/commands/declare/trace.md`
- `ls ~/.claude/commands/declare/visualize.md`
- `ls ~/.claude/commands/declare/prioritize.md`

Verify slash command references correct tool path (grep for declare-tools.cjs in each file).
  </verify>
  <done>
Three slash commands exist: /declare:trace (with interactive picker when no args), /declare:visualize (with optional subtree scoping), /declare:prioritize (with optional declaration filter). All support --output flag. All follow the established meta-prompt pattern. All installed to ~/.claude/commands/declare/ for cross-project use.
  </done>
</task>

</tasks>

<verification>
1. `node dist/declare-tools.cjs visualize` -- returns tree JSON or appropriate error
2. `node dist/declare-tools.cjs visualize D-01` -- returns subtree or "node not found"
3. All three slash command files exist in `.claude/commands/declare/`
4. All three slash command files exist in `~/.claude/commands/declare/`
5. Each slash command references `dist/declare-tools.cjs` correctly
6. Full integration: `node dist/declare-tools.cjs trace`, `node dist/declare-tools.cjs visualize`, `node dist/declare-tools.cjs prioritize` all return valid JSON
</verification>

<success_criteria>
- visualize command renders full graph as top-down tree with Unicode connectors and status markers
- visualize supports subtree scoping via optional declaration/milestone ID argument
- Three slash commands follow the meta-prompt pattern (tool provides JSON, command formats for user)
- /declare:trace shows interactive picker when called without args
- /declare:visualize shows full graph by default, scoped subtree when given ID
- /declare:prioritize shows ranked actions with scores and optional declaration filter
- All commands support --output flag for file writing
- All slash commands installed to ~/.claude/commands/declare/
</success_criteria>

<output>
After completion, create `.planning/phases/03-traceability-navigation/03-02-SUMMARY.md`
</output>
