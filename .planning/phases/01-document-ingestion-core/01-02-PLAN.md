---
phase: 01-document-ingestion-core
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - get-shit-done/workflows/map-codebase.md
  - commands/gsd/map-codebase.md
autonomous: true

must_haves:
  truths:
    - "User is prompted for existing docs at start of map-codebase"
    - "User can provide file paths and see acknowledgment"
    - "User can skip ('no') and mapping continues normally"
    - "gsd-doc-ingestor agent is spawned when user provides paths"
  artifacts:
    - path: "get-shit-done/workflows/map-codebase.md"
      provides: "Updated workflow with doc prompting steps"
      contains: "prompt_for_docs"
    - path: "commands/gsd/map-codebase.md"
      provides: "Updated command reflecting new behavior"
      contains: "existing documentation"
  key_links:
    - from: "get-shit-done/workflows/map-codebase.md"
      to: "agents/gsd-doc-ingestor.md"
      via: "Task tool spawn"
      pattern: "gsd-doc-ingestor"
---

<objective>
Integrate document ingestion into the map-codebase workflow by adding prompting steps and agent spawning.

Purpose: This completes the user-facing integration - users will now be prompted for existing documentation at the start of map-codebase.

Output: Updated workflow and command files that prompt for docs, spawn the ingestor agent, and continue with normal codebase mapping.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-document-ingestion-core/01-CONTEXT.md
@.planning/phases/01-document-ingestion-core/01-RESEARCH.md

# Files to modify
@get-shit-done/workflows/map-codebase.md
@commands/gsd/map-codebase.md

# Agent created in prior plan
@agents/gsd-doc-ingestor.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update map-codebase workflow with doc prompting</name>
  <files>get-shit-done/workflows/map-codebase.md</files>
  <action>
Modify the existing workflow to add 3 new steps BEFORE the existing `check_existing` step. The new flow becomes:

```
1. prompt_for_docs (NEW)
2. collect_doc_paths (NEW)
3. spawn_doc_ingestor (NEW)
4. check_existing (existing)
5. create_structure (existing)
... rest unchanged
```

**Add step: prompt_for_docs (priority="first")**

Position: FIRST step in the workflow (move check_existing to after doc ingestion steps)

Content:
```markdown
<step name="prompt_for_docs" priority="first">
Prompt inline (freeform, NOT AskUserQuestion):

"Do you have any existing documentation I should know about?
(File paths, directories, or 'no' to skip)"

Wait for user response.

**If "no" / empty / skip:**
Brief acknowledgment: "Got it, continuing with codebase mapping..."
Set `HAS_USER_DOCS=false`
Continue to check_existing.

**If path(s) provided:**
Set `HAS_USER_DOCS=true`
Initialize `USER_DOC_PATHS` list with provided path(s)
Continue to collect_doc_paths.
</step>
```

**Add step: collect_doc_paths**

Content:
```markdown
<step name="collect_doc_paths">
Loop until done:

**Validate current path(s):**
```bash
for path in ${USER_DOC_PATHS}; do
  if [ -e "$path" ]; then
    if [ -d "$path" ]; then
      echo "DIR:$path"
    else
      echo "FILE:$path"
    fi
  else
    echo "INVALID:$path"
  fi
done
```

**For each path:**
- Valid file: Brief confirmation "Found: [filename]"
- Valid directory: "Found directory: [path] - will scan for docs"
- Invalid: Use AskUserQuestion:
  - header: "Path not found"
  - question: "Couldn't find [path]. Continue without it?"
  - options: ["Yes, continue", "Let me correct the path"]
  - If correct: Replace path and re-validate

**After all paths validated:**
Prompt inline: "Add another? (path or 'done')"

If "done" -> Continue to spawn_doc_ingestor
If path -> Add to USER_DOC_PATHS, loop again
</step>
```

**Add step: spawn_doc_ingestor**

Content:
```markdown
<step name="spawn_doc_ingestor">
Skip this step if `HAS_USER_DOCS=false`.

Spawn gsd-doc-ingestor agent.

Task tool parameters:
```
subagent_type: "gsd-doc-ingestor"
description: "Ingest user documentation"
```

Prompt:
```
Ingest user-provided documentation.

**Paths to process:**
${USER_DOC_PATHS}

**Instructions:**
1. Check for existing USER-CONTEXT.md (ask replace/merge if exists)
2. Validate each path
3. For directories: scan and identify relevant documentation
4. Categorize documents (architecture, API, general, etc.)
5. Write to .planning/codebase/USER-CONTEXT.md
6. Return confirmation with counts
```

Wait for agent completion.

Display agent's confirmation to user:
"[Agent confirmation]"

Continue to check_existing.
</step>
```

**Update check_existing step:**
- Remove `priority="first"` since prompt_for_docs is now first
- Keep existing behavior unchanged

**Update commit_codebase_map step:**
- Add USER-CONTEXT.md to the git add command if it exists:
```bash
git add .planning/codebase/*.md
```
(This already covers USER-CONTEXT.md, no change needed)

**Update offer_next step:**
- Add USER-CONTEXT.md to the completion summary if it was created:
```
Created .planning/codebase/:
- USER-CONTEXT.md ([N] lines) - User-provided documentation (if created)
- STACK.md ([N] lines) - Technologies and dependencies
...
```
  </action>
  <verify>
```bash
grep -c "prompt_for_docs\|collect_doc_paths\|spawn_doc_ingestor" get-shit-done/workflows/map-codebase.md
```
Should return 3 or more (each step name appears at least once).
  </verify>
  <done>
- Three new steps added: prompt_for_docs, collect_doc_paths, spawn_doc_ingestor
- Steps appear BEFORE check_existing in the workflow
- prompt_for_docs has priority="first"
- spawn_doc_ingestor spawns gsd-doc-ingestor agent
- check_existing no longer has priority="first"
  </done>
</task>

<task type="auto">
  <name>Task 2: Update map-codebase command file</name>
  <files>commands/gsd/map-codebase.md</files>
  <action>
Update the command file to reflect the new document ingestion capability.

**Update objective section:**
Add mention of user documentation:
```markdown
<objective>
Analyze existing codebase using parallel gsd-codebase-mapper agents to produce structured codebase documents. Optionally ingest user-provided documentation first.

Each mapper agent explores a focus area and **writes documents directly** to `.planning/codebase/`. The orchestrator only receives confirmations, keeping context usage minimal.

Output: .planning/codebase/ folder with 7 structured documents about the codebase state, plus optional USER-CONTEXT.md with user-provided documentation.
</objective>
```

**Update process section:**
Add the new steps at the beginning:
```markdown
<process>
1. Prompt for existing documentation (file paths or directories)
2. If user provides docs: spawn gsd-doc-ingestor agent to process them
3. If user skips: continue normally
4. Check if .planning/codebase/ already exists (offer to refresh or skip)
5. Create .planning/codebase/ directory structure
6. Spawn 4 parallel gsd-codebase-mapper agents:
   - Agent 1: tech focus -> writes STACK.md, INTEGRATIONS.md
   - Agent 2: arch focus -> writes ARCHITECTURE.md, STRUCTURE.md
   - Agent 3: quality focus -> writes CONVENTIONS.md, TESTING.md
   - Agent 4: concerns focus -> writes CONCERNS.md
7. Wait for agents to complete, collect confirmations (NOT document contents)
8. Verify all 7 documents exist with line counts
9. Commit codebase map
10. Offer next steps (typically: /gsd:new-project or /gsd:plan-phase)
</process>
```

**Update success_criteria section:**
Add the new criteria:
```markdown
<success_criteria>
- [ ] User prompted for existing documentation
- [ ] User docs processed (if provided) or skipped gracefully
- [ ] .planning/codebase/ directory created
- [ ] All 7 codebase documents written by mapper agents
- [ ] USER-CONTEXT.md written (if docs provided)
- [ ] Documents follow template structure
- [ ] Parallel agents completed without errors
- [ ] User knows next steps
</success_criteria>
```
  </action>
  <verify>
```bash
grep -c "existing documentation\|USER-CONTEXT\|gsd-doc-ingestor" commands/gsd/map-codebase.md
```
Should return 3 or more matches.
  </verify>
  <done>
- Objective mentions optional user documentation
- Process shows doc prompting as steps 1-3
- Success criteria includes doc prompting and USER-CONTEXT.md
  </done>
</task>

</tasks>

<verification>
1. Workflow has new steps:
```bash
grep "prompt_for_docs\|collect_doc_paths\|spawn_doc_ingestor" get-shit-done/workflows/map-codebase.md
```

2. Command file updated:
```bash
grep "existing documentation" commands/gsd/map-codebase.md
```

3. Agent spawn reference correct:
```bash
grep "gsd-doc-ingestor" get-shit-done/workflows/map-codebase.md
```
</verification>

<success_criteria>
- [ ] Workflow has 3 new steps before check_existing
- [ ] prompt_for_docs is first step with priority="first"
- [ ] spawn_doc_ingestor spawns gsd-doc-ingestor agent
- [ ] Command objective mentions user documentation
- [ ] Command process shows doc steps 1-3
- [ ] Command success_criteria includes doc-related items
</success_criteria>

<output>
After completion, create `.planning/phases/01-document-ingestion-core/01-02-SUMMARY.md`
</output>
