# Классификатор.AI — Roadmap к MVP-ready

> Статус на 17.02.2026. Ветка разработки: `claude/review-tg-bot-ved-docs-R4ZiK`

---

## Текущее состояние

| Компонент | Статус | Комментарий |
|-----------|--------|-------------|
| Структура бота (aiogram, FSM) | ✅ Есть | Работает |
| Команды `/start`, `/help`, `/cancel`, `/history`, `/check`, `/suggest` | ✅ Есть | Работают |
| Режим Expert (свободный ввод) | ⚠️ Частично | Не отличает «мало данных» от нормального ввода |
| Режим Light (опросник) | ⚠️ Частично | Есть 4 шага, но логика поверхностная |
| Интеграция с LLM (OpenAI) | ⚠️ Частично | Код есть, но использует несуществующий API-метод и модель |
| Критерии достаточности данных (Expert) | ❌ Нет | Не реализовано |
| Безопасность (токен, секреты) | ❌ Проблема | BOT_TOKEN захардкожен в коде |
| Логирование | ❌ Нет | Нет `logging`, только print в import_codes.py |
| Развёртывание (requirements.txt, .env) | ❌ Нет | Нет конфиг-файлов для запуска |
| Тесты | ❌ Нет | Нет ни одного теста |

---

## Задачи (приоритет: сверху вниз)

---

### Задача 0 — Безопасность и инфраструктура запуска
**Приоритет: критический | Блокирует всё остальное**

Без этого бот нельзя безопасно запустить даже для тестирования.

**Проблемы:**
- `BOT_TOKEN = "8338103787:AAEjqWfbQHgjOGLtl4SmFSvPEkmCciX9yyc"` — токен захардкожен в коде и попадёт в git-историю
- Нет `requirements.txt` — непонятно, что устанавливать
- Нет `.env.example` — непонятно, какие переменные нужны
- Нет инструкции по запуску

**Что сделать:**
- [ ] Удалить токен из кода, оставить только `os.getenv("BOT_TOKEN")` с `raise` если не задан
- [ ] Создать `.env.example` с нужными переменными:
  ```
  BOT_TOKEN=your_token_here
  OPENAI_API_KEY=          # опционально
  OPENAI_MODEL=gpt-4o
  DB_PATH=bot.db
  ```
- [ ] Добавить `.env` в `.gitignore`
- [ ] Создать `requirements.txt`:
  ```
  aiogram>=3.7
  openai>=1.30
  pdfplumber>=0.11
  python-dotenv>=1.0
  ```
- [ ] Добавить `logging` в основной файл бота (уровень INFO минимум)
- [ ] Добавить в `main()` загрузку `.env` через `python-dotenv`

---

### Задача 1 — Исправить интеграцию с OpenAI LLM
**Приоритет: высокий**

Нейросеть — ключевое требование ТЗ. Текущий код использует несуществующий метод `client.responses.create()` и несуществующую модель `gpt-5.2`.

**Проблемы в `bot_with_check_updated.py`:**
- `client.responses.create(...)` — нет такого метода в стандартном `openai` SDK
- `model = "gpt-5.2"` — такой модели нет, нужно `gpt-4o` или `gpt-4o-mini`
- Параметр `reasoning={"effort": "none"}` — специфика o-series моделей, не применима к gpt-4o

**Что сделать:**
- [ ] Заменить вызов на `client.chat.completions.create()`
- [ ] Изменить дефолтную модель на `gpt-4o-mini` (дешевле, быстрее, достаточно для задачи)
- [ ] Проверить парсинг JSON-ответа от модели
- [ ] Протестировать `llm_rank_candidates()` с реальным токеном

**Целевой вид вызова:**
```python
resp = client.chat.completions.create(
    model=OPENAI_MODEL,
    response_format={"type": "json_object"},
    messages=[
        {"role": "system", "content": instructions},
        {"role": "user", "content": json.dumps(user_input, ensure_ascii=False)},
    ],
)
text = resp.choices[0].message.content
```

---

### Задача 2 — Переработать режим Light в полноценный диалог-опросник
**Приоритет: высокий**

Текущий Light режим: если пользователь говорит «Да, знаю код» → проверяет код. Это дублирует `/check`. Режим Light должен **определять** код, а не просто **проверять** его.

**Текущая проблема:**
- Шаг `check_code` («Знаете код?») уводит в ветку проверки → это уже есть в `/check`
- Вопросы слишком широкие: «Это двигатель или холодильник?» — недостаточно для классификации
- Нет логики сужения: вопросы не зависят от предыдущих ответов

**Что сделать:**
- [ ] Переосмыслить структуру опросника:
  ```
  Шаг 1: Общая категория (двигатель / холодильное оборудование / другое)
  Шаг 2: Тип использования (промышленное / бытовое / транспортное)
  Шаг 3: Ключевые тех.параметры (для 8408: мощность кВт, тип топлива; для 8418: объём л, тип компрессора)
  Шаг 4: Дополнительные детали (страна происхождения, комплектность)
  Шаг 5: Итоговая классификация с обоснованием
  ```
- [ ] Убрать шаг «Знаете код?» из Light — для этого есть `/check`
- [ ] Добавить inline-кнопки (InlineKeyboardMarkup) для шагов с вариантами ответа
- [ ] Передавать накопленный профиль в `suggest_codes_flow()` для финальной классификации

---

### Задача 3 — Критерии достаточности данных в Expert режиме + переход в Light
**Приоритет: высокий | Требование из ТЗ**

Если пользователь в Expert режиме пишет «холодильник» — данных недостаточно. Бот должен предложить перейти в Light.

**Что сделать:**
- [ ] Создать функцию `assess_expert_input(text: str) -> bool`:
  ```python
  # Минимальные критерии достаточности:
  # 1. Длина текста >= 20 символов
  # 2. Есть хотя бы одно числовое значение (мощность, объём, год и т.п.)
  # 3. Есть хотя бы 3 содержательных слова (не стоп-слова)
  # 4. Нет очевидных признаков «пустого» ввода
  ```
- [ ] В `fallback()` и `classify_command()` при режиме Expert:
  - Если `assess_expert_input(text)` возвращает `False` → не классифицировать, а предложить Light с inline-кнопкой «Перейти в Light»
  - Если достаточно → классифицировать как сейчас
- [ ] Добавить inline-кнопку `CallbackQuery` для переключения в Light прямо из ответа

---

### Задача 4 — Расширить базу кодов (убрать ограничение 8408/8418 в classify)
**Приоритет: средний**

`classify_text_with_db()` сейчас работает только для кодов, начинающихся на 8408/8418. Алгоритм должен быть универсальным.

**Что сделать:**
- [ ] В `classify_text_with_db()` убрать проверку `startswith(("8408", "8418"))` — пусть ищет любой 10-значный код в БД
- [ ] В `check_code()` (обработчик `/check`) аналогично снять ограничение по префиксу
- [ ] В `import_codes.py` сделать настраиваемый список групп (сейчас жёстко: только 8408/8418)
- [ ] Обновить сообщение `/start` — убрать упоминание «8408… или 8418…»

> Для MVP можно оставить специализацию на 8408/8418 в демо-режиме, но код не должен технически ограничивать другие группы.

---

### Задача 5 — Заполнить ANALYSIS_TEXT и юридические предупреждения
**Приоритет: средний**

`ANALYSIS_TEXT` в коде усечён заглушкой `"... (сокращено) ..."`. Юридические предупреждения в ответах бота слабые.

**Что сделать:**
- [ ] Написать полный текст аналитики на основе `Анализ_правовых_рисков_и_логистических_факторов_в_классификации.docx`
- [ ] Добавить в каждый ответ с кодом: «Предупреждение: данный результат носит информационный характер и не является официальным решением таможенного органа»
- [ ] Добавить ссылку на актуальный НПА (Решение Совета ЕЭК от 14.09.2021 N 80) в `/help`

---

### Задача 6 — Тестирование и отладка
**Приоритет: средний | После задач 0–3**

- [ ] Составить таблицу тест-кейсов:
  - Light режим, полный опрос → получен код
  - Expert режим, недостаточно данных → предложение перейти в Light
  - Expert режим, достаточно данных → получен код с обоснованием
  - `/check 8408101100` → корректный ответ
  - `/suggest двигатель дизельный 250 кВт` → 3-5 кодов
  - `/cancel` в середине опроса → сброс состояния
- [ ] Протестировать все сценарии вручную
- [ ] Исправить выявленные баги

---

## Порядок выполнения

```
[0] Безопасность + инфраструктура   ← начать здесь (разблокирует запуск)
 ↓
[1] Исправить OpenAI-интеграцию     ← ключевой функционал
 ↓
[2] Переработать Light-режим        ← требование ТЗ
 ↓
[3] Expert: критерии + переход      ← требование ТЗ
 ↓
[4] Расширить base кодов            ← улучшение
 ↓
[5] Юридические тексты              ← полнота MVP
 ↓
[6] Тестирование                    ← приёмка MVP
```

---

## Критерии готовности MVP

| Критерий | Как проверить |
|----------|--------------|
| Все команды работают без ошибок | Ручное тестирование |
| Оба режима (Light/Expert) функционируют | Ручное тестирование |
| Expert → Light переход при недостатке данных | Ввести «холодильник» в Expert |
| Нейросеть подбирает коды | Отправить описание, получить 3-5 кодов с обоснованием |
| Токен не захардкожен | Проверить git history и код |
| Юридически корректные ответы | Предупреждение в каждом ответе с кодом |
| Бот работает без ручного перезапуска | Запустить через systemd/screen, подождать 10 мин |

---

## Файлы проекта

| Файл | Назначение |
|------|-----------|
| `bot_with_check_updated.py` | Основной код бота |
| `import_codes.py` | Загрузка кодов ТН ВЭД из PDF в SQLite |
| `ru.84_2022_21.09.2025.pdf` | Источник кодов (ТН ВЭД ЕАЭС, ред. 21.09.2025) |
| `Алгоритм.pdf` | Схема алгоритма работы бота |
| `ТЗ 2.0.docx` | Техническое задание |
| `Podbor_NPA.md` | Перечень применимых НПА |
| `презентация по проекту.md` | Презентация команды |
| `Анализ_правовых_рисков_и_логистических_факторов_в_классификации.docx` | Анализ рисков (источник для ANALYSIS_TEXT) |
| `ROADMAP.md` | Этот файл |
