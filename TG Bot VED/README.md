# Классификатор.AI — Telegram-бот для подбора кодов ТН ВЭД

Бот помогает участникам ВЭД, таможенным представителям и должностным лицам таможенных органов подобрать код Товарной номенклатуры внешнеэкономической деятельности (ТН ВЭД ЕАЭС).

> Нормативная база: Решение Совета ЕЭК от 14.09.2021 № 80, редакция 26.09.2025.

---

## Требования

- **Python 3.11+**
- Доступ к интернету (для Telegram API и OpenAI, если используется)
- Telegram-аккаунт для создания бота

---

## Шаг 1. Создать бота в Telegram

1. Открыть [@BotFather](https://t.me/BotFather) в Telegram
2. Отправить команду `/newbot`
3. Ввести название бота (например: `Классификатор ТН ВЭД`)
4. Ввести username бота (латиницей, оканчивается на `bot`, например: `tnved_classifier_bot`)
5. BotFather выдаст токен вида `1234567890:AABBccDDeeFFggHH...` — **сохранить его**

---

## Шаг 2. Установить зависимости

```bash
cd "TG Bot VED"
pip install -r requirements.txt
```

Устанавливаемые пакеты:
- `aiogram` — фреймворк для Telegram-ботов
- `openai` — интеграция с LLM (опционально)
- `pdfplumber` — извлечение кодов из PDF
- `python-dotenv` — загрузка переменных из `.env`

---

## Шаг 3. Настроить переменные окружения

Скопировать шаблон и заполнить своими данными:

```bash
cp .env.example .env
```

Открыть `.env` в редакторе и заполнить:

```ini
# Обязательно:
BOT_TOKEN=1234567890:AABBccDDeeFFggHH...   # токен от BotFather

# Оставить как есть (или поменять путь):
DB_PATH=bot.db
PDF_PATH=ru.84_2022_21.09.2025.pdf

# Фильтр групп при импорте PDF (пусто = все группы):
# Для MVP-демо на двигателях и холодильниках:
# TARGET_GROUPS=8408,8418
TARGET_GROUPS=

# Опционально — для ранжирования кодов через нейросеть:
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-5.2
```

> Без `OPENAI_API_KEY` бот работает только на поиске по ключевым словам из БД. Функционал ограничен, но базовый сценарий доступен.

---

## Шаг 4. Загрузить коды ТН ВЭД в базу данных

Это нужно сделать **один раз** перед первым запуском (и повторить при обновлении PDF).

```bash
python import_codes.py
```

Скрипт читает файл `ru.84_2022_21.09.2025.pdf` и загружает коды в `bot.db`.

**Пример вывода:**
```
PDF: ru.84_2022_21.09.2025.pdf
БД:  bot.db
Фильтр групп: все группы
Найдено кодов: 847
Загружено в БД: 847
1. 8408101100 — ...
2. 8408101900 — ...
...
```

Если нужна специализация только на группах 8408 и 8418 (для MVP-демо):

```bash
# В .env установить:
TARGET_GROUPS=8408,8418
# Затем:
python import_codes.py
```

---

## Шаг 5. Запустить бота

```bash
python bot_with_check_updated.py
```

Ожидаемый вывод в консоли:
```
2026-02-17 12:00:00 [INFO] __main__: БД инициализирована: bot.db
2026-02-17 12:00:00 [INFO] __main__: OpenAI: включён, модель=gpt-5.2
2026-02-17 12:00:00 [INFO] __main__: Бот запущен, ожидаю сообщения...
```

Открыть бота в Telegram и отправить `/start`.

---

## Работа с ботом

### Команды

| Команда | Описание |
|---------|----------|
| `/start` | Приветствие, выбор режима (Light / Expert) |
| `/mode` | Переключить режим |
| `/classify` | Начать классификацию в текущем режиме |
| `/check <код>` | Проверить 10-значный код ТН ВЭД |
| `/suggest <описание>` | Подобрать 3–5 кодов по тексту |
| `/analysis` | Анализ правовых рисков и применимые НПА |
| `/history` | История запросов |
| `/cancel` | Завершить текущий диалог |

### Режим Light (рекомендуется для новых пользователей)

Пошаговый опросник из 3 шагов с кнопками:

1. **Группа товара** — выбор из кнопок: двигатель / холодильное оборудование / другое
2. **Сфера применения** — кнопки адаптируются к выбранной группе
3. **Технические параметры** — свободный текст (мощность, объём, тип и т.п.)

После 3-го шага бот выдаёт 3–5 кандидатов с обоснованием.

### Режим Expert (для опытных пользователей)

Свободный ввод описания товара. Требования к описанию:
- Не менее 20 символов
- Не менее 3 значимых слов
- Должно содержать числовое значение **или** техническое ключевое слово

Если описание недостаточно — бот предложит перейти в Light или дополнить текст.

**Пример достаточного описания:**
```
Компрессорный холодильник промышленный, объём камеры 500 л, температура -18°C
```

---

## Непрерывная работа (опционально)

Чтобы бот работал после закрытия терминала, используйте `screen` или `nohup`:

**Вариант 1 — screen:**
```bash
screen -S tnved-bot
python bot_with_check_updated.py
# Ctrl+A, затем D — отключиться от сессии
# screen -r tnved-bot — вернуться
```

**Вариант 2 — nohup:**
```bash
nohup python bot_with_check_updated.py > bot.log 2>&1 &
tail -f bot.log   # смотреть логи
```

---

## Устранение проблем

**Бот не запускается: `BOT_TOKEN не задан`**
→ Проверить, что файл `.env` существует и содержит `BOT_TOKEN=...`

**`FileNotFoundError: PDF не найден`** (при `import_codes.py`)
→ Проверить, что файл `ru.84_2022_21.09.2025.pdf` находится в той же папке, или указать путь в `.env`: `PDF_PATH=/полный/путь/к/файлу.pdf`

**`В таблице tnved нет кодов`** (ответ бота)
→ Запустить `python import_codes.py` для загрузки кодов

**OpenAI ошибка в логах**
→ Проверить валидность `OPENAI_API_KEY` и доступность API. Бот продолжит работу на поиске по ключевым словам.

**Бот не отвечает на сообщения**
→ Убедиться, что процесс запущен (`ps aux | grep bot`). Проверить лог на ошибки.

---

## Структура файлов

```
TG Bot VED/
├── bot_with_check_updated.py   # основной код бота
├── import_codes.py             # загрузка кодов из PDF в БД
├── ru.84_2022_21.09.2025.pdf   # ТН ВЭД ЕАЭС (источник кодов)
├── requirements.txt            # зависимости Python
├── .env.example                # шаблон переменных окружения
├── .env                        # ваши секреты (не в git)
├── bot.db                      # SQLite база данных (создаётся автоматически)
├── TEST_CASES.md               # таблица тест-кейсов для приёмки
├── CHANGES.md                  # что изменено и почему
├── ORIGINAL_STATE.md           # исходное состояние до доработки
├── Алгоритм.pdf                # блок-схема алгоритма бота
├── ТЗ 2.0.docx                 # техническое задание
├── Podbor_NPA.md               # применимые нормативные документы
└── Анализ_правовых_рисков...   # анализ правовых рисков (docx)
```

---

## Важно

Результаты классификации носят **информационный характер** и не являются официальным решением таможенного органа. Для получения обязательного предварительного решения о классификации товара обращайтесь в ФТС России (Приказ Минфина от 01.09.2020 № 181н).
