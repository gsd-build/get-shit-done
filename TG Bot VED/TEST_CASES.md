# TEST_CASES — Классификатор.AI (TG Bot VED)

> Таблица для ручного тестирования перед приёмкой MVP.
> Тестировать на реальном боте после запуска (`python bot_with_check_updated.py`).

---

## Подготовка к тестированию

1. Скопировать `.env.example` → `.env`, вставить реальный `BOT_TOKEN`
2. Запустить `import_codes.py` для загрузки кодов в БД (нужен PDF)
3. Запустить бота: `python bot_with_check_updated.py`
4. Открыть Telegram, найти бота по имени

---

## Тест-кейсы

### Блок 1 — Базовые команды

| # | Команда / действие | Ожидаемый результат | Статус |
|---|--------------------|---------------------|--------|
| 1.1 | `/start` | Приветствие, кнопки Light / Expert, список команд, ссылка на НПА | ☐ |
| 1.2 | `/help` | То же сообщение, что и /start | ☐ |
| 1.3 | `/cancel` без активного диалога | «Диалог завершён. Данные сброшены.» | ☐ |
| 1.4 | `/history` без истории | «История пуста.» | ☐ |
| 1.5 | `/analysis` | 5 разделов текста, нет заглушки «сокращено» | ☐ |
| 1.6 | Произвольный текст без выбора режима | «Не удалось распознать команду. Используйте /help.» | ☐ |

---

### Блок 2 — Режим Light, полный сценарий

| # | Шаг | Ожидаемый результат | Статус |
|---|-----|---------------------|--------|
| 2.1 | `/start` → нажать «Light» | «Шаг 1 из 3 — Группа товара» + 3 inline-кнопки | ☐ |
| 2.2 | Нажать «Двигатель внутреннего сгорания (гр. 8408)» | «Шаг 2 из 3 — Сфера применения» + 5 кнопок для 8408 | ☐ |
| 2.3 | Нажать «Промышленное оборудование» | «Шаг 3 из 3 — Технические параметры» с подсказками | ☐ |
| 2.4 | Написать «Дизельный, 4-цилиндровый, 150 кВт, водяное охлаждение» | «Анализирую…» → список 3–5 кодов с обоснованием + дисклеймер ⚠️ | ☐ |
| 2.5 | Повторить 2.1–2.3, на шаге 3 отправить фото | «Пожалуйста, введите текстовое описание параметров.» (без краша) | ☐ |
| 2.6 | `/cancel` в середине шага 2 | «Диалог завершён.», повторный /start работает с чистого листа | ☐ |
| 2.7 | Повторить 2.1, выбрать «Холодильное / морозильное оборудование (гр. 8418)» | Шаг 2 показывает кнопки для 8418 (не для 8408) | ☐ |
| 2.8 | Повторить 2.1, выбрать «Другой товар / не знаю» | Шаг 2 показывает универсальные кнопки (Промышленное/Бытовое/Другое) | ☐ |

---

### Блок 3 — Режим Expert

| # | Ввод | Ожидаемый результат | Статус |
|---|------|---------------------|--------|
| 3.1 | `/start` → «Expert» → написать «холодильник» | «Описания недостаточно…» + кнопки «Перейти в Light» / «Дополнить» | ☐ |
| 3.2 | Ситуация 3.1 → нажать «Дополнить описание» | Подсказка с перечнем нужных параметров | ☐ |
| 3.3 | Ситуация 3.1 → нажать «Перейти в Light-режим» | Шаг 1 из 3 с кнопками категорий | ☐ |
| 3.4 | Expert: «двигатель» (8 символов) | «Описания недостаточно…» (< 20 символов) | ☐ |
| 3.5 | Expert: «двигатель для машины хорошая вещь нужна» (нет числа и тех.слова) | «Описания недостаточно…» (нет техн. конкретики) | ☐ |
| 3.6 | Expert: «Компрессорный холодильник бытовой, объём 300 л, температура –18°C» | Список 3–5 кодов + дисклеймер ⚠️ | ☐ |
| 3.7 | Expert: «Дизельный двигатель морской 250 кВт, 6 цилиндров, турбонаддув» | Список 3–5 кодов + дисклеймер ⚠️ | ☐ |
| 3.8 | Expert: «описание 9161234567 другой текст» | НЕ должен распознать 9161234567 как код (группа 91 — это часы, 1≤91≤97 — пройдёт проверку, но кода в БД нет, вернёт confidence 0.35) | ☐ |

> **Примечание к 3.8:** `9161234567` пройдёт проверку диапазона (91 ≤ 97) — это группа «Часы и хронометры». Если код не найден в БД, бот вернёт «Код найден в тексте, но отсутствует в БД (0.35)» — это корректное поведение. Номера телефонов вида `89XXXXXXXXX` (11 цифр) не попадут в regex.

---

### Блок 4 — Команда /check

| # | Ввод | Ожидаемый результат | Статус |
|---|------|---------------------|--------|
| 4.1 | `/check` (без аргумента) | «Укажите код после команды, например, /check 8408101100» | ☐ |
| 4.2 | `/check 12345` | «Код должен содержать ровно 10 цифр.» | ☐ |
| 4.3 | `/check 84081011ab` | «Код должен содержать ровно 10 цифр.» | ☐ |
| 4.4 | `/check 8408101100` (код есть в БД) | Наименование + вероятность 92% + дисклеймер ⚠️ | ☐ |
| 4.5 | `/check 9999999999` (кода нет в БД) | «Код не найден в вашей БД» + вероятность 35% + дисклеймер ⚠️ | ☐ |
| 4.6 | `/check 0101010101` (группа 01 — живые животные) | Ответ о статусе кода (тест универсальности после задачи 4) | ☐ |

---

### Блок 5 — Команда /suggest

| # | Ввод | Ожидаемый результат | Статус |
|---|------|---------------------|--------|
| 5.1 | `/suggest` (без аргумента) | «Напишите: /suggest <описание товара>.» | ☐ |
| 5.2 | `/suggest двигатель дизельный 250 кВт` | 3–5 кодов с обоснованием + дисклеймер ⚠️ | ☐ |
| 5.3 | `/suggest холодильник бытовой 250 литров` | 3–5 кодов с обоснованием + дисклеймер ⚠️ | ☐ |

---

### Блок 6 — Команда /classify

| # | Ввод | Ожидаемый результат | Статус |
|---|------|---------------------|--------|
| 6.1 | `/classify` без выбора режима | Предложение Expert с подсказкой | ☐ |
| 6.2 | `/classify двигатель` (< 20 символов) | «Описания недостаточно…» + кнопки | ☐ |
| 6.3 | `/classify дизельный двигатель 100 кВт промышленный` | Список кодов или suggest_codes_flow + дисклеймер ⚠️ | ☐ |

---

### Блок 7 — История запросов

| # | Действие | Ожидаемый результат | Статус |
|---|----------|---------------------|--------|
| 7.1 | Сделать несколько запросов, затем `/history` | Последние 10 запросов с датой, режимом, описанием | ☐ |
| 7.2 | `/history` сразу после `/start` | «История пуста.» (новый пользователь) | ☐ |

---

### Блок 8 — Переключение режимов

| # | Действие | Ожидаемый результат | Статус |
|---|----------|---------------------|--------|
| 8.1 | `/mode` | «Выберите режим: Light или Expert.» + кнопки | ☐ |
| 8.2 | Выбрать Light, затем `/mode` → Expert → написать корректное описание | Бот работает в Expert (не в Light) | ☐ |
| 8.3 | Начать Light-опросник → `/mode` → Expert | Опросник сброшен, Expert активен | ☐ |

---

## Известные ограничения (не баги)

| Ограничение | Описание |
|-------------|---------|
| Режимы сбрасываются при перезапуске | `user_modes` хранится в памяти. При перезапуске бота пользователь снова в режиме «без режима». |
| БД должна быть загружена | Без запуска `import_codes.py` таблица `tnved` пуста → `suggest_codes_flow` вернёт «нет кодов». |
| OpenAI опционален | Без `OPENAI_API_KEY` ранжирование идёт только по ключевым словам, качество ниже. |
| 10-значные числа в тексте | Любое число вида `NNNNNNNNNN` (01–97 первые 2 цифры) в описании будет проверено как возможный код ТН ВЭД. Если не найдено в БД — вернёт confidence 0.35. |

---

## Критерии приёмки MVP

| Критерий | Тест-кейсы | Выполнено |
|----------|-----------|-----------|
| Все команды работают без ошибок | 1.1–1.6, 4.1–4.6, 5.1–5.3, 6.1–6.3, 7.1–7.2, 8.1–8.3 | ☐ |
| Light-режим — полный опросник с кнопками | 2.1–2.8 | ☐ |
| Expert: переход в Light при недостатке данных | 3.1–3.5 | ☐ |
| Expert: классификация при достаточных данных | 3.6–3.7 | ☐ |
| Юридический дисклеймер в каждом ответе с кодом | 2.4, 3.6, 4.4, 5.2, 6.3 | ☐ |
| Бот не падает при отправке фото/вложения | 2.5 | ☐ |
| Токен не захардкожен | `grep "8338103787" bot_with_check_updated.py` → пусто | ☐ |
