# Что изменилось в проекте

> Документ для внешнего пользователя: что было сделано с кодом и почему.
> Работы выполнены в феврале 2026 года на основе переданной документации и кода.

---

## Общая картина (helicopter view)

Бот получен в состоянии «работающего скелета»: структура правильная, но ключевой функционал был либо сломан, либо отсутствовал. Выполнено **7 задач**:

| # | Задача | Суть |
|---|--------|------|
| 0 | Безопасность и инфраструктура | Убран токен из кода, добавлены файлы для нормального запуска |
| 1 | Починить OpenAI-интеграцию | Исправлен нерабочий вызов API |
| 2 | Переработать Light-режим | Из дубля `/check` — в полноценный диалог с кнопками |
| 3 | Expert: критерии достаточности | Добавлена логика «мало данных → предложить Light» |
| 4 | Снять ограничение 8408/8418 | Бот теперь работает с любым кодом ТН ВЭД |
| 5 | Юридические тексты | Дисклеймер в каждом ответе, полный `/analysis` |
| 6 | Тестирование и code review | 5 багов исправлено, создана таблица тест-кейсов |

**Новые файлы в проекте:**

| Файл | Назначение |
|------|-----------|
| `.env.example` | Шаблон переменных окружения |
| `requirements.txt` | Список зависимостей Python |
| `ROADMAP.md` | План задач (архив решений) |
| `ORIGINAL_STATE.md` | Описание исходного состояния |
| `CHANGES.md` | Этот файл |
| `TEST_CASES.md` | Таблица для ручной приёмки |

---

## Детальное описание изменений

---

### Задача 0 — Безопасность и инфраструктура

**Проблема:** Telegram-токен бота был захардкожен прямо в исходном коде и попадал в git-историю. Запустить бот безопасно было невозможно. Зависимости нигде не описаны.

**Что сделано:**

- Токен удалён из кода. Теперь бот берёт его только из переменной окружения `BOT_TOKEN`. При отсутствии — выбрасывает понятную ошибку с инструкцией.
- Создан `.env.example` — шаблон со всеми переменными и комментариями.
- В `.gitignore` добавлены `.env` и `bot.db` — секреты и локальная БД не попадут в репозиторий.
- Создан `requirements.txt` с точными зависимостями.
- Добавлено логирование (`logging.basicConfig`) — теперь при запуске видно, что происходит.
- Добавлена загрузка `.env` через `python-dotenv` в начале файла.
- Исправлена дефолтная модель: `gpt-5.2` сохранена (выбор разработчика).

---

### Задача 1 — Исправить интеграцию с OpenAI

**Проблема:** При наличии `OPENAI_API_KEY` бот падал. Код вызывал `client.responses.create()` с параметром `reasoning={"effort": "none"}`, который не поддерживается моделью gpt-5.2. Ошибки импорта OpenAI перехватывались слишком широким `except Exception`.

**Что сделано:**

- Удалён параметр `reasoning` — он предназначен только для o-series моделей (o1, o3).
- `except Exception` при импорте → `except ImportError` (точный тип).
- Весь API-вызов обёрнут в `try/except`: при сетевой ошибке или ошибке API бот возвращает результат по ключевым словам из БД, а ошибка пишется в лог.
- `client.responses.create()` и `output_text` сохранены — это корректный Responses API OpenAI.

---

### Задача 2 — Переработать режим Light

**Проблема:** Light-режим имел 6 FSM-состояний, первое из которых спрашивало «Знаете код?». При ответе «Да» бот просто проверял код — это дублировало команду `/check`. Реального опросника для **подбора** кода не было.

**Что сделано:**

Режим полностью переписан. Теперь 3 шага с inline-кнопками:

```
Шаг 1 — Группа товара
  [Двигатель внутреннего сгорания (гр. 8408)]
  [Холодильное / морозильное оборудование (гр. 8418)]
  [Другой товар / не знаю]
        ↓
Шаг 2 — Сфера применения  (кнопки меняются в зависимости от шага 1)
  Для 8408: Промышленное / Морское / Транспорт / Сельхозтехника / Другое
  Для 8418: Бытовой / Промышленный / Транспортный / Другое
        ↓
Шаг 3 — Технические параметры (свободный текст с подсказками)
  Пример подсказки: мощность кВт/л.с., тип топлива, рабочий объём
        ↓
Результат: 3–5 кодов ТН ВЭД с обоснованием
```

Добавлена единая точка входа `light_start()` — вызывается и при выборе режима, и из команды `/classify`.

---

### Задача 3 — Критерии достаточности в Expert-режиме

**Проблема:** Expert-режим принимал любой текст — в том числе «холодильник» — и пытался классифицировать его. Требование ТЗ о переходе в Light при недостатке данных не было реализовано.

**Что сделано:**

Добавлена функция `assess_expert_input(text)` с тремя критериями:

| Критерий | Пример провала |
|----------|----------------|
| Длина ≥ 20 символов | «холодильник» |
| ≥ 3 содержательных слова (без стоп-слов) | «хороший двигатель» |
| Есть число ИЛИ техническое ключевое слово | текст без параметров |

Словарь технических слов (`_TECH_KEYWORDS`) включает 35+ терминов: «квт», «компрессор», «дизель», «литр», «промышленн» и др.

При недостаточном описании бот показывает:
```
Описания недостаточно для классификации.
Для точного подбора кода ТН ВЭД нужны технические детали...

[Перейти в Light-режим (опросник)]
[Дополнить описание и попробовать снова]
```

---

### Задача 4 — Снять ограничение 8408/8418

**Проблема:** Классификатор, команда `/check` и скрипт `import_codes.py` работали **только** с двумя группами товаров (8408 — двигатели, 8418 — холодильники). Любой другой код отклонялся.

**Что сделано в `bot_with_check_updated.py`:**

- `CODE10_RE`: регулярное выражение расширено с `84(08|18)\d{6}` до любого 10-значного числа.
- `classify_text_with_db()`: убрана проверка `.startswith(("8408", "8418"))`.
- Команда `/check`: принимает любой 10-значный код ТН ВЭД.
- Все упоминания «8408… или 8418…» в подсказках пользователю заменены на «10-значный код ТН ВЭД».

**Что сделано в `import_codes.py`:**

- `PDF_PATH` теперь берётся из переменной окружения (убран путь к машине разработчика).
- Добавлена переменная `TARGET_GROUPS` — фильтр по группам при импорте. Пустая строка = импортировать все группы из PDF. Пример: `TARGET_GROUPS=8408,8418`.
- Регулярные выражения стали универсальными.

> Кнопки в Light-режиме (8408/8418) сохранены — это UX-навигация для MVP, не техническое ограничение.

---

### Задача 5 — Юридические тексты

**Проблема:** `ANALYSIS_TEXT` содержал заглушку `"... (сокращено) ..."`. В ответах бота не было юридического предупреждения, хотя это требование ТЗ и необходимость при работе с таможенной тематикой.

**Что сделано:**

Добавлена константа `LEGAL_DISCLAIMER`:
```
⚠️ Внимание: результат носит информационный характер и не является
официальным решением таможенного органа о классификации товара.
Для получения обязательного предварительного решения обратитесь в ФТС России
(Приказ Минфина от 01.09.2020 № 181н).
```

Дисклеймер добавлен в `format_results()` и `suggest_codes_flow()` — отображается в каждом ответе с кодом или списком кодов.

`ANALYSIS_TEXT` переписан полностью — 5 разделов на основе НПА из `Podbor_NPA.md`:
1. Правовые риски неверной классификации (КоАП ст.16.2, УК ст.194)
2. Экспортные ограничения с 2022 года (Указ Президента №100, ПП 311/312/313)
3. Ставки ввозных таможенных пошлин (ЕТТ ЕАЭС, ПП 2240)
4. Процедура предварительного решения (Минфин 181н, ТК ЕАЭС ст.21–27)
5. Правила интерпретации ТН ВЭД (КТС 522, ЕЭК 21, ФТС 995/635)

В `/help` добавлена ссылка на основной НПА: Решение Совета ЕЭК от 14.09.2021 № 80.

---

### Задача 6 — Code review и тест-кейсы

**Проблема:** Потенциальные баги не были задокументированы; ручная приёмка невозможна без структурированной таблицы.

**Баги, исправленные по результатам code review:**

| Баг | Исправление |
|-----|-------------|
| `datetime.utcnow()` — устарело с Python 3.12 | → `datetime.now(timezone.utc)` |
| `\d{10}` ловил номера телефонов | → Добавлена проверка: первые 2 цифры кода 01–97 (диапазон групп ТН ВЭД) |
| `message.text` = `None` при отправке фото | → Guard в обработчике шага 3 Light-режима |
| `except Exception` на JSON-парсинге | → `except json.JSONDecodeError` |
| Неиспользуемый импорт `Any` | → Удалён |

Создан файл `TEST_CASES.md` — 38 тест-кейсов в 8 блоках для ручной приёмки с чекбоксами.

---

## Что НЕ менялось (намеренно)

| Элемент | Причина |
|---------|---------|
| `client.responses.create()` | Это корректный Responses API OpenAI, выбор разработчика |
| Модель `gpt-5.2` | Выбор разработчика, подтверждён в процессе работы |
| Кнопки Light для групп 8408/8418 | Специализация MVP, не техническое ограничение |
| Архитектура SQLite | Достаточна для MVP, менять преждевременно |
| Алгоритм поиска по ключевым словам | Работает как fallback при отсутствии OpenAI |
